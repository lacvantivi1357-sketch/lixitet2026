<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>L√¨ X√¨ 29.0 - Crystal Vision Edition</title>
    <style>
        /* --- DESIGN SYSTEM: HCMUTE IT STANDARD --- */
        :root { 
            --primary-red: #d32f2f; 
            --gold-yellow: #fbc02d; 
            --fever-cyan: #00e5ff; 
            --ice-blue: #bbdefb; 
            --ui-bg: #ffffff;
            --font-stack: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            margin: 0; padding: 0; overflow: hidden; 
            font-family: var(--font-stack); background: #121212; 
            touch-action: none; user-select: none; transition: background 0.3s; 
        }

        /* --- VISUAL FX (SHARP & CLEAR ONLY) --- */
        #iceOverlay { 
            position: fixed; inset: 0; pointer-events: none; z-index: 100; 
            border: 20px solid rgba(187, 222, 251, 0.4); opacity: 0; transition: 0.4s; 
            box-shadow: inset 0 0 80px rgba(187, 222, 251, 0.2); 
        }

        /* Hi·ªáu ·ª©ng tr·∫°ng th√°i Fever (Glow nh·∫π, kh√¥ng m·ªù) */
        .fx-fever-active { box-shadow: inset 0 0 100px rgba(0, 229, 255, 0.25); }

        /* Hi·ªáu ·ª©ng gi·ªè say r∆∞·ª£u (Drunk) - T·∫°o ƒë·ªô kh√≥ v·∫≠t l√Ω thay v√¨ th·ªã gi√°c */
        .fx-drunk-basket { animation: sharpShake 0.2s infinite; }
        @keyframes sharpShake { 
            0% { transform: translateX(0); } 
            25% { transform: translateX(10px); } 
            75% { transform: translateX(-10px); } 
            100% { transform: translateX(0); } 
        }

        /* --- SCREEN ARCHITECTURE --- */
        .screen { 
            position: absolute; inset: 0; display: none; flex-direction: column; 
            align-items: center; justify-content: center; text-align: center; color: white; 
        }

        #menuScreen { 
            display: flex; 
            background: radial-gradient(circle at center, #ff5252 0%, #b71c1c 100%); 
            z-index: 10; 
        }

        #gameScreen { background: var(--ui-bg); cursor: none; overflow: hidden; }

        /* --- HUD & STATUS CONTROLS --- */
        .hud-layer { 
            position: absolute; top: 0; width: 100%; height: 120px;
            display: flex; flex-direction: column; align-items: center; z-index: 50; 
            pointer-events: none;
        }

        .hud-main {
            width: 100%; display: flex; justify-content: space-around; 
            padding: 20px 0; font-size: 2.2rem; font-weight: 900; 
            color: var(--primary-red); text-shadow: 2px 2px 0 #fff;
        }

        .status-icons-tray { 
            display: flex; gap: 12px; font-size: 1.8rem; 
            background: rgba(255,255,255,0.9); padding: 10px 30px; 
            border-radius: 50px; box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        /* --- ENERGY BAR SYSTEM --- */
        .energy-rail { 
            position: absolute; bottom: 35px; left: 10%; width: 80%; height: 20px; 
            background: rgba(0,0,0,0.1); border-radius: 30px; border: 3px solid var(--primary-red); 
            overflow: hidden; z-index: 50; 
        }

        .energy-core { 
            width: 0%; height: 100%; background: linear-gradient(90deg, var(--fever-cyan), #fff); 
            transition: width 0.3s cubic-bezier(0.1, 0.7, 0.1, 1); 
        }

        /* --- GACHA CARD INTERFACE --- */
        .card-grid { 
            display: grid; grid-template-columns: repeat(3, 1fr); 
            gap: 20px; padding: 25px; 
        }

        .gacha-box { perspective: 1000px; width: 100px; height: 145px; cursor: pointer; }
        .gacha-box-inner { position: relative; width: 100%; height: 100%; transition: 0.8s; transform-style: preserve-3d; }
        .gacha-face { 
            position: absolute; inset: 0; backface-visibility: hidden; border-radius: 15px; 
            display: flex; align-items: center; justify-content: center; border: 4px solid var(--gold-yellow); 
        }
        .gacha-front { background: var(--primary-red); font-size: 3.5rem; box-shadow: 0 8px 20px rgba(0,0,0,0.4); }
        .gacha-back { background: white; color: var(--primary-red); font-weight: 900; transform: rotateY(180deg); font-size: 1.4rem; }
        .is-flipped .gacha-box-inner { transform: rotateY(180deg); }

        /* --- BUTTONS & INPUTS --- */
        .btn-action { 
            background: var(--gold-yellow); color: #7f0000; border: none; padding: 20px 60px; 
            border-radius: 100px; font-weight: 900; cursor: pointer; 
            box-shadow: 0 8px 0 #b79500; margin-top: 20px; font-size: 1.4rem; 
            transition: 0.2s;
        }
        .btn-action:active { transform: translateY(6px); box-shadow: none; }
        
        .admin-secret-btn { position: fixed; top: 15px; right: 15px; opacity: 0.02; cursor: pointer; z-index: 1000; font-size: 30px; }

        /* --- ADMIN MODALS --- */
        .modal-container { 
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); 
            z-index: 2000; align-items: center; justify-content: center; 
        }

        .modal-content { 
            background: white; padding: 40px; border-radius: 30px; width: 95%; 
            max-width: 550px; color: #333; max-height: 90vh; overflow-y: auto; 
        }

        .admin-input-field { width: 100%; padding: 15px; margin-bottom: 15px; border-radius: 12px; border: 2px solid #ddd; font-size: 1.1rem; }
        .admin-text-area { width: 100%; padding: 15px; margin: 15px 0; border-radius: 15px; border: 2px solid #eee; font-family: 'Courier New', monospace; font-size: 1rem; }
        
        .dashboard-row { display: flex; justify-content: space-between; padding: 15px; background: #f8f9fa; border-radius: 15px; margin-bottom: 12px; border-left: 6px solid var(--gold-yellow); }
    </style>
</head>
<body>
    <div id="iceOverlay"></div>
    
    <div id="menuScreen" class="screen">
        <div class="admin-secret-btn" onclick="UIBridge.toggleModal('loginModal', true)">‚öôÔ∏è</div>
        <div style="font-size: 8rem; filter: drop-shadow(0 0 30px var(--gold-yellow));">üèÆ</div>
        <h1 style="margin:0; font-size: 4.5rem; text-shadow: 4px 4px 0 #7f0000;">L√å X√å 29.0</h1>
        <p style="font-size: 1.4rem; font-weight: 300; letter-spacing: 2px;">CRYSTAL VISION ‚Ä¢ HCMUTE IT</p>
        <button class="btn-action" onclick="AppCore.boot()">KH·ªûI ƒê·ªòNG</button>
    </div>

    <div id="gameScreen" class="screen">
        <div class="hud-layer">
            <div class="hud-main">
                <span>‚åõ <span id="timeVal">60</span>s</span>
                <span>üí∞ <span id="scoreVal">0</span></span>
            </div>
            <div class="status-icons-tray" id="statusIcons"></div>
        </div>
        <canvas id="gameCanvas"></canvas>
        <div class="energy-rail"><div class="energy-core" id="energyFill"></div></div>
    </div>

    <div id="pickScreen" class="screen">
        <h2 style="color:var(--gold-yellow); font-size: 2.8rem; margin: 0;">V·∫¨N M·ªÜNH C·ª¶A B√â</h2>
        <p style="margin-bottom: 25px; font-size: 1.3rem; color: #fff;">Luck Cap 30% b·∫£o v·ªá ng√¢n s√°ch: +<span id="luckBonus">0</span>%</p>
        <div class="card-grid" id="cardGrid"></div>
    </div>

    <div id="revealScreen" class="screen">
        <div style="background:white; color:var(--primary-red); padding:60px; border-radius:50px; border:10px solid var(--gold-yellow); width:400px; box-shadow: 0 0 100px rgba(0,0,0,0.5);">
            <h2 style="margin:0; font-size: 2.2rem;">CH√öC M·ª™NG!</h2>
            <div style="font-size: 7rem; margin: 25px 0;">üßß</div>
            <div id="prizeAmount" style="font-size: 4rem; font-weight: 900;">0ƒë</div>
            <button class="btn-action" onclick="location.reload()">L∆ØU K·∫æT QU·∫¢</button>
        </div>
    </div>

    <div id="loginModal" class="modal-container">
        <div class="modal-content" style="max-width: 420px;">
            <h3 style="text-align:center; margin-bottom: 30px;">üîê X√ÅC TH·ª∞C QUY·ªÄN H·∫†N</h3>
            <input type="text" id="admU" class="admin-input-field" placeholder="User">
            <input type="password" id="admP" class="admin-input-field" placeholder="Password">
            <button class="btn-action" style="width:100%" onclick="AdminLogic.verify()">TRUY C·∫¨P</button>
            <button class="btn-action" style="width:100%; background:#eee; box-shadow:none; color:#666;" onclick="UIBridge.toggleModal('loginModal', false)">QUAY L·∫†I</button>
        </div>
    </div>

    <div id="adminPanel" class="modal-container">
        <div class="modal-content">
            <h3 style="margin-top:0; border-bottom: 4px solid var(--gold-yellow); padding-bottom: 15px;">üìä QU·∫¢N TR·ªä KINH T·∫æ</h3>
            
            <div id="statsBox"></div>

            <label><b>C·∫•u h√¨nh Tr·ªçng s·ªë 10 m·ªánh gi√° (Ti·ªÅn : T·ªâ l·ªá):</b></label>
            <textarea id="cfgData" class="admin-text-area" rows="11"></textarea>
            
            <div style="margin-top: 20px;">
                <button class="btn-action" style="width:100%" onclick="AdminLogic.applyChanges()">L∆ØU C·∫§U H√åNH</button>
                <button class="btn-action" style="width:100%; background:#f44336; color:white; font-size: 1.1rem;" onclick="AdminLogic.purgeData()">X√ìA L·ªäCH S·ª¨</button>
                <button class="btn-action" style="width:100%; background:#999; color:white;" onclick="UIBridge.toggleModal('adminPanel', false)">THO√ÅT</button>
            </div>
        </div>
    </div>

<script>
/* ==========================================================================
   MODULE 1: DATA PERSISTENCE (L∆ØU TR·ªÆ & C√ÇN B·∫∞NG)
   ========================================================================== */
const Database = {
    keys: { cfg: 'lx29_cfg_data', hist: 'lx29_hist_data' },
    
    // 10 M·ªÜNH GI√Å C√ÇN B·∫∞NG T·ªêI ∆ØU: √âp gi·∫£i l·ªõn c·ª±c hi·∫øm ƒë·ªÉ b·∫£o v·ªá v√≠ ti·ªÅn
    defaultSetup: [
        {a: 10000, w: 250}, {a: 20000, w: 160}, {a: 30000, w: 100}, {a: 40000, w: 60},
        {a: 50000, w: 30}, {a: 60000, w: 15}, {a: 70000, w: 8}, {a: 80000, w: 4},
        {a: 90000, w: 2}, {a: 100000, w: 1}
    ],

    boot() {
        if (!localStorage.getItem(this.keys.cfg)) {
            localStorage.setItem(this.keys.cfg, JSON.stringify(this.defaultSetup));
        }
    },

    loadConfig() { return JSON.parse(localStorage.getItem(this.keys.cfg)); },
    saveConfig(d) { localStorage.setItem(this.keys.cfg, JSON.stringify(d)); },
    
    fetchHistory() { return JSON.parse(localStorage.getItem(this.keys.hist)) || []; },
    writeRecord(val) {
        let h = this.fetchHistory();
        h.push({ t: new Date().toLocaleString(), v: val });
        if (h.length > 500) h.shift();
        localStorage.setItem(this.keys.hist, JSON.stringify(h));
    }
};

/* ==========================================================================
   MODULE 2: AUDIO SYNTHESIZER (√ÇM THANH K·ª∏ THU·∫¨T S·ªê)
   ========================================================================== */
const AudioEngine = {
    ctx: null,
    
    ignite() {
        if (this.ctx) return;
        this.ctx = new (window.AudioContext || window.webkitAudioContext)();
    },

    chirp(freq, type = 'sine', d = 0.1, vol = 0.05) {
        if (!this.ctx) return;
        if (this.ctx.state === 'suspended') this.ctx.resume();
        const o = this.ctx.createOscillator(), g = this.ctx.createGain();
        o.type = type; o.frequency.setValueAtTime(freq, this.ctx.currentTime);
        g.gain.setValueAtTime(vol, this.ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + d);
        o.connect(g); g.connect(this.ctx.destination);
        o.start(); o.stop(this.ctx.currentTime + d);
    },

    onCatch() { this.chirp(1000, 'sine', 0.1); },
    onFever() { this.chirp(500, 'square', 0.4, 0.1); setTimeout(()=>this.chirp(800, 'square', 0.5), 150); }
};

/* ==========================================================================
   MODULE 3: CORE GAME ENGINE (V·∫¨N H√ÄNH TR√í CH∆†I)
   ========================================================================== */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let W, H;

const AppCore = {
    session: { active: false, score: 0, time: 60, items: [], particles: [] },
    actor: { x: 0, y: 0, w: 110, h: 95 },
    fever: { val: 0, active: false, timer: 0 },
    
    // TR·∫†NG TH√ÅI V·∫¨T PH·∫®M (ƒê√É X√ìA TO√ÄN B·ªò M·ªú ·∫¢O & T·ªêI THUI)
    status: { shield: false, frozen: 0, reverse: 0, magnet: 0, stun: 0, lag: 0, drunk: 0, god: 0, blackhole: 0, slow: 0 },

    boot() {
        Database.boot(); AudioEngine.ignite();
        W = canvas.width = window.innerWidth;
        H = canvas.height = window.innerHeight;
        
        this.actor.x = W / 2 - 55; this.actor.y = H - 150;
        this.session.active = true; this.session.score = 0; this.session.time = 60;
        this.session.items = []; this.session.particles = [];
        this.fever = { val: 0, active: false, timer: 0 };
        Object.keys(this.status).forEach(k => this.status[k] = (typeof this.status[k] === 'boolean' ? false : 0));

        UIBridge.screenSwitch('gameScreen');
        document.getElementById('menuScreen').style.display = 'none';

        this.render();
        this.spawn();
        this.clock();
    },

    clock() {
        const t = setInterval(() => {
            if (!this.session.active) return clearInterval(t);
            this.session.time--;
            document.getElementById('timeVal').innerText = this.session.time;

            Object.keys(this.status).forEach(k => { if (typeof this.status[k] === 'number' && this.status[k] > 0) this.status[k]--; });
            if (this.fever.active) { this.fever.timer--; if (this.fever.timer <= 0) this.fever.active = false; }

            UIBridge.renderFX();
            if (this.session.time <= 0) this.shutdown();
        }, 1000);
    },

    spawn() {
        if (!this.session.active) return;

        // GI·ªöI H·∫†N S·ªê L∆Ø·ª¢NG V·∫¨T PH·∫®M: Tr√°nh r·ªëi m·∫Øt v√† spam ƒëi·ªÉm
        if (this.session.items.length < 18) {
            let r = Math.random(), type = 'coin';

            // PH√ÇN B·ªî T·ª∂ L·ªÜ C√ÇN B·∫∞NG
            if (r < 0.12) type = 'bomb';
            else if (r < 0.22) type = 'star';
            else if (r < 0.24) type = 'ice'; else if (r < 0.26) type = 'reverse';
            else if (r < 0.28) type = 'drunk'; else if (r < 0.29) type = 'stun';
            else if (r < 0.31) type = 'lag'; else if (r < 0.32) type = 'blackhole';
            else if (r < 0.34) type = 'shield'; else if (r < 0.35) type = 'magnet';

            if (this.fever.active) type = (Math.random() < 0.35) ? 'star' : 'coin';

            this.session.items.push({
                x: Math.random() * (W - 60), y: -70, type,
                spd: (4 + Math.random() * 2.5) * (1 + (60 - this.session.time) / 250), // T·ªëc ƒë·ªô tƒÉng ch·∫≠m
                phase: Math.random() * Math.PI * 2
            });
        }

        let next = this.fever.active ? 200 : Math.max(700, 1100 - (60 - this.session.time) * 6);
        setTimeout(() => this.spawn(), next);
    },

    render() {
        if (!this.session.active) return;
        ctx.clearRect(0, 0, W, H);

        // Particle System
        for (let i = this.session.particles.length - 1; i >= 0; i--) {
            let p = this.session.particles[i];
            p.x += p.vx; p.y += p.vy; p.life -= 0.04;
            if (p.life <= 0) this.session.particles.splice(i, 1);
            else {
                ctx.fillStyle = `rgba(211, 47, 47, ${p.life})`;
                ctx.beginPath(); ctx.arc(p.x, p.y, 4, 0, Math.PI * 2); ctx.fill();
            }
        }

        // V·∫Ω Nh√¢n v·∫≠t ch√≠nh (Basket) - LU√îN R√ï N√âT
        let icon = this.fever.active ? "üòé" : (this.status.frozen > 0 ? "ü•∂" : (this.status.stun > 0 ? "üòµ" : "üß∫"));
        ctx.font = `110px Arial`;
        ctx.fillText(icon, this.actor.x, H - 60);

        // V·∫Ω V·∫≠t ph·∫©m
        for (let i = this.session.items.length - 1; i >= 0; i--) {
            let it = this.session.items[i];
            let isBad = ['bomb', 'ice', 'reverse', 'drunk', 'stun', 'lag', 'blackhole'].includes(it.type);

            if (it.type === 'blackhole') {
                it.y += it.spd;
                this.session.items.forEach(o => { 
                    if(o !== it) {
                        let d = Math.hypot(it.x - o.x, it.y - o.y);
                        if(d < 160) { o.x += (it.x - o.x)*0.13; o.y += (it.y - o.y)*0.13; }
                    }
                });
            } else if ((this.fever.active || this.status.magnet > 0) && !isBad) {
                it.x += (this.actor.x + 55 - it.x) * 0.16; it.y += (H - 100 - it.y) * 0.16;
            } else { it.y += it.spd; }

            ctx.font = `52px Arial`;
            const iconMap = { coin: 'üßß', bomb: 'üí£', star: 'üåü', ice: '‚ùÑÔ∏è', reverse: '‚ö°', drunk: 'ü§°', shield: 'üõ°Ô∏è', magnet: 'üß≤', blackhole: 'üï≥Ô∏è' };
            ctx.fillText(iconMap[it.type] || 'üßß', it.x, it.y);

            if (it.y > H - 140 && it.y < H - 50 && it.x > this.actor.x - 45 && it.x < this.actor.x + 110) {
                this.hit(it.type, it.x, it.y); this.session.items.splice(i, 1);
            } else if (it.y > H) this.session.items.splice(i, 1);
        }

        document.getElementById('scoreVal').innerText = Math.floor(this.session.score);
        document.getElementById('energyFill').style.width = this.fever.active ? "100%" : this.fever.val + "%";
        requestAnimationFrame(() => this.render());
    },

    hit(type, x, y) {
        let isBad = ['bomb', 'ice', 'reverse', 'drunk', 'stun', 'lag', 'blackhole'].includes(type);
        if (isBad && this.status.shield) { this.status.shield = false; return; }

        if (type === 'bomb') {
            this.session.score = Math.max(0, this.session.score - 10);
            this.fever.val = Math.max(0, this.fever.val - 45); 
        } else if (type === 'coin') {
            this.session.score += 1; AudioEngine.onCatch();
        } else if (type === 'star') {
            if (!this.fever.active) {
                this.fever.val += 20;
                if (this.fever.val >= 100) { this.fever.active = true; this.fever.val = 0; this.fever.timer = 8; AudioEngine.onFever(); }
            }
            AudioEngine.onCatch();
        } else if (type === 'ice') this.status.frozen = 4;
        else if (type === 'reverse') this.status.reverse = 5;
        else if (type === 'drunk') this.status.drunk = 5;
        else if (type === 'stun') this.status.stun = 1.5;
        else if (type === 'shield') this.status.shield = true;
        else if (type === 'magnet') this.status.magnet = 6;

        for (let i = 0; i < 10; i++) this.session.particles.push({ x, y, vx: Math.random() * 8 - 4, vy: Math.random() * 8 - 4, life: 1 });
        if (navigator.vibrate) navigator.vibrate(40);
    },

    shutdown() {
        this.session.active = false;
        UIBridge.screenSwitch('pickScreen');
        // ECONOMY BALANCE: Luck t·ªëi ƒëa 30% ƒë·ªÉ tr√°nh l·∫°m ph√°t ti·ªÅn m·∫∑t
        let luck = Math.min(30, this.session.score / 18);
        document.getElementById('luckBonus').innerText = Math.floor(luck);
        GachaProcessor.ignite(luck);
    }
};

/* ==========================================================================
   MODULE 4: GACHA SYSTEM (TO√ÅN H·ªåC C√ÇN B·∫∞NG T·ªêI ∆ØU)
   ========================================================================== */
const GachaProcessor = {
    ignite(luck) {
        const grid = document.getElementById('cardGrid');
        grid.innerHTML = '';
        for (let i = 0; i < 9; i++) {
            const card = document.createElement('div');
            card.className = 'gacha-box';
            card.innerHTML = `<div class="gacha-box-inner"><div class="gacha-face gacha-front">üßß</div><div class="gacha-face gacha-back">?</div></div>`;
            card.onclick = () => this.draw(card, luck);
            grid.appendChild(card);
        }
        // CHEAT KEYS ADMIN
        window.onkeydown = (e) => { if (e.key === '9') window.force = 'MAX'; if (e.key === '1') window.force = 'MIN'; };
    },

    draw(el, luck) {
        if (el.classList.contains('is-flipped')) return;

        const config = Database.loadConfig();
        let prize = 10000;

        if (window.force === 'MAX') prize = Math.max(...config.map(c => c.a));
        else if (window.force === 'MIN') prize = Math.min(...config.map(c => c.a));
        else {
            let totalW = 0;
            // THU·∫¨T TO√ÅN FLOOR PROTECTION 55%
            const pool = config.map(item => {
                let w = item.w;
                if (item.a >= 50000) w *= (1 + luck / 18); 
                else w = Math.max(w * 0.5, w * (1 - luck / 100)); 
                totalW += w;
                return { a: item.a, cW: totalW };
            });
            const roll = Math.random() * totalW;
            prize = pool.find(p => roll <= p.cW).a;
        }

        el.classList.add('is-flipped');
        el.querySelector('.gacha-back').innerText = (prize / 1000) + 'k';
        
        setTimeout(() => {
            UIBridge.screenSwitch('revealScreen');
            document.getElementById('prizeAmount').innerText = prize.toLocaleString() + 'ƒë';
            Database.writeRecord(prize);
        }, 1200);
    }
};

/* ==========================================================================
   MODULE 5: UI & ADMIN CONTROL
   ========================================================================== */
const AdminLogic = {
    verify() {
        const u = document.getElementById('admU').value;
        const p = document.getElementById('admP').value;
        //
        if (u === 'Admin' && p === 'Quoc2007@') {
            UIBridge.toggleModal('loginModal', false);
            this.open();
        } else alert('L·ªói truy c·∫≠p!');
    },

    open() {
        UIBridge.toggleModal('adminPanel', true);
        const cfg = Database.loadConfig();
        document.getElementById('cfgData').value = cfg.map(c => `${c.a}:${c.w}`).join('\n');
        
        const hist = Database.fetchHistory();
        const sum = hist.reduce((a, b) => a + b.v, 0);
        document.getElementById('statsBox').innerHTML = `
            <div class="dashboard-row"><span>T·ªïng ti·ªÅn ph√°t:</span><b style="color:red">${sum.toLocaleString()}ƒë</b></div>
            <div class="dashboard-row"><span>T·ªïng l∆∞·ª£t ch∆°i:</span><b>${hist.length}</b></div>
        `;
    },

    applyChanges() {
        try {
            const raw = document.getElementById('cfgData').value.trim();
            const data = raw.split('\n').map(l => { const [a, w] = l.split(':'); return { a: parseInt(a), w: parseInt(w) }; });
            Database.saveConfig(data); alert('ƒê√£ l∆∞u h·ªá th·ªëng kinh t·∫ø!');
        } catch(e) { alert('Sai ƒë·ªãnh d·∫°ng!'); }
    },

    purgeData() { if (confirm('X√≥a s·∫°ch d·ªØ li·ªáu?')) { localStorage.removeItem(Database.keys.hist); this.open(); } }
};

const UIBridge = {
    toggleModal: (id, s) => document.getElementById(id).style.display = s ? 'flex' : 'none',
    screenSwitch: (target) => { ['menuScreen', 'gameScreen', 'pickScreen', 'revealScreen'].forEach(s => document.getElementById(s).style.display = (s === target ? 'flex' : 'none')); },
    
    renderFX() {
        document.getElementById('gameScreen').className = AppCore.status.drunk > 0 ? 'fx-drunk-basket' : '';
        document.getElementById('iceOverlay').style.opacity = AppCore.status.frozen > 0 ? 0.8 : 0;
        if (AppCore.fever.active) document.getElementById('gameScreen').classList.add('fx-fever-active'); else document.getElementById('gameScreen').classList.remove('fx-fever-active');

        let i = "";
        if (AppCore.status.shield) i += "üõ°Ô∏è ";
        if (AppCore.status.magnet > 0) i += "üß≤ ";
        if (AppCore.status.reverse > 0) i += "‚ö° ";
        document.getElementById('statusIcons').innerText = i;
    }
};

/* --- INPUT HANDLING --- */
const processInput = (x) => {
    if (!AppCore.session.active || AppCore.status.stun > 0) return;
    let target = x - 55;
    if (AppCore.status.reverse > 0) target = W - x - 55;
    const speed = AppCore.status.frozen > 0 ? 0.16 : (AppCore.status.lag > 0 ? 0.04 : 1);
    AppCore.actor.x += (target - AppCore.actor.x) * speed;
};

canvas.addEventListener('mousemove', e => processInput(e.clientX));
canvas.addEventListener('touchmove', e => { e.preventDefault(); processInput(e.touches[0].clientX); }, { passive: false });
window.onresize = () => { if (AppCore.session.active) AppCore.boot(); };
</script>
</body>
</html>
