<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>L√¨ X√¨ 32.0 - The Restored Masterpiece</title>
    <style>
        /* --- CORE VISUALS: S·∫ÆC N√âT & T∆Ø∆†NG PH·∫¢N --- */
        :root { 
            --red: #d32f2f; --gold: #fbc02d; --blue: #0288d1; --white: #ffffff;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; overflow: hidden; background: #222; font-family: sans-serif; touch-action: none; user-select: none; }

        /* --- M√ÄN H√åNH GAME (TR·∫ÆNG TUY·ªÜT ƒê·ªêI) --- */
        #gameScreen { 
            background-color: #ffffff !important; 
            background-image: radial-gradient(#e0e0e0 1px, transparent 1px);
            background-size: 20px 20px;
            cursor: none; overflow: hidden; position: relative;
        }

        /* --- HI·ªÜU ·ª®NG V·∫¨T L√ù (KH√îNG D√ôNG BLUR) --- */
        /* Hi·ªáu ·ª©ng Say r∆∞·ª£u: Ch·ªâ l·∫Øc c√°i gi·ªè, kh√¥ng l√†m m·ªù m√†n h√¨nh */
        .basket-drunk { animation: shakeBasket 0.2s infinite; }
        @keyframes shakeBasket { 0% { transform: translateX(0); } 25% { transform: translateX(10px) rotate(5deg); } 75% { transform: translateX(-10px) rotate(-5deg); } }

        /* Hi·ªáu ·ª©ng Lag: Gi·∫≠t c·ª•c */
        .basket-lag { transition: left 0.5s steps(3) !important; }

        /* Hi·ªáu ·ª©ng BƒÉng: Ch·ªâ hi·ªán vi·ªÅn xanh nh·∫°t */
        #iceBorder { 
            position: absolute; inset: 0; pointer-events: none; z-index: 90;
            border: 0px solid #bbdefb; transition: 0.3s;
        }
        .frozen-active { border-width: 20px !important; }

        /* --- UI ELEMENTS --- */
        .screen { position: absolute; inset: 0; display: none; flex-direction: column; align-items: center; justify-content: center; }
        #menuScreen { display: flex; background: radial-gradient(circle, #ff5252, #b71c1c); color: white; z-index: 100; }
        
        .hud-top { position: absolute; top: 0; width: 100%; padding: 15px; display: flex; justify-content: space-around; font-size: 2rem; font-weight: 900; color: var(--red); text-shadow: 2px 2px 0 white; z-index: 50; pointer-events: none; }
        .status-bar { position: absolute; top: 60px; width: 100%; text-align: center; font-size: 1.5rem; z-index: 50; pointer-events: none; }
        
        .energy-box { position: absolute; bottom: 30px; left: 10%; width: 80%; height: 20px; background: #ddd; border: 3px solid var(--red); border-radius: 15px; overflow: hidden; z-index: 50; }
        .energy-val { width: 0%; height: 100%; background: linear-gradient(90deg, #00e5ff, white); transition: width 0.2s; }

        /* --- GACHA --- */
        .grid-box { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; padding: 20px; }
        .card { width: 90px; height: 130px; background: var(--red); border: 4px solid var(--gold); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 3rem; cursor: pointer; color: white; transition: transform 0.3s; }
        .card.open { background: white; color: var(--red); font-size: 1.2rem; font-weight: bold; transform: rotateY(180deg); }

        /* --- BUTTONS --- */
        .btn { background: var(--gold); color: #900; border: none; padding: 15px 50px; font-size: 1.5rem; font-weight: bold; border-radius: 50px; cursor: pointer; box-shadow: 0 5px 0 #b79500; margin-top: 20px; }
        .btn:active { transform: translateY(4px); box-shadow: none; }
        .admin-gear { position: fixed; top: 10px; right: 10px; opacity: 0.1; font-size: 30px; cursor: pointer; z-index: 1000; }

        /* --- MODAL --- */
        .modal-bg { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; align-items: center; justify-content: center; }
        .modal-box { background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; text-align: center; }
        input, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; font-size: 1rem; }
    </style>
</head>
<body>

    <div id="iceBorder"></div>

    <div id="menuScreen" class="screen">
        <div class="admin-gear" onclick="UI.modal('login', true)">‚öôÔ∏è</div>
        <div style="font-size: 6rem; margin-bottom: 20px;">üßß</div>
        <h1 style="margin:0; font-size: 3.5rem; text-shadow: 2px 2px 0 #000;">L√å X√å 32.0</h1>
        <p>B·∫£n Kh√¥i Ph·ª•c Ho√†n H·∫£o - S·∫°ch & ƒê·∫ßy ƒê·ªß</p>
        <button class="btn" onclick="Game.init()">B·∫ÆT ƒê·∫¶U</button>
    </div>

    <div id="gameScreen" class="screen">
        <div class="hud-top">
            <span>‚åõ <span id="tVal">60</span>s</span>
            <span>üí∞ <span id="sVal">0</span></span>
        </div>
        <div class="status-bar" id="stIcon"></div>
        <canvas id="gc"></canvas>
        <div class="energy-box"><div class="energy-val" id="eVal"></div></div>
    </div>

    <div id="pickScreen" class="screen" style="background: #222;">
        <h2 style="color: var(--gold)">CH·ªåN L√å X√å</h2>
        <p style="color:white">Luck Bonus: +<span id="luckVal">0</span>%</p>
        <div class="grid-box" id="gridBox"></div>
    </div>

    <div id="resScreen" class="screen" style="background: rgba(0,0,0,0.9);">
        <div style="background: white; padding: 40px; border-radius: 20px; border: 6px solid var(--gold); color: var(--red); text-align: center;">
            <h2>K·∫æT QU·∫¢</h2>
            <div style="font-size: 5rem; margin: 20px 0;">üéâ</div>
            <div id="resVal" style="font-size: 3rem; font-weight: 900;">0ƒë</div>
            <button class="btn" onclick="location.reload()">L∆ØU</button>
        </div>
    </div>

    <div id="loginModal" class="modal-bg">
        <div class="modal-box">
            <h3>üîê ADMIN LOGIN</h3>
            <input type="text" id="admU" placeholder="User">
            <input type="password" id="admP" placeholder="Pass">
            <button class="btn" style="width:100%" onclick="Admin.auth()">ƒêƒÇNG NH·∫¨P</button>
            <button class="btn" style="width:100%; background:#ccc; margin-top:10px;" onclick="UI.modal('login', false)">HU·ª∂</button>
        </div>
    </div>

    <div id="panelModal" class="modal-bg">
        <div class="modal-box" style="text-align: left;">
            <h3 style="text-align:center; border-bottom: 2px solid var(--gold); padding-bottom: 10px;">‚öôÔ∏è QU·∫¢N L√ù</h3>
            <div id="stats" style="background:#f5f5f5; padding:10px; margin-bottom:10px; border-radius:5px;"></div>
            <label>C·∫•u h√¨nh (Ti·ªÅn:Tr·ªçng s·ªë):</label>
            <textarea id="cfgData" rows="8"></textarea>
            <button class="btn" style="width:100%" onclick="Admin.save()">L∆ØU</button>
            <button class="btn" style="width:100%; background:#f44336; color:white; margin-top:10px;" onclick="Admin.wipe()">RESET</button>
            <button class="btn" style="width:100%; background:#999; color:white; margin-top:10px;" onclick="UI.modal('panel', false)">THO√ÅT</button>
        </div>
    </div>

<script>
/* ================= 1. D·ªÆ LI·ªÜU & C·∫§U H√åNH ================= */
const Data = {
    kC: 'lx32_cfg', kH: 'lx32_hist',
    def: [
        {v:10000, w:200}, {v:20000, w:150}, {v:30000, w:100}, {v:40000, w:60},
        {v:50000, w:30}, {v:60000, w:15}, {v:70000, w:8}, {v:80000, w:4},
        {v:90000, w:2}, {v:100000, w:1}
    ],
    load() { return JSON.parse(localStorage.getItem(this.kC)) || this.def; },
    save(d) { localStorage.setItem(this.kC, JSON.stringify(d)); },
    hist() { return JSON.parse(localStorage.getItem(this.kH)) || []; },
    log(val) { 
        let h = this.hist(); h.push({d: new Date().toLocaleTimeString(), v: val}); 
        localStorage.setItem(this.kH, JSON.stringify(h.slice(-200))); 
    }
};

/* ================= 2. √ÇM THANH (SYNTH) ================= */
const Sfx = {
    ctx: null,
    init() { if(!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
    play(freq, type='sine', dur=0.1) {
        if(!this.ctx) return;
        const o = this.ctx.createOscillator(), g = this.ctx.createGain();
        o.type = type; o.frequency.value = freq;
        g.gain.setValueAtTime(0.1, this.ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + dur);
        o.connect(g); g.connect(this.ctx.destination);
        o.start(); o.stop(this.ctx.currentTime + dur);
    }
};

/* ================= 3. GAME ENGINE (KH√îI PH·ª§C FULL T√çNH NƒÇNG) ================= */
const cvs = document.getElementById('gc');
const ctx = cvs.getContext('2d');
let W, H;

const Game = {
    run: false, score: 0, time: 60, items: [], parts: [],
    p: { x: 0, y: 0, w: 100 },
    fever: { on: false, val: 0, tick: 0 },
    // KH√îI PH·ª§C ƒê·∫¶Y ƒê·ª¶ TR·∫†NG TH√ÅI
    st: { shield: false, frozen: 0, reverse: 0, magnet: 0, drunk: 0, stun: 0, god: 0, blackhole: 0, double: 0 },

    init() {
        Sfx.init(); 
        W = cvs.width = window.innerWidth; H = cvs.height = window.innerHeight;
        this.p.x = W/2 - 50; this.p.y = H - 140;
        this.run = true; this.score = 0; this.time = 60;
        this.items = []; this.parts = [];
        this.fever = { on: false, val: 0, tick: 0 };
        // Reset tr·∫°ng th√°i
        for(let k in this.st) this.st[k] = 0;
        
        UI.scr('gameScreen');
        this.loop(); this.spawn(); this.clock();
    },

    clock() {
        let t = setInterval(() => {
            if(!this.run) return clearInterval(t);
            this.time--; document.getElementById('tVal').innerText = this.time;
            
            // Gi·∫£m timer hi·ªáu ·ª©ng
            for(let k in this.st) if(typeof this.st[k] === 'number' && this.st[k] > 0) this.st[k]--;
            if(this.fever.on) { this.fever.tick--; if(this.fever.tick <= 0) this.fever.on = false; }
            
            UI.updFX();
            if(this.time <= 0) this.over();
        }, 1000);
    },

    spawn() {
        if(!this.run) return;
        if(this.items.length < 20) {
            let r = Math.random(), t = 'coin';
            // KH√îI PH·ª§C T·ª∂ L·ªÜ ƒê·∫¶Y ƒê·ª¶ C√ÅC V·∫¨T PH·∫®M
            if(r < 0.12) t = 'bomb';
            else if(r < 0.22) t = 'star';
            else if(r < 0.24) t = 'ice'; else if(r < 0.26) t = 'reverse';
            else if(r < 0.28) t = 'drunk'; else if(r < 0.30) t = 'stun';
            else if(r < 0.32) t = 'blackhole'; else if(r < 0.34) t = 'shield';
            else if(r < 0.36) t = 'magnet'; else if(r < 0.37) t = 'god';
            else if(r < 0.38) t = 'double';

            if(this.fever.on) t = Math.random() < 0.4 ? 'star' : 'coin';

            this.items.push({
                x: Math.random()*(W-60), y: -70, type: t,
                spd: (4 + Math.random()*2.5) * (1 + (60 - this.time)/200)
            });
        }
        setTimeout(() => this.spawn(), this.fever.on ? 180 : 750);
    },

    loop() {
        if(!this.run) return;
        ctx.clearRect(0,0,W,H);

        // H·∫†T PARTICLES (S·∫ÆC N√âT)
        for(let i=this.parts.length-1; i>=0; i--) {
            let p = this.parts[i];
            p.y += p.vy; p.life -= 0.05;
            if(p.life <= 0) this.parts.splice(i,1);
            else { ctx.fillStyle=`rgba(255,0,0,${p.life})`; ctx.fillRect(p.x, p.y, 6, 6); }
        }

        // PLAYER
        let ico = this.fever.on ? "üòé" : (this.st.frozen > 0 ? "ü•∂" : (this.st.stun > 0 ? "üòµ" : "üß∫"));
        ctx.font = "100px Arial"; ctx.fillStyle = "#000";
        // Hi·ªáu ·ª©ng Drunk: Rung gi·ªè thay v√¨ m·ªù m√†n h√¨nh
        let dx = this.st.drunk > 0 ? (Math.random()*10 - 5) : 0;
        ctx.fillText(ico, this.p.x + dx, H - 60);

        // ITEMS
        for(let i=this.items.length-1; i>=0; i--) {
            let it = this.items[i];
            let bad = ['bomb','ice','reverse','drunk','stun','blackhole'].includes(it.type);

            // LOGIC H·ªê ƒêEN & NAM CH√ÇM
            if(it.type === 'blackhole') {
                it.y += it.spd;
                this.items.forEach(o => { if(o !== it && Math.hypot(it.x-o.x, it.y-o.y) < 150) { o.x += (it.x-o.x)*0.1; o.y += (it.y-o.y)*0.1; } });
            } else if((this.fever.on || this.st.magnet > 0) && !bad) {
                it.x += (this.p.x + 50 - it.x) * 0.15; it.y += (H - 100 - it.y) * 0.15;
            } else {
                it.y += this.st.frozen > 0 ? it.spd * 0.2 : it.spd;
            }

            ctx.font = "50px Arial";
            let map = {coin:'üßß', bomb:'üí£', star:'üåü', ice:'‚ùÑÔ∏è', reverse:'‚ö°', drunk:'ü§°', shield:'üõ°Ô∏è', magnet:'üß≤', god:'üéã', blackhole:'üï≥Ô∏è', double:'x2'};
            ctx.fillText(map[it.type] || 'üßß', it.x, it.y);

            if(it.y > H-130 && it.y < H-40 && it.x > this.p.x-40 && it.x < this.p.x+100) {
                this.hit(it.type, it.x, it.y); this.items.splice(i,1);
            } else if(it.y > H) this.items.splice(i,1);
        }

        document.getElementById('sVal').innerText = Math.floor(this.score);
        document.getElementById('eVal').style.width = this.fever.on ? "100%" : this.fever.val + "%";
        requestAnimationFrame(() => this.loop());
    },

    hit(t, x, y) {
        let bad = ['bomb','ice','reverse','drunk','stun','blackhole'].includes(t);
        if(bad && (this.st.god > 0)) return;
        if(bad && this.st.shield) { this.st.shield = false; return; }

        for(let k=0; k<6; k++) this.parts.push({x:x, y:y, vy: Math.random()*-5, life:1});

        if(t === 'bomb') {
            this.score = Math.max(0, this.score - 10);
            this.fever.val = Math.max(0, this.fever.val - 40);
            Sfx.play(100, 'sawtooth');
        } else if(t === 'coin') {
            this.score += 1 * (this.st.double > 0 ? 2 : 1); Sfx.play(800);
        } else if(t === 'star') {
            if(!this.fever.on) {
                this.fever.val += 20;
                if(this.fever.val >= 100) { this.fever.on = true; this.fever.val = 0; this.fever.tick = 8; Sfx.play(600, 'square'); }
            }
            Sfx.play(1000);
        } else if(t === 'ice') this.st.frozen = 4;
        else if(t === 'reverse') this.st.reverse = 5;
        else if(t === 'drunk') this.st.drunk = 5;
        else if(t === 'stun') this.st.stun = 2;
        else if(t === 'shield') this.st.shield = true;
        else if(t === 'magnet') this.st.magnet = 6;
        else if(t === 'god') this.st.god = 6;
        else if(t === 'double') this.st.double = 10;
        
        if(navigator.vibrate) navigator.vibrate(50);
    },

    over() {
        this.run = false; UI.scr('pickScreen');
        let luck = Math.min(30, this.score/15);
        document.getElementById('luckVal').innerText = Math.floor(luck);
        Gacha.init(luck);
    }
};

/* ================= 4. GACHA & ECONOMY ================= */
const Gacha = {
    init(luck) {
        const b = document.getElementById('gridBox'); b.innerHTML = '';
        for(let i=0; i<9; i++) {
            let c = document.createElement('div'); c.className = 'card';
            c.innerHTML = 'üßß';
            c.onclick = () => {
                if(c.classList.contains('open')) return;
                let p = this.calc(luck);
                c.className = 'card open'; c.innerText = (p/1000) + 'k';
                setTimeout(() => {
                    UI.scr('resScreen');
                    document.getElementById('resVal').innerText = p.toLocaleString() + 'ƒë';
                    Data.log(p);
                }, 1000);
            };
            b.appendChild(c);
        }
        window.onkeydown = (e) => { if(e.key=='9') window.f='max'; if(e.key=='1') window.f='min'; };
    },
    calc(luck) {
        const cfg = Data.load();
        if(window.f == 'max') return Math.max(...cfg.map(i=>i.v));
        if(window.f == 'min') return Math.min(...cfg.map(i=>i.v));
        
        let tot = 0;
        let pool = cfg.map(i => {
            let w = i.w;
            if(i.v >= 50000) w *= (1 + luck/15);
            else w = Math.max(w * 0.5, w * (1 - luck/100)); // Floor 50%
            tot += w; return {v: i.v, cw: tot};
        });
        let r = Math.random() * tot;
        return pool.find(i => r <= i.cw).v;
    }
};

/* ================= 5. UI & ADMIN ================= */
const Admin = {
    auth() {
        // S·ª¨A L·ªñI ƒêƒÇNG NH·∫¨P: D√πng .trim() ƒë·ªÉ tr√°nh l·ªói kho·∫£ng tr·∫Øng
        let u = document.getElementById('admU').value.trim();
        let p = document.getElementById('admP').value.trim();
        if(u === 'Admin' && p === 'Quoc2007@') {
            UI.modal('login', false); UI.modal('panel', true); this.load();
        } else alert('Sai th√¥ng tin!');
    },
    load() {
        let cfg = Data.load();
        document.getElementById('cfgData').value = cfg.map(i => `${i.v}:${i.w}`).join('\n');
        let h = Data.hist();
        let s = h.reduce((a,b)=>a+b.v, 0);
        document.getElementById('stats').innerHTML = `T·ªïng chi: <b style="color:red">${s.toLocaleString()}ƒë</b> | L∆∞·ª£t: ${h.length}`;
    },
    save() {
        try {
            let r = document.getElementById('cfgData').value.trim().split('\n');
            let d = r.map(l => { let p = l.split(':'); return {v:parseInt(p[0]), w:parseInt(p[1])}; });
            Data.save(d); alert('ƒê√£ l∆∞u!');
        } catch(e) { alert('L·ªói ƒë·ªãnh d·∫°ng!'); }
    },
    wipe() { if(confirm('X√≥a?')) { localStorage.removeItem(Data.kH); this.load(); } }
};

const UI = {
    scr(id) {
        ['menuScreen','gameScreen','pickScreen','resScreen'].forEach(s => document.getElementById(s).style.display = 'none');
        document.getElementById(id).style.display = 'flex';
    },
    modal(n, s) { document.getElementById(n+'Modal').style.display = s ? 'flex' : 'none'; },
    updFX() {
        document.getElementById('iceBorder').className = Game.st.frozen > 0 ? 'frozen-active' : '';
        let i = "";
        if(Game.st.shield) i+="üõ°Ô∏è "; if(Game.st.magnet>0) i+="üß≤ "; 
        if(Game.st.god>0) i+="üéã "; if(Game.st.double>0) i+="x2 ";
        if(Game.st.reverse>0) i+="‚ö° ";
        document.getElementById('stIcon').innerText = i;
    }
};

// INPUT
const input = (x) => {
    if(!Game.run || Game.st.stun > 0) return;
    let tx = x - 50;
    if(Game.st.reverse > 0) tx = W - x - 50;
    let spd = Game.st.frozen > 0 ? 0.2 : 1;
    // Hi·ªáu ·ª©ng Lag
    if(Game.st.lag > 0) spd = 0.05; 
    
    Game.p.x += (tx - Game.p.x) * spd;
};
canvas.addEventListener('mousemove', e => input(e.clientX));
canvas.addEventListener('touchmove', e => { e.preventDefault(); input(e.touches[0].clientX); }, {passive:false});
window.onresize = () => { if(Game.run) Game.init(); };
</script>
</body>
</html>
