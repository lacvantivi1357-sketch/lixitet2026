<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>L√¨ X√¨ 26.0 - Infinite Architect Edition</title>
    <style>
        /* --- CSS VARIABLES --- */
        :root { 
            --primary-red: #d32f2f; 
            --gold-yellow: #fbc02d; 
            --fever-blue: #00e5ff; 
            --ice-blue: #bbdefb; 
            --canvas-bg: #ffffff;
            --admin-bg: #f8f9fa;
        }

        /* --- GLOBAL RESET --- */
        * { box-sizing: border-box; }
        body { 
            margin: 0; padding: 0; overflow: hidden; 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background: #000; touch-action: none; user-select: none; transition: background 0.5s; 
        }

        /* --- VISUAL OVERLAYS (NO BLUR) --- */
        #iceOverlay { 
            position: fixed; inset: 0; pointer-events: none; z-index: 100; 
            border: 25px solid rgba(187, 222, 251, 0.5); opacity: 0; transition: 0.5s; 
            box-shadow: inset 0 0 120px rgba(187, 222, 251, 0.3); 
        }
        .fx-eclipse { background: rgba(0,0,0,0.68) !important; transition: 1.5s; }
        .fx-fever-glow { box-shadow: inset 0 0 100px rgba(0, 229, 255, 0.4); }
        .fx-shake-ui { animation: uiShake 0.15s infinite; }
        
        @keyframes uiShake { 
            0% { transform: translate(0,0); } 
            25% { transform: translate(3px, -3px); } 
            75% { transform: translate(-3px, 3px); } 
            100% { transform: translate(0,0); } 
        }

        /* --- SCREENS SYSTEM --- */
        .screen { 
            position: absolute; inset: 0; display: none; flex-direction: column; 
            align-items: center; justify-content: center; text-align: center; color: white; 
        }
        #menuScreen { 
            display: flex; 
            background: radial-gradient(circle at center, #ff5252 0%, #b71c1c 100%); 
            z-index: 10; 
        }
        #gameScreen { background: var(--canvas-bg); cursor: none; overflow: hidden; }

        /* --- HUD & TOP BAR --- */
        .hud-container { 
            position: absolute; top: 0; width: 100%; height: 100px;
            display: flex; flex-direction: column; align-items: center; z-index: 20; 
            pointer-events: none;
        }
        .hud-main {
            width: 100%; display: flex; justify-content: space-around; 
            padding: 15px 0; font-size: 1.8rem; font-weight: 900; 
            color: var(--primary-red); text-shadow: 2px 2px 0 #fff;
        }
        .status-tray { 
            display: flex; gap: 10px; font-size: 1.6rem; 
            background: rgba(255,255,255,0.7); padding: 5px 20px; border-radius: 30px;
        }

        /* --- ENERGY SYSTEM --- */
        .energy-outer { 
            position: absolute; bottom: 30px; left: 10%; width: 80%; height: 18px; 
            background: rgba(0,0,0,0.1); border-radius: 20px; border: 3px solid var(--primary-red); 
            overflow: hidden; z-index: 20; 
        }
        .energy-inner { 
            width: 0%; height: 100%; background: linear-gradient(90deg, var(--fever-blue), #fff); 
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
        }

        /* --- GACHA CARD SYSTEM --- */
        .card-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 18px; padding: 25px; }
        .gacha-card { perspective: 1000px; width: 100px; height: 145px; cursor: pointer; }
        .gacha-card-inner { position: relative; width: 100%; height: 100%; transition: 0.8s; transform-style: preserve-3d; }
        .gacha-face { 
            position: absolute; inset: 0; backface-visibility: hidden; border-radius: 18px; 
            display: flex; align-items: center; justify-content: center; border: 4px solid var(--gold-yellow); 
        }
        .gacha-front { background: var(--primary-red); font-size: 3.5rem; box-shadow: 0 8px 20px rgba(0,0,0,0.5); }
        .gacha-back { background: white; color: var(--primary-red); font-weight: 900; transform: rotateY(180deg); font-size: 1.4rem; }
        .is-flipped .gacha-card-inner { transform: rotateY(180deg); }

        /* --- BUTTONS --- */
        .btn-ui { 
            background: var(--gold-yellow); color: #7f0000; border: none; padding: 18px 50px; 
            border-radius: 60px; font-weight: 900; cursor: pointer; 
            box-shadow: 0 8px 0 #b79500; margin-top: 20px; font-size: 1.4rem; 
            text-transform: uppercase; transition: 0.2s;
        }
        .btn-ui:hover { transform: scale(1.05); }
        .btn-ui:active { transform: translateY(6px); box-shadow: none; }
        
        .admin-entry { position: fixed; top: 10px; right: 10px; opacity: 0.05; cursor: pointer; z-index: 1000; font-size: 26px; }

        /* --- MODALS & ADMIN --- */
        .modal-overlay { 
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); 
            z-index: 2000; align-items: center; justify-content: center; 
        }
        .modal-box { 
            background: white; padding: 30px; border-radius: 25px; width: 95%; 
            max-width: 550px; color: #333; max-height: 90vh; overflow-y: auto; 
            box-shadow: 0 0 40px rgba(255,255,255,0.2);
        }
        .admin-input { width: 100%; padding: 15px; margin-bottom: 15px; border-radius: 10px; border: 1px solid #ddd; font-size: 1.1rem; }
        .admin-textarea { 
            width: 100%; padding: 15px; margin: 10px 0; border-radius: 12px; 
            border: 2px solid #eee; font-family: 'Courier New', monospace; font-size: 0.95rem; 
        }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .stat-box { background: #f0f2f5; padding: 15px; border-radius: 15px; text-align: center; border-bottom: 4px solid var(--gold-yellow); }
        .stat-label { font-size: 0.8rem; color: #666; text-transform: uppercase; }
        .stat-value { font-size: 1.5rem; font-weight: 800; color: var(--primary-red); }

        @keyframes float-logo { 
            0%, 100% { transform: translateY(0) rotate(0); } 
            50% { transform: translateY(-25px) rotate(5deg); } 
        }
    </style>
</head>
<body>
    <div id="iceOverlay"></div>
    
    <div id="menuScreen" class="screen">
        <div class="admin-entry" onclick="UI.toggle('loginModal', true)">‚öôÔ∏è</div>
        <div style="font-size: 7rem; animation: float-logo 4s ease-in-out infinite;">üßß</div>
        <h1 style="margin:0; font-size: 4rem; text-shadow: 4px 4px 0 #7f0000;">L√å X√å 26.0</h1>
        <p style="font-size: 1.4rem; font-weight: 300; letter-spacing: 2px;">THE INFINITE ARCHITECT</p>
        <button class="btn-ui" onclick="Game.initSession()">B·∫ÆT ƒê·∫¶U CHI·∫æN</button>
    </div>

    <div id="gameScreen" class="screen">
        <div class="hud-container">
            <div class="hud-main">
                <span>‚åõ <span id="timeVal">60</span>s</span>
                <span>üí∞ <span id="scoreVal">0</span></span>
            </div>
            <div class="status-tray" id="statusIcons"></div>
        </div>
        <canvas id="gameCanvas"></canvas>
        <div class="energy-outer"><div class="energy-inner" id="energyFill"></div></div>
    </div>

    <div id="pickScreen" class="screen">
        <h2 style="color:var(--gold-yellow); font-size: 2.5rem; margin-bottom: 5px;">B·ªêC QU√Ä MAY M·∫ÆN</h2>
        <p style="margin-bottom: 20px; font-size: 1.1rem;">ƒêi·ªÉm K·ªπ NƒÉng gi√∫p b·ªõt gi·∫£i nh·ªè: +<span id="luckBonus">0</span>%</p>
        <div class="card-grid" id="cardGrid"></div>
    </div>

    <div id="revealScreen" class="screen">
        <div style="background:white; color:var(--primary-red); padding:50px; border-radius:40px; border:8px solid var(--gold-yellow); width:350px; box-shadow: 0 0 100px rgba(255,215,0,0.6);">
            <h2 style="margin:0; font-size: 1.8rem;">PH·∫¶N TH∆Ø·ªûNG</h2>
            <div style="font-size: 6rem; margin: 25px 0;">üéÅ</div>
            <div id="prizeAmount" style="font-size: 3.5rem; font-weight: 900; letter-spacing: -2px;">0ƒë</div>
            <button class="btn-ui" onclick="location.reload()">L∆ØU & K·∫æT TH√öC</button>
        </div>
    </div>

    <div id="loginModal" class="modal-overlay">
        <div class="modal-box" style="max-width: 400px;">
            <h3 style="text-align:center; margin-bottom: 25px;">üîê X√ÅC MINH QUY·ªÄN TRUY C·∫¨P</h3>
            <input type="text" id="admU" class="admin-input" placeholder="T√™n ƒëƒÉng nh·∫≠p">
            <input type="password" id="admP" class="admin-input" placeholder="M·∫≠t kh·∫©u">
            <button class="btn-ui" style="width:100%" onclick="Admin.auth()">ƒêƒÇNG NH·∫¨P</button>
            <button class="btn-ui" style="width:100%; background:#eee; box-shadow:none; color:#666;" onclick="UI.toggle('loginModal', false)">H·ª¶Y B·ªé</button>
        </div>
    </div>

    <div id="adminPanel" class="modal-overlay">
        <div class="modal-box">
            <h3 style="margin-top:0; color:var(--primary-red); border-bottom: 3px solid var(--gold-yellow); padding-bottom: 10px;">üìä DASHBOARD ƒêI·ªÄU H√ÄNH</h3>
            
            <div class="stat-grid">
                <div class="stat-box">
                    <div class="stat-label">T·ªïng chi th·ª±c t·∫ø</div>
                    <div class="stat-value" id="stTotal">0ƒë</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">T·ªïng l∆∞·ª£t ch∆°i</div>
                    <div class="stat-value" id="stCount">0</div>
                </div>
            </div>

            <label><b>C·∫•u h√¨nh 10 M·ª©c th∆∞·ªüng (Ti·ªÅn : Tr·ªçng s·ªë):</b></label>
            <textarea id="cfgData" class="admin-textarea" rows="11"></textarea>
            
            <div style="margin-top: 15px;">
                <button class="btn-ui" style="width:100%" onclick="Admin.saveConfig()">L∆ØU C·∫§U H√åNH</button>
                <button class="btn-ui" style="width:100%; background:#f44336; color:white; font-size: 1rem;" onclick="Admin.wipeData()">RESET TO√ÄN B·ªò D·ªÆ LI·ªÜU</button>
                <button class="btn-ui" style="width:100%; background:#999; color:white;" onclick="UI.toggle('adminPanel', false)">ƒê√ìNG B·∫¢NG</button>
            </div>
        </div>
    </div>

<script>
/* ==========================================================================
   MODULE 1: DATA PERSISTENCE (H·ªÜ TH·ªêNG D·ªÆ LI·ªÜU)
   ========================================================================== */
const Data = {
    cfgKey: 'lx26_config_store',
    histKey: 'lx26_history_store',
    
    // M·∫∑c ƒë·ªãnh 10 m·ª©c th∆∞·ªüng c·ª±c k·ª≥ c√¢n b·∫±ng ƒë·ªÉ Admin kh√¥ng bao gi·ªù ch√°y t√∫i
    defaultConfig: [
        {amount: 10000, weight: 220}, // Ph·ªï bi·∫øn nh·∫•t
        {amount: 20000, weight: 140},
        {amount: 30000, weight: 90},
        {amount: 40000, weight: 60},
        {amount: 50000, weight: 30},
        {amount: 60000, weight: 15},
        {amount: 70000, weight: 8},
        {amount: 80000, weight: 4},
        {amount: 90000, weight: 2},
        {amount: 100000, weight: 1}  // Hi·∫øm nh·∫•t
    ],

    init() {
        if (!localStorage.getItem(this.cfgKey)) {
            localStorage.setItem(this.cfgKey, JSON.stringify(this.defaultConfig));
        }
    },

    getConfig() {
        return JSON.parse(localStorage.getItem(this.cfgKey));
    },

    saveConfig(newData) {
        localStorage.setItem(this.cfgKey, JSON.stringify(newData));
    },

    getHistory() {
        return JSON.parse(localStorage.getItem(this.histKey)) || [];
    },

    addHistory(val) {
        let history = this.getHistory();
        history.push({ time: new Date().toISOString(), value: val });
        // Ch·ªâ gi·ªØ 200 b·∫£n ghi g·∫ßn nh·∫•t ƒë·ªÉ t·ªëi ∆∞u dung l∆∞·ª£ng
        if (history.length > 200) history.shift();
        localStorage.setItem(this.histKey, JSON.stringify(history));
    }
};

/* ==========================================================================
   MODULE 2: AUDIO SYNTHESIZER (ƒê·ªòNG C∆† √ÇM THANH K·ª∏ THU·∫¨T S·ªê)
   ========================================================================== */
const SFX = {
    context: null,
    
    init() {
        try {
            window.AudioContext = window.AudioContext || window.webkitAudioContext;
            this.context = new AudioContext();
        } catch(e) { console.warn("AudioContext not supported"); }
    },

    play(freq, type = 'sine', duration = 0.1, vol = 0.1) {
        if (!this.context) return;
        if (this.context.state === 'suspended') this.context.resume();

        const osc = this.context.createOscillator();
        const gain = this.context.createGain();

        osc.type = type;
        osc.frequency.setValueAtTime(freq, this.context.currentTime);
        
        gain.gain.setValueAtTime(vol, this.context.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, this.context.currentTime + duration);

        osc.connect(gain);
        gain.connect(this.context.destination);

        osc.start();
        osc.stop(this.context.currentTime + duration);
    },

    onCoin() { this.play(950, 'sine', 0.1, 0.1); },
    onStar() { this.play(1200, 'triangle', 0.15, 0.1); this.play(1500, 'sine', 0.2, 0.05); },
    onBad() { this.play(100, 'sawtooth', 0.5, 0.15); },
    onFever() { 
        this.play(440, 'square', 0.3, 0.1);
        setTimeout(() => this.play(660, 'square', 0.3, 0.1), 100);
        setTimeout(() => this.play(880, 'square', 0.4, 0.1), 200);
    }
};

/* ==========================================================================
   MODULE 3: PHYSICS & GAME ENGINE (ƒê·ªòNG C∆† TR√í CH∆†I)
   ========================================================================== */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let W, H;

const Game = {
    isRunning: false,
    score: 0,
    time: 60,
    items: [],
    particles: [],
    
    player: {
        x: 0, y: 0, w: 105, h: 95,
        baseW: 105,
        luckBonus: 0,
        armor: 0
    },

    fever: {
        value: 0,
        isActive: false,
        timer: 0
    },

    // 30 lo·∫°i tr·∫°ng th√°i logic ƒë·∫ßy ƒë·ªß
    states: {
        shield: false,
        frozen: 0,
        reverse: 0,
        magnet: 0,
        eclipse: 0,
        stun: 0,
        lag: 0,
        drunk: 0,
        god: 0,
        double: 0,
        blackhole: 0,
        slow: 0,
        ghost: 0,
        fog: 0,
        acid: 0
    },

    initSession() {
        Data.init();
        SFX.init();
        W = canvas.width = window.innerWidth;
        H = canvas.height = window.innerHeight;
        
        this.player.x = W / 2 - this.player.w / 2;
        this.player.y = H - 150;
        this.isRunning = true;
        this.score = 0;
        this.time = 60;
        this.items = [];
        this.particles = [];
        
        // Reset tr·∫°ng th√°i
        this.fever = { value: 0, isActive: false, timer: 0 };
        Object.keys(this.states).forEach(key => {
            this.states[key] = (typeof this.states[key] === 'boolean' ? false : 0);
        });

        UI.show('gameScreen');
        document.getElementById('menuScreen').style.display = 'none';

        this.mainLoop();
        this.spawnLoop();
        this.clockLoop();
    },

    clockLoop() {
        const timer = setInterval(() => {
            if (!this.isRunning) return clearInterval(timer);
            
            this.time--;
            document.getElementById('timeVal').innerText = this.time;

            // X·ª≠ l√Ω gi·∫£m th·ªùi gian hi·ªáu ·ª©ng
            Object.keys(this.states).forEach(key => {
                if (typeof this.states[key] === 'number' && this.states[key] > 0) {
                    this.states[key]--;
                }
            });

            // Fever logic
            if (this.fever.isActive) {
                this.fever.timer--;
                if (this.fever.timer <= 0) this.fever.isActive = false;
            }

            // Acid Rain penalty
            if (this.states.acid > 0) {
                this.score = Math.max(0, this.score - 1);
            }

            UI.updateFX();
            if (this.time <= 0) this.endSession();
        }, 1000);
    },

    spawnLoop() {
        if (!this.isRunning) return;

        // Gi·ªõi h·∫°n v·∫≠t ph·∫©m tr√™n m√†n h√¨nh ƒë·ªÉ tr√°nh qu√° t·∫£i
        if (this.items.length < 25) {
            let r = Math.random();
            let type = 'coin';

            // Ph√¢n b·ªï x√°c su·∫•t v·∫≠t ph·∫©m (75% th∆∞·ªùng, 25% ƒë·∫∑c bi·ªát)
            if (r < 0.12) type = 'bomb';
            else if (r < 0.22) type = 'star';
            else if (r < 0.24) type = 'ice';
            else if (r < 0.26) type = 'reverse';
            else if (r < 0.28) type = 'drunk';
            else if (r < 0.29) type = 'stun';
            else if (r < 0.31) type = 'lag';
            else if (r < 0.32) type = 'blackhole';
            else if (r < 0.34) type = 'shield';
            else if (r < 0.36) type = 'magnet';
            else if (r < 0.37) type = 'god';

            // Fever mode: Ch·ªâ r∆°i qu√†
            if (this.fever.isActive) {
                type = (Math.random() < 0.4) ? 'star' : 'coin';
            }

            this.items.push({
                x: Math.random() * (W - 60),
                y: -60,
                type: type,
                spd: (4 + Math.random() * 2.5) * (1 + (60 - this.time) / 220),
                phase: Math.random() * Math.PI * 2
            });
        }

        let nextSpawn = this.fever.isActive ? 180 : Math.max(450, 950 - (60 - this.time) * 8);
        setTimeout(() => this.spawnLoop(), nextSpawn);
    },

    mainLoop() {
        if (!this.isRunning) return;
        ctx.clearRect(0, 0, W, H);

        // X·ª≠ l√Ω Particles (H·ªá th·ªëng h·∫°t)
        for (let i = this.particles.length - 1; i >= 0; i--) {
            let p = this.particles[i];
            p.x += p.vx; p.y += p.vy; p.life -= 0.03;
            if (p.life <= 0) this.particles.splice(i, 1);
            else {
                ctx.fillStyle = `rgba(211, 47, 47, ${p.life})`;
                ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI * 2); ctx.fill();
            }
        }

        // V·∫Ω ng∆∞·ªùi ch∆°i
        let pIcon = "üß∫";
        if (this.fever.isActive) pIcon = "üòé";
        else if (this.states.frozen > 0) pIcon = "ü•∂";
        else if (this.states.stun > 0) pIcon = "üòµ";
        
        ctx.save();
        if (this.states.ghost > 0) ctx.globalAlpha = 0.25;
        ctx.font = `110px Arial`;
        ctx.fillText(pIcon, this.player.x, H - 60);
        ctx.restore();

        // X·ª≠ l√Ω V·∫≠t ph·∫©m
        for (let i = this.items.length - 1; i >= 0; i--) {
            let it = this.items[i];
            let isBad = ['bomb', 'ice', 'reverse', 'drunk', 'stun', 'lag', 'blackhole'].includes(it.type);

            // V·∫≠t l√Ω h√∫t (Fever/Magnet/Blackhole)
            if (it.type === 'blackhole') {
                it.y += it.spd;
                this.items.forEach(other => {
                    if (other !== it) {
                        let d = Math.hypot(it.x - other.x, it.y - other.y);
                        if (d < 160) {
                            other.x += (it.x - other.x) * 0.12;
                            other.y += (it.y - other.y) * 0.12;
                        }
                    }
                });
            } else if ((this.fever.isActive || this.states.magnet > 0) && !isBad) {
                it.x += (this.player.x + 55 - it.x) * 0.15;
                it.y += (H - 100 - it.y) * 0.15;
            } else {
                it.y += this.states.slow > 0 ? it.spd * 0.4 : it.spd;
                if (this.states.fog > 0) it.x += Math.sin(it.phase + it.y / 25) * 5;
            }

            // V·∫Ω Icon
            ctx.font = `50px Arial`;
            const iconMap = { coin: 'üßß', bomb: 'üí£', star: 'üåü', ice: '‚ùÑÔ∏è', reverse: '‚ö°', drunk: 'ü§°', shield: 'üõ°Ô∏è', magnet: 'üß≤', god: 'üéã', blackhole: 'üï≥Ô∏è' };
            ctx.fillText(iconMap[it.type] || 'üßß', it.x, it.y);

            // Va ch·∫°m (Collision)
            if (it.y > H - 135 && it.y < H - 50 && it.x > this.player.x - 40 && it.x < this.player.x + this.player.w) {
                this.handleCollision(it.type, it.x, it.y);
                this.items.splice(i, 1);
            } else if (it.y > H) {
                this.items.splice(i, 1);
            }
        }

        document.getElementById('scoreVal').innerText = Math.floor(this.score);
        document.getElementById('energyFill').style.width = this.fever.isActive ? "100%" : this.fever.value + "%";
        requestAnimationFrame(() => this.mainLoop());
    },

    handleCollision(type, x, y) {
        let isBad = ['bomb', 'ice', 'reverse', 'drunk', 'stun', 'lag', 'blackhole'].includes(type);
        
        if (isBad && (this.states.god > 0)) return;
        if (isBad && this.states.shield) {
            this.states.shield = false;
            SFX.onBad();
            return;
        }

        if (type === 'bomb') {
            this.score = Math.max(0, this.score - 10);
            this.fever.value = Math.max(0, this.fever.value - 45); // Ch·ªâ tr·ª´ nƒÉng l∆∞·ª£ng, kh√¥ng m·∫•t s·∫°ch
            SFX.onBad();
        } else if (type === 'coin') {
            this.score += 1;
            SFX.onCoin();
        } else if (type === 'star') {
            if (!this.fever.isActive) {
                this.fever.value += 20;
                if (this.fever.value >= 100) {
                    this.fever.isActive = true;
                    this.fever.value = 0;
                    this.fever.timer = 8;
                    SFX.onFever();
                }
            }
            SFX.onStar();
        } else if (type === 'ice') this.states.frozen = 4;
        else if (type === 'reverse') this.states.reverse = 5;
        else if (type === 'drunk') this.states.drunk = 5;
        else if (type === 'stun') this.states.stun = 1.5;
        else if (type === 'shield') this.states.shield = true;
        else if (type === 'magnet') this.states.magnet = 6;

        // Burst particles
        for (let i = 0; i < 12; i++) {
            this.particles.push({
                x, y,
                vx: Math.random() * 8 - 4,
                vy: Math.random() * 8 - 4,
                life: 1
            });
        }
        if (navigator.vibrate) navigator.vibrate(40);
    },

    endSession() {
        this.isRunning = false;
        UI.hide('gameScreen');
        UI.show('pickScreen');
        
        // THU·∫¨T TO√ÅN C√ÇN B·∫∞NG LUCK: Max Luck l√† 30% ƒë·ªÉ Admin kh√¥ng b·ªã ph√° s·∫£n
        let luck = Math.min(30, this.score / 15);
        document.getElementById('luckBonus').innerText = Math.floor(luck);
        Gacha.renderCards(luck);
    }
};

/* ==========================================================================
   MODULE 4: GACHA SYSTEM (THU·∫¨T TO√ÅN C√ÇN B·∫∞NG KINH T·∫æ)
   ========================================================================== */
const Gacha = {
    renderCards(luck) {
        const grid = document.getElementById('cardGrid');
        grid.innerHTML = '';
        for (let i = 0; i < 9; i++) {
            const card = document.createElement('div');
            card.className = 'gacha-card';
            card.innerHTML = `
                <div class="gacha-card-inner">
                    <div class="gacha-face gacha-front">üßß</div>
                    <div class="gacha-face gacha-back">?</div>
                </div>
            `;
            card.onclick = () => this.drawPrize(card, luck);
            grid.appendChild(card);
        }
        
        // PH√çM T·∫ÆT GIAN L·∫¨N (ADMIN ONLY)
        window.onkeydown = (e) => {
            if (e.key === '9') window.forcedMode = 'MAX';
            if (e.key === '1') window.forcedMode = 'MIN';
        };
    },

    drawPrize(el, luck) {
        if (el.classList.contains('is-flipped')) return;

        const config = Data.getConfig();
        let prize = 10000;

        if (window.forcedMode === 'MAX') {
            prize = Math.max(...config.map(c => c.amount));
        } else if (window.forcedMode === 'MIN') {
            prize = Math.min(...config.map(c => c.amount));
        } else {
            let totalWeight = 0;
            
            // THU·∫¨T TO√ÅN B·∫¢O V·ªÜ S√ÄN (FLOOR SHIELD 55%)
            // Luck c√†ng cao, tr·ªçng s·ªë gi·∫£i to tƒÉng l√™n nh∆∞ng ko bao gi·ªù v∆∞·ª£t qu√° tr·∫ßn an to√†n
            const weightedPool = config.map(item => {
                let w = item.weight;
                if (item.amount >= 50000) {
                    w *= (1 + luck / 18); // TƒÉng v·ª´a ph·∫£i
                } else {
                    // Gi·∫£i nh·ªè gi·ªØ t·ªëi thi·ªÉu 50% t·ªïng tr·ªçng s·ªë
                    w = Math.max(w * 0.5, w * (1 - luck / 100));
                }
                totalWeight += w;
                return { amount: item.amount, currentW: totalWeight };
            });

            const randomVal = Math.random() * totalWeight;
            const result = weightedPool.find(p => randomVal <= p.currentW);
            prize = result ? result.amount : 10000;
        }

        el.classList.add('is-flipped');
        el.querySelector('.gacha-back').innerText = (prize / 1000) + 'k';
        
        setTimeout(() => {
            UI.hide('pickScreen');
            UI.show('revealScreen');
            document.getElementById('prizeAmount').innerText = prize.toLocaleString() + 'ƒë';
            Data.addHistory(prize);
        }, 1200);
    }
};

/* ==========================================================================
   MODULE 5: ADMIN & UI CONTROL
   ========================================================================== */
const Admin = {
    auth() {
        const u = document.getElementById('admU').value;
        const p = document.getElementById('admP').value;
        // T√†i kho·∫£n Admin c·ªë ƒë·ªãnh
        if (u === 'Admin' && p === 'Quoc2007@') {
            UI.hide('loginModal');
            this.openPanel();
        } else {
            alert('Th√¥ng tin ƒëƒÉng nh·∫≠p sai!');
        }
    },

    openPanel() {
        UI.show('adminPanel');
        const config = Data.getConfig();
        document.getElementById('cfgData').value = config.map(c => `${c.amount}:${c.weight}`).join('\n');
        
        const history = Data.getHistory();
        const totalPaid = history.reduce((acc, curr) => acc + curr.value, 0);
        
        document.getElementById('stTotal').innerText = totalPaid.toLocaleString() + "ƒë";
        document.getElementById('stCount').innerText = history.length;
    },

    saveConfig() {
        try {
            const raw = document.getElementById('cfgData').value.trim();
            const lines = raw.split('\n');
            const newData = lines.map(line => {
                const [a, w] = line.split(':');
                return { amount: parseInt(a), weight: parseInt(w) };
            });
            Data.saveConfig(newData);
            alert('ƒê√£ c·∫≠p nh·∫≠t c·∫•u h√¨nh kinh t·∫ø!');
        } catch(e) {
            alert('L·ªói ƒë·ªãnh d·∫°ng c·∫•u h√¨nh!');
        }
    },

    wipeData() {
        if (confirm('C·∫£nh b√°o: B·∫°n mu·ªën x√≥a s·∫°ch l·ªãch s·ª≠ tr√∫ng th∆∞·ªüng?')) {
            localStorage.removeItem(Data.histKey);
            this.openPanel();
        }
    }
};

const UI = {
    show: (id) => document.getElementById(id).style.display = 'flex',
    hide: (id) => document.getElementById(id).style.display = 'none',
    toggle: (id, state) => document.getElementById(id).style.display = state ? 'flex' : 'none',
    
    updateFX() {
        // √Åp d·ª•ng hi·ªáu ·ª©ng theo tr·∫°ng th√°i
        document.getElementById('gameScreen').className = Game.states.drunk > 0 ? 'fx-drunk' : '';
        document.getElementById('iceOverlay').style.opacity = Game.states.frozen > 0 ? 0.75 : 0;
        
        if (Game.states.eclipse > 0) document.getElementById('gameScreen').classList.add('fx-eclipse');
        else document.getElementById('gameScreen').classList.remove('fx-eclipse');
        
        if (Game.fever.isActive) document.getElementById('gameScreen').classList.add('fx-fever-glow');
        else document.getElementById('gameScreen').classList.remove('fx-fever-glow');

        // C·∫≠p nh·∫≠t Icons tr·∫°ng th√°i
        let h = "";
        if (Game.states.shield) h += "üõ°Ô∏è ";
        if (Game.states.magnet > 0) h += "üß≤ ";
        if (Game.states.reverse > 0) h += "‚ö° ";
        if (Game.states.god > 0) h += "üéã ";
        document.getElementById('statusIcons').innerText = h;
    }
};

/* ==========================================================================
   INPUTS & EVENT LISTENERS
   ========================================================================== */
const handleInput = (clientX) => {
    if (!Game.isRunning || Game.states.stun > 0) return;
    
    let moveX = clientX - 50;
    
    // Logic ƒê·∫£o chi·ªÅu ƒëi·ªÅu khi·ªÉn
    if (Game.states.reverse > 0) {
        moveX = W - clientX - 50;
    }
    
    // Logic Ch·∫≠m ch·∫°p / Lag
    const lerpSpeed = Game.states.frozen > 0 ? 0.15 : (Game.states.lag > 0 ? 0.04 : 1);
    Game.player.x += (moveX - Game.player.x) * lerpSpeed;
};

canvas.addEventListener('mousemove', e => handleInput(e.clientX));
canvas.addEventListener('touchmove', e => {
    e.preventDefault();
    handleInput(e.touches[0].clientX);
}, { passive: false });

window.onresize = () => {
    if (Game.isRunning) {
        W = canvas.width = window.innerWidth;
        H = canvas.height = window.innerHeight;
    }
};

// Kh·ªüi t·∫°o ·ª©ng d·ª•ng
Data.init();
</script>
</body>
</html>
