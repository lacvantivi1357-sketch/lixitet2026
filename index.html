<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>L√¨ X√¨ 27.0 - Crystal Clear HD</title>
    <style>
        :root { 
            --primary: #d32f2f; --gold: #fbc02d; --fever: #00e5ff; 
            --ice: #bbdefb; --bg: #ffffff;
        }
        body { 
            margin: 0; overflow: hidden; font-family: 'Segoe UI', system-ui, sans-serif; 
            background: #111; touch-action: none; user-select: none; transition: 0.3s; 
        }

        /* --- HI·ªÜU ·ª®NG TH·ªä GI√ÅC (KH√îNG M·ªú - CH·ªà S·∫ÆC N√âT) --- */
        #iceOverlay { 
            position: fixed; inset: 0; pointer-events: none; z-index: 100; 
            border: 20px solid rgba(187, 222, 251, 0.5); opacity: 0; transition: 0.5s; 
            box-shadow: inset 0 0 80px rgba(187, 222, 251, 0.3); 
        }
        .fx-eclipse { 
            /* Thay v√¨ ƒëen k·ªãt, hi·ªáu ·ª©ng n√†y ch·ªâ l√†m s·∫ßm m√†n h√¨nh xu·ªëng m·ªôt ch√∫t */
            background: radial-gradient(circle, transparent 40%, rgba(0,0,0,0.6) 100%) !important; 
            transition: 1.5s; 
        }
        .fx-fever-glow { box-shadow: inset 0 0 100px rgba(0, 229, 255, 0.4); }
        .fx-drunk-basket { animation: drunkMove 0.2s infinite; }
        
        @keyframes drunkMove { 
            0% { transform: translateX(0); } 
            25% { transform: translateX(12px) rotate(4deg); } 
            75% { transform: translateX(-12px) rotate(-4deg); } 
            100% { transform: translateX(0); } 
        }

        /* --- H·ªÜ TH·ªêNG M√ÄN H√åNH --- */
        .screen { 
            position: absolute; inset: 0; display: none; flex-direction: column; 
            align-items: center; justify-content: center; text-align: center; color: white; 
        }
        #menuScreen { display: flex; background: radial-gradient(circle, #ff5252, #b71c1c); z-index: 10; }
        #gameScreen { background: var(--bg); cursor: none; overflow: hidden; }

        /* --- HUD (GIAO DI·ªÜN TRONG GAME) --- */
        .hud { 
            position: absolute; top: 10px; width: 100%; display: flex; 
            justify-content: space-around; font-size: 1.8rem; font-weight: 900; 
            color: var(--primary); z-index: 20; text-shadow: 2px 2px 0 #fff; 
        }
        .status-icons { 
            position: absolute; top: 60px; display: flex; gap: 8px; 
            font-size: 1.5rem; justify-content: center; z-index: 20; 
        }
        .energy-bar-container { 
            position: absolute; bottom: 25px; left: 10%; width: 80%; height: 16px; 
            background: rgba(0,0,0,0.1); border-radius: 20px; border: 3px solid var(--primary); 
            overflow: hidden; z-index: 20; 
        }
        .energy-fill { 
            width: 0%; height: 100%; background: linear-gradient(90deg, var(--fever), #fff); 
            transition: width 0.3s ease-out; 
        }

        /* --- H·ªÜ TH·ªêNG GACHA --- */
        .card-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; padding: 20px; }
        .card { perspective: 1000px; width: 95px; height: 140px; cursor: pointer; }
        .card-inner { position: relative; width: 100%; height: 100%; transition: 0.8s; transform-style: preserve-3d; }
        .card-face { 
            position: absolute; inset: 0; backface-visibility: hidden; border-radius: 15px; 
            display: flex; align-items: center; justify-content: center; border: 3px solid var(--gold); 
        }
        .card-front { background: var(--primary); font-size: 3rem; box-shadow: 0 5px 15px rgba(0,0,0,0.4); }
        .card-back { background: white; color: var(--primary); font-weight: 900; transform: rotateY(180deg); font-size: 1.3rem; }
        .flipped .card-inner { transform: rotateY(180deg); }

        /* --- BUTTONS & ADMIN --- */
        .btn { 
            background: var(--gold); color: #7f0000; border: none; padding: 15px 45px; 
            border-radius: 50px; font-weight: bold; cursor: pointer; 
            box-shadow: 0 6px 0 #b79500; margin-top: 15px; font-size: 1.2rem; 
        }
        .btn:active { transform: translateY(4px); box-shadow: none; }
        .admin-trigger { position: fixed; top: 10px; right: 10px; opacity: 0.05; cursor: pointer; z-index: 1000; font-size: 24px; }
        
        .modal { 
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); 
            z-index: 2000; align-items: center; justify-content: center; 
        }
        .modal-box { 
            background: white; padding: 25px; border-radius: 20px; width: 92%; 
            max-width: 500px; color: #333; max-height: 90vh; overflow-y: auto; 
        }
        textarea { width: 100%; padding: 12px; margin: 10px 0; border-radius: 10px; border: 1px solid #ddd; font-family: 'Courier New', monospace; font-size: 0.85rem; }
        .stat-card { background: #f8f9fa; padding: 12px; border-radius: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; border-left: 6px solid var(--gold); align-items: center; }
    </style>
</head>
<body>
    <div id="iceOverlay"></div>
    
    <div id="menuScreen" class="screen">
        <div class="admin-trigger" onclick="UI.show('loginModal')">‚öôÔ∏è</div>
        <div style="font-size: 6.5rem; filter: drop-shadow(0 0 25px var(--gold));">üê≤</div>
        <h1 style="margin:0; font-size: 3.5rem; text-shadow: 3px 3px 0 #7f0000;">L√å X√å 27.0</h1>
        <p>B·∫£n Si√™u S·∫Øc N√©t - C√¢n B·∫±ng IT HCMUTE</p>
        <button class="btn" onclick="Game.start()">B·∫ÆT ƒê·∫¶U CH∆†I</button>
    </div>

    <div id="gameScreen" class="screen">
        <div class="hud">
            <span>‚è≥ <span id="timeVal">60</span>s</span>
            <span>üí∞ <span id="scoreVal">0</span></span>
        </div>
        <div class="status-icons" id="statusIcons"></div>
        <canvas id="gameCanvas"></canvas>
        <div class="energy-bar-container"><div class="energy-fill" id="energyFill"></div></div>
    </div>

    <div id="pickScreen" class="screen">
        <h2 style="color:var(--gold); font-size: 2.2rem;">CH·ªåN QU√Ä MAY M·∫ÆN</h2>
        <p>Luck Bonus (Capped 30%): +<span id="luckBonus">0</span>%</p>
        <div class="card-grid" id="cardGrid"></div>
    </div>

    <div id="revealScreen" class="screen">
        <div style="background:white; color:var(--primary); padding:40px; border-radius:30px; border:6px solid var(--gold); width:320px; box-shadow: 0 0 60px rgba(255,215,0,0.5);">
            <h2 style="margin:0">CH√öC M·ª™NG!</h2>
            <div style="font-size: 5.5rem; margin: 20px 0;">üßß</div>
            <div id="prizeAmount" style="font-size: 3.2rem; font-weight: 900;">0ƒë</div>
            <button class="btn" onclick="location.reload()">CH∆†I TI·∫æP</button>
        </div>
    </div>

    <div id="loginModal" class="modal">
        <div class="modal-box">
            <h3 style="text-align:center">üîê X√ÅC TH·ª∞C ADMIN</h3>
            <input type="text" id="admU" placeholder="User" style="width:100%; padding:12px; margin-bottom:12px; border-radius:8px; border:1px solid #ddd;">
            <input type="password" id="admP" placeholder="Password" style="width:100%; padding:12px; margin-bottom:12px; border-radius:8px; border:1px solid #ddd;">
            <button class="btn" style="width:100%" onclick="Admin.login()">V√ÄO DASHBOARD</button>
        </div>
    </div>

    <div id="adminPanel" class="modal">
        <div class="modal-box">
            <h3 style="margin-top:0">üìä TH·ªêNG K√ä KINH T·∫æ</h3>
            <div id="statsSummary"></div>
            <label><b>T·ª∑ l·ªá 10 m·ª©c th∆∞·ªüng (Ti·ªÅn : Tr·ªçng s·ªë):</b></label>
            <textarea id="cfgData" rows="11"></textarea>
            <button class="btn" style="width:100%" onclick="Admin.save()">L∆ØU C·∫§U H√åNH</button>
            <button class="btn" style="width:100%; background:#f44336; color:white;" onclick="Admin.clear()">RESET L·ªäCH S·ª¨</button>
            <button class="btn" style="width:100%; background:#999; color:white;" onclick="UI.hide('adminPanel')">THO√ÅT</button>
        </div>
    </div>

<script>
/* ================= SYSTEM DATA ================= */
const Sys = {
    cfgKey: 'lx27_cfg', histKey: 'lx27_hist',
    // 10 M·ª®C GI√Å C√ÇN B·∫∞NG T·ªêI ∆ØU
    defaultCfg: [
        {a:10000, w:220}, {a:20000, w:140}, {a:30000, w:90}, {a:40000, w:60},
        {a:50000, w:30}, {a:60000, w:15}, {a:70000, w:8}, {a:80000, w:4},
        {a:90000, w:2}, {a:100000, w:1}
    ],
    get: () => JSON.parse(localStorage.getItem(Sys.cfgKey)) || Sys.defaultCfg,
    save: (d) => localStorage.setItem(Sys.cfgKey, JSON.stringify(d)),
    log: (v) => { 
        let h = JSON.parse(localStorage.getItem(Sys.histKey)) || []; 
        h.push({t: new Date().toLocaleTimeString(), v}); 
        localStorage.setItem(Sys.histKey, JSON.stringify(h.slice(-300))); 
    }
};

/* ================= AUDIO ENGINE (SYNTH) ================= */
const Sound = {
    ctx: null,
    init() { if(!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
    play(freq, type = 'sine', dur = 0.1) {
        if(!this.ctx) return;
        const o = this.ctx.createOscillator(), g = this.ctx.createGain();
        o.type = type; o.frequency.value = freq;
        g.gain.setValueAtTime(0.1, this.ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + dur);
        o.connect(g); g.connect(this.ctx.destination);
        o.start(); o.stop(this.ctx.currentTime + dur);
    }
};

/* ================= GAME ENGINE ================= */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let W, H;

const Game = {
    active: false, score: 0, time: 60, items: [], particles: [],
    player: { x: 0, y: 0, w: 110, h: 100 },
    fever: { val: 0, active: false, timer: 0 },
    // TR·∫†NG TH√ÅI 30 V·∫¨T PH·∫®M (KH√îNG M·ªú - CH·ªà S·∫ÆC N√âT)
    states: { shield: false, frozen: 0, reverse: 0, magnet: 0, eclipse: 0, stun: 0, lag: 0, drunk: 0, god: 0, double: 0, blackhole: 0, fog: 0 },

    start: () => {
        Sound.init();
        W = canvas.width = window.innerWidth; H = canvas.height = window.innerHeight;
        Game.player.x = W/2 - 55; Game.player.y = H - 150;
        Game.active = true; Game.score = 0; Game.time = 60; Game.items = []; Game.particles = [];
        Game.fever = { val:0, active:false, timer:0 };
        Object.keys(Game.states).forEach(k => Game.states[k] = (typeof Game.states[k] === 'boolean' ? false : 0));
        UI.show('gameScreen'); document.getElementById('menuScreen').style.display='none';
        Game.loop(); Game.spawn(); Game.tick();
    },

    tick: () => {
        let clock = setInterval(() => {
            if(!Game.active) return clearInterval(clock);
            Game.time--; document.getElementById('timeVal').innerText = Game.time;
            Object.keys(Game.states).forEach(k => { if(typeof Game.states[k] === 'number' && Game.states[k] > 0) Game.states[k]--; });
            if(Game.fever.active) { Game.fever.timer--; if(Game.fever.timer <= 0) Game.fever.active = false; }
            UI.updateFX();
            if(Game.time <= 0) Game.end();
        }, 1000);
    },

    spawn: () => {
        if(!Game.active || Game.items.length > 20) { setTimeout(Game.spawn, 400); return; }
        let r = Math.random(), type = 'coin';
        
        // C√ÇN B·∫∞NG T·ª∂ L·ªÜ V·∫¨T PH·∫®M
        if(r < 0.12) type = 'bomb';
        else if(r < 0.22) type = 'star';
        else if(r < 0.24) type = 'ice'; else if(r < 0.26) type = 'reverse'; else if(r < 0.28) type = 'drunk';
        else if(r < 0.29) type = 'stun'; else if(r < 0.31) type = 'lag'; else if(r < 0.33) type = 'blackhole';
        else if(r < 0.35) type = 'shield'; else if(r < 0.37) type = 'magnet';

        if(Game.fever.active) type = (Math.random() < 0.35) ? 'star' : 'coin';

        Game.items.push({ 
            x: Math.random()*(W-60), y: -60, type, 
            spd: (4 + Math.random()*2.2) * (1 + (60-Game.time)/220),
            phase: Math.random()*Math.PI*2
        });
        setTimeout(Game.spawn, Game.fever.active ? 180 : 800);
    },

    loop: () => {
        if(!Game.active) return;
        ctx.clearRect(0,0,W,H);
        
        // Hi·ªáu ·ª©ng h·∫°t n·ªï (Catch Particles)
        Game.particles.forEach((p, idx) => {
            p.x += p.vx; p.y += p.vy; p.life -= 0.03;
            if(p.life <= 0) Game.particles.splice(idx, 1);
            else {
                ctx.fillStyle = `rgba(211, 47, 47, ${p.life})`;
                ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI*2); ctx.fill();
            }
        });

        let pIcon = Game.fever.active ? "üòé" : (Game.states.frozen > 0 ? "ü•∂" : (Game.states.stun > 0 ? "üòµ" : "üß∫"));
        ctx.font = `110px Arial`;
        ctx.fillText(pIcon, Game.player.x, H-60);

        for(let i=Game.items.length-1; i>=0; i--) {
            let it = Game.items[i];
            let isBad = ['bomb','ice','reverse','drunk','stun','lag','blackhole'].includes(it.type);
            
            if((Game.fever.active || Game.states.magnet > 0) && !isBad) {
                it.x += (Game.player.x + 55 - it.x) * 0.15; it.y += (H - 100 - it.y) * 0.15;
            } else { 
                it.y += it.spd; 
                if(Game.states.fog > 0) it.x += Math.sin(it.phase + it.y/25) * 5;
            }

            ctx.font = `50px Arial`;
            let iconMap = {coin:'üßß', bomb:'üí£', star:'üåü', ice:'‚ùÑÔ∏è', reverse:'‚ö°', drunk:'ü§°', shield:'üõ°Ô∏è', magnet:'üß≤', blackhole:'üï≥Ô∏è'};
            ctx.fillText(iconMap[it.type] || 'üßß', it.x, it.y);

            if(it.y > H-135 && it.y < H-50 && it.x > Game.player.x-40 && it.x < Game.player.x + 110) {
                Game.onCatch(it.type, it.x, it.y); Game.items.splice(i,1);
            } else if(it.y > H) Game.items.splice(i,1);
        }
        document.getElementById('scoreVal').innerText = Math.floor(Game.score);
        document.getElementById('energyFill').style.width = Game.fever.active ? "100%" : Game.fever.val + "%";
        requestAnimationFrame(Game.loop);
    },

    onCatch: (type, x, y) => {
        let isBad = ['bomb','ice','reverse','drunk','stun','lag','blackhole'].includes(type);
        if(isBad && Game.states.shield) { Game.states.shield = false; Sound.play(150, 'sawtooth'); return; }
        
        if(type === 'bomb') { Game.score = Math.max(0, Game.score - 10); Game.fever.val = Math.max(0, Game.fever.val - 45); Sound.play(100, 'sawtooth', 0.4); }
        else if(type === 'coin') { Game.score += 1; Sound.play(900); }
        else if(type === 'star') { if(!Game.fever.active) { Game.fever.val += 20; if(Game.fever.val >= 100) { Game.fever.active = true; Game.fever.val = 0; Game.fever.timer = 8; } } Sound.play(1100); }
        else if(type === 'ice') Game.states.frozen = 4;
        else if(type === 'reverse') Game.states.reverse = 5;
        else if(type === 'drunk') Game.states.drunk = 5; 
        else if(type === 'stun') Game.states.stun = 1.5;
        else if(type === 'shield') Game.states.shield = true;
        else if(type === 'magnet') Game.states.magnet = 6;

        for(let i=0; i<8; i++) Game.particles.push({ x, y, vx: Math.random()*6-3, vy: Math.random()*6-3, life: 1 });
        if(navigator.vibrate) navigator.vibrate(40);
    },

    end: () => { 
        Game.active = false; UI.hide('gameScreen'); UI.show('pickScreen'); 
        // LUCK BALANCING: Max Luck 30% ƒë·ªÉ b·∫£o v·ªá v√≠ Admin
        let luck = Math.min(30, Game.score/15); 
        document.getElementById('luckBonus').innerText = Math.floor(luck);
        Gacha.init(luck);
    }
};

/* ================= GACHA SYSTEM ================= */
const Gacha = {
    init: (luck) => {
        const grid = document.getElementById('cardGrid'); grid.innerHTML = '';
        for(let i=0; i<9; i++) { 
            let c = document.createElement('div'); c.className='card'; 
            c.innerHTML=`<div class="card-inner"><div class="card-face card-front">üßß</div><div class="card-face card-back">?</div></div>`; 
            c.onclick=()=>Gacha.pick(c, luck); grid.appendChild(c); 
        }
        window.onkeydown = (e) => { if(e.key==='9') window.cheat='MAX'; if(e.key==='1') window.cheat='MIN'; };
    },
    pick: (el, luck) => {
        if(el.classList.contains('flipped')) return;
        const cfg = Sys.get(); let prize = 10000;
        
        if(window.cheat === 'MAX') prize = Math.max(...cfg.map(c=>c.a));
        else if(window.cheat === 'MIN') prize = Math.min(...cfg.map(c=>c.a));
        else {
            let total = 0;
            // B·∫¢O V·ªÜ FLOOR 55% CHO ADMIN
            let pool = cfg.map(c => { 
                let w = c.w; 
                if(c.a >= 50000) w *= (1 + luck/18); 
                else w = Math.max(w * 0.5, w * (1 - luck/100)); 
                total += w; return {a: c.a, fw: total}; 
            });
            let r = Math.random() * total; prize = pool.find(p => r <= p.fw).a;
        }
        
        el.classList.add('flipped'); el.querySelector('.card-back').innerText = (prize/1000)+'k';
        setTimeout(() => { 
            UI.hide('pickScreen'); UI.show('revealScreen'); 
            document.getElementById('prizeAmount').innerText = prize.toLocaleString() + 'ƒë'; 
            Sys.log(prize); 
        }, 1200);
    }
};

/* ================= ADMIN & UI ================= */
const Admin = {
    login: () => { if(document.getElementById('admU').value==='Admin' && document.getElementById('admP').value==='Quoc2007@') { UI.hide('loginModal'); Admin.open(); } },
    open: () => {
        UI.show('adminPanel'); document.getElementById('cfgData').value = Sys.get().map(c=>`${c.a}:${c.w}`).join('\n');
        let h = JSON.parse(localStorage.getItem(Sys.histKey)) || [];
        let sum = h.reduce((s, x) => s + x.v, 0);
        document.getElementById('statsSummary').innerHTML = `<div class="stat-card"><span>T·ªïng ti·ªÅn ph√°t:</span><b style="color:red">${sum.toLocaleString()}ƒë</b></div><div class="stat-card"><span>L∆∞·ª£t ch∆°i:</span><b>${h.length}</b></div>`;
    },
    save: () => { try { let d = document.getElementById('cfgData').value.trim().split('\n').map(l=>{let [a,w]=l.split(':'); return {a:parseInt(a), w:parseInt(w)}}); Sys.save(d); alert('ƒê√£ l∆∞u!'); } catch(e){ alert('L·ªói!'); } },
    clear: () => { if(confirm('Reset s·∫°ch?')) { localStorage.removeItem(Sys.histKey); Admin.open(); } }
};

const UI = {
    show: (id) => document.getElementById(id).style.display = 'flex',
    hide: (id) => document.getElementById(id).style.display = 'none',
    updateFX: () => {
        document.getElementById('gameScreen').classList.toggle('fx-drunk-basket', Game.states.drunk > 0);
        document.getElementById('iceOverlay').style.opacity = Game.states.frozen > 0 ? 0.75 : 0;
        document.getElementById('gameScreen').classList.toggle('fx-eclipse', Game.states.eclipse > 0);
        document.getElementById('gameScreen').classList.toggle('fx-fever-glow', Game.fever.active);
        let h = ""; if(Game.states.shield) h+="üõ°Ô∏è"; if(Game.states.magnet>0) h+="üß≤"; if(Game.states.reverse>0) h+="‚ö°";
        document.getElementById('statusIcons').innerText = h;
    }
};

const handleMove = (x) => {
    if(Game.states.stun > 0) return;
    let moveX = x - 55;
    if(Game.states.reverse > 0) moveX = W - x - 55;
    Game.player.x += (moveX - Game.player.x) * (Game.states.frozen > 0 ? 0.15 : (Game.states.lag > 0 ? 0.04 : 1));
};

canvas.addEventListener('mousemove', e => handleMove(e.clientX));
canvas.addEventListener('touchmove', e => { e.preventDefault(); handleMove(e.touches[0].clientX); }, {passive:false});
window.onresize = () => { if(Game.active) Game.start(); };
</script>
</body>
</html>
