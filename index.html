<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>LÃ¬ XÃ¬ 130.0 - Neural Overdrive (Object Pooling)</title>
<style>
    /* =========================================
       1. SYSTEM ARCHITECTURE (CORE CSS)
       ========================================= */
    :root {
        --n-blue: #00f2ea; --n-red: #ff0050; --n-gold: #ffd700;
        --bg: #010103; --font: 'Fira Code', monospace;
    }

    * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
    body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: var(--bg); font-family: var(--font); color: white; }
    canvas { display: block; position: absolute; top: 0; left: 0; z-index: 1; }

    /* UI LAYER */
    #ui-kernel { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; display: flex; flex-direction: column; }
    .interactive { pointer-events: auto !important; }

    /* HUD SYSTEM */
    #hud { display: flex; justify-content: space-between; padding: 25px; width: 100%; position: absolute; top: 0; z-index: 20; }
    .hud-cell { border-left: 3px solid var(--n-blue); padding: 5px 15px; background: rgba(0, 30, 50, 0.3); backdrop-filter: blur(5px); }
    .hud-val { font-size: 1.8rem; font-weight: bold; text-shadow: 0 0 10px var(--n-blue); }

    /* OVERLAYS */
    .overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; backdrop-filter: blur(20px); z-index: 100; }
    .modal { background: rgba(10, 15, 25, 0.98); border: 1px solid var(--n-blue); width: 90%; max-width: 500px; padding: 30px; box-shadow: 0 0 100px rgba(0, 242, 234, 0.1); }
    
    /* BUTTONS */
    .btn-x { background: transparent; border: 1px solid var(--n-blue); color: var(--n-blue); padding: 16px; cursor: pointer; font-family: var(--font); font-weight: bold; text-transform: uppercase; letter-spacing: 2px; transition: 0.3s; width: 100%; margin-top: 10px; }
    .btn-x:hover { background: var(--n-blue); color: #000; box-shadow: 0 0 30px var(--n-blue); }

    /* GACHA */
    .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0; }
    .envelope { aspect-ratio: 2/3; background: var(--n-red); border: 2px solid var(--n-gold); display: flex; align-items: center; justify-content: center; font-size: 2rem; cursor: pointer; transition: 0.4s; position: relative; transform-style: preserve-3d; }
    .envelope.flipped { transform: rotateY(180deg); background: #fff; }
    .env-back { position: absolute; backface-visibility: hidden; transform: rotateY(180deg); color: var(--n-red); font-size: 1rem; font-weight: bold; }

    /* DEBUG MONITOR */
    #monitor { position: fixed; bottom: 10px; left: 10px; font-size: 10px; color: #0f0; opacity: 0.6; pointer-events: none; }
    .hidden { display: none !important; }
</style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <div id="ui-kernel">
        <div id="hud" class="hidden">
            <div class="hud-cell"><div id="ui-time" class="hud-val">60.0</div></div>
            <div class="hud-cell" style="border-color: var(--n-gold);"><div id="ui-score" class="hud-val">0</div></div>
        </div>

        <div id="screen-menu" class="overlay interactive" style="display: flex;">
            <div class="modal" style="text-align:center">
                <div style="font-size: 4.5rem; text-shadow: 0 0 40px var(--n-blue);">âš¡</div>
                <h1 style="margin: 10px 0;">NEURAL_OVERDRIVE</h1>
                <p style="color:#555; font-size: 0.7rem;">X-ENGINE V130.0 â€¢ OBJECT POOLING ENABLED</p>
                <button class="btn-x" onclick="Kernel.boot()">[ START_ENGINE ]</button>
                <button class="btn-x" style="border-color:#333; color:#333" onclick="alert('Admin: Admin / Quoc2007@')">[ CONFIG ]</button>
            </div>
        </div>

        <div id="screen-gacha" class="overlay interactive">
            <div class="modal">
                <h2 style="color:var(--n-gold); text-align:center">SELECT_QUANTUM_REWARD</h2>
                <div class="grid" id="gacha-grid"></div>
                <p id="ui-luck" style="text-align:center; font-size:0.8rem"></p>
            </div>
        </div>

        <div id="screen-result" class="overlay interactive">
            <div class="modal" style="text-align:center">
                <h1 style="color:var(--n-gold)">SYNC_COMPLETE</h1>
                <div style="font-size: 5rem; margin: 20px 0;">ðŸ§§</div>
                <h2 id="res-prize" style="font-size: 3rem; color: var(--n-blue);">0Ä‘</h2>
                <button class="btn-x" onclick="location.reload()">[ REBOOT ]</button>
            </div>
        </div>
    </div>

    <div id="monitor">FPS: 60 | POOL_ACTIVE: 0 | GC_PRESSURE: LOW</div>

<script>
/**
 * ============================================================================
 * OBJECT POOLING SYSTEM (Há»‡ thá»‘ng tá»‘i Æ°u bá»™ nhá»›)
 * ============================================================================
 */
class ObjectPool {
    constructor(createFn, size = 100) {
        this.createFn = createFn;
        this.pool = Array.from({ length: size }, () => ({ obj: createFn(), active: false }));
    }

    acquire() {
        const item = this.pool.find(i => !i.active);
        if (item) {
            item.active = true;
            return item.obj;
        }
        // Náº¿u háº¿t pool, táº¡o thÃªm (giáº£m thiá»ƒu nhÆ°ng váº«n dá»± phÃ²ng)
        const newObj = this.createFn();
        this.pool.push({ obj: newObj, active: true });
        return newObj;
    }

    release(obj) {
        const item = this.pool.find(i => i.obj === obj);
        if (item) item.active = false;
    }

    getActive() {
        return this.pool.filter(i => i.active).map(i => i.obj);
    }
}

/* ============================================================================
   ENGINE MODULES
   ============================================================================ */

class Vec2 {
    constructor(x=0, y=0) { this.set(x, y); }
    set(x, y) { this.x = x; this.y = y; return this; }
    add(v) { this.x += v.x; this.y += v.y; return this; }
    mult(s) { this.x *= s; this.y *= s; return this; }
    static dist(v1, v2) { return Math.hypot(v1.x - v2.x, v1.y - v2.y); }
}

const AudioSys = {
    ctx: null, master: null,
    init() {
        if(this.ctx) return;
        this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        this.master = this.ctx.createGain(); this.master.gain.value = 0.1;
        this.master.connect(this.ctx.destination);
    },
    play(f, t, d, v=1) {
        const now = this.ctx.currentTime;
        const o = this.ctx.createOscillator(); const g = this.ctx.createGain();
        o.type = t; o.frequency.setValueAtTime(f, now);
        g.gain.setValueAtTime(0, now);
        g.gain.linearRampToValueAtTime(v, now + 0.01);
        g.gain.exponentialRampToValueAtTime(0.001, now + d);
        o.connect(g); g.connect(this.master);
        o.start(); o.stop(now + d + 0.1);
    }
};

const Paint = {
    lixi(ctx, x, y, scale=1) {
        ctx.save(); ctx.translate(x, y); ctx.scale(scale, scale);
        ctx.shadowBlur = 15; ctx.shadowColor = "#ff0050";
        ctx.fillStyle = "#d0021b"; ctx.beginPath(); ctx.roundRect(-25, -35, 50, 70, 6); ctx.fill();
        ctx.strokeStyle = "#ffd700"; ctx.lineWidth = 2; ctx.stroke();
        ctx.restore();
    },
    bomb(ctx, x, y, time) {
        ctx.save(); ctx.translate(x, y);
        ctx.fillStyle = "#111"; ctx.shadowBlur = 20; ctx.shadowColor = "#ff0050";
        ctx.beginPath(); ctx.arc(0, 5, 22, 0, Math.PI*2); ctx.fill();
        ctx.strokeStyle = "#ff0050"; ctx.stroke();
        ctx.restore();
    }
};

/* ============================================================================
   CORE KERNEL
   ============================================================================ */
const Kernel = {
    cvs: document.getElementById('gameCanvas'),
    ctx: document.getElementById('gameCanvas').getContext('2d'),
    running: false, score: 0, time: 60,
    player: { pos: new Vec2(), tx: 0, w: 120, h: 80 },
    lastT: 0, fps: 0,

    // POOLS
    particlePool: new ObjectPool(() => ({ pos: new Vec2(), vel: new Vec2(), life: 0, color: '' }), 200),
    entityPool: new ObjectPool(() => ({ pos: new Vec2(), vy: 0, type: '', active: false }), 50),

    boot() {
        AudioSys.init();
        this.resize();
        window.onresize = () => this.resize();
        document.addEventListener('mousemove', e => this.player.tx = e.clientX);
        document.addEventListener('touchmove', e => { e.preventDefault(); this.player.tx = e.touches[0].clientX; }, {passive:false});
        this.start();
    },

    resize() {
        this.w = this.cvs.width = window.innerWidth;
        this.h = this.cvs.height = window.innerHeight;
        this.player.pos.y = this.h - 120;
    },

    start() {
        this.running = true; this.score = 0; this.time = 60;
        UI.screen('hud', true); UI.closeAll();
        this.lastT = performance.now();
        requestAnimationFrame((t) => this.loop(t));
        this.spawner();
    },

    loop(t) {
        if(!this.running) return;
        const dt = (t - this.lastT) / 1000;
        this.lastT = t;
        this.fps = Math.round(1/dt);

        this.ctx.fillStyle = "#010103";
        this.ctx.fillRect(0, 0, this.w, this.h);
        
        // Player Smoothing
        this.player.pos.x += (this.player.tx - this.player.pos.x) * 0.2;

        // Render Player
        this.ctx.save();
        this.ctx.translate(this.player.pos.x, this.player.pos.y);
        this.ctx.strokeStyle = "#00f2ea"; this.ctx.lineWidth = 3; this.ctx.shadowBlur = 20; this.ctx.shadowColor = "#00f2ea";
        this.ctx.strokeRect(-60, -40, 120, 80);
        this.ctx.restore();

        // Update & Render Entities (from Pool)
        this.entityPool.pool.forEach(item => {
            if(!item.active) return;
            const e = item.obj;
            e.pos.y += e.vy * (1 + (60 - this.time)/100);

            if(e.type === 'bomb') Paint.bomb(this.ctx, e.pos.x, e.pos.y, t);
            else Paint.lixi(this.ctx, e.pos.x, e.pos.y);

            if(Vec2.dist(e.pos, this.player.pos) < 70) {
                this.hit(e); item.active = false;
            } else if(e.pos.y > this.h + 50) item.active = false;
        });

        // Update & Render Particles (from Pool)
        this.particlePool.pool.forEach(item => {
            if(!item.active) return;
            const p = item.obj;
            p.pos.add(p.vel);
            p.life -= 0.02;
            if(p.life <= 0) { item.active = false; return; }
            this.ctx.fillStyle = p.color; this.ctx.globalAlpha = p.life;
            this.ctx.fillRect(p.pos.x, p.pos.y, 4, 4);
        });
        this.ctx.globalAlpha = 1;

        this.time -= dt;
        document.getElementById('ui-time').innerText = Math.max(0, this.time).toFixed(1);
        document.getElementById('monitor').innerText = `FPS: ${this.fps} | ENT_ACTIVE: ${this.entityPool.getActive().length} | PART_ACTIVE: ${this.particlePool.getActive().length}`;

        if(this.time <= 0) this.over();
        requestAnimationFrame((t) => this.loop(t));
    },

    hit(e) {
        const color = e.type === 'bomb' ? '#ff0050' : '#ffd700';
        for(let i=0; i<15; i++) {
            const p = this.particlePool.acquire();
            p.pos.set(e.pos.x, e.pos.y);
            p.vel.set((Math.random()-0.5)*10, (Math.random()-0.5)*10);
            p.life = 1.0; p.color = color;
        }

        if(e.type === 'bomb') {
            this.score = Math.max(0, this.score - 20);
            AudioSys.play(100, 'sawtooth', 0.3);
            if(navigator.vibrate) navigator.vibrate(200);
        } else {
            this.score += 10;
            AudioSys.play(1000 + (this.score % 500), 'sine', 0.1);
        }
        document.getElementById('ui-score').innerText = this.score;
    },

    spawner() {
        if(!this.running) return;
        const e = this.entityPool.acquire();
        e.pos.set(Math.random()*(this.w-100)+50, -50);
        e.vy = 5;
        e.type = Math.random() < 0.2 ? 'bomb' : 'gift';
        setTimeout(() => this.spawner(), 500);
    },

    over() {
        this.running = false;
        UI.screen('hud', false);
        UI.open('gacha');
        const luck = Math.min(40, this.score / 20);
        document.getElementById('ui-luck').innerText = `LUCK_MODIFIER: +${luck.toFixed(1)}%`;
        Gacha.init(luck);
    }
};

/* ============================================================================
   GACHA & UI
   ============================================================================ */
const Gacha = {
    init(luck) {
        const g = document.getElementById('gacha-grid'); g.innerHTML = '';
        for(let i=0; i<9; i++) {
            const el = document.createElement('div'); el.className = 'envelope';
            el.innerHTML = `<div class="env-back">?</div><div style="backface-visibility:hidden">ðŸ§§</div>`;
            el.onclick = () => {
                if(el.classList.contains('flipped')) return;
                const p = this.roll(luck);
                el.classList.add('flipped');
                el.querySelector('.env-back').innerText = (p/1000) + 'k';
                AudioSys.play(880, 'sine', 0.5);
                setTimeout(() => UI.result(p), 1200);
            };
            g.appendChild(el);
        }
    },
    roll(luck) {
        const t = [ {v:100000, w:1}, {v:50000, w:10}, {v:20000, w:40}, {v:10000, w:150} ];
        let tot = 0;
        const pool = t.map(i => {
            let w = i.w;
            if(i.v >= 50000) w *= (1 + luck/10);
            else w = Math.max(w * 0.65, w * (1 - luck/100));
            tot += w; return { v: i.v, cw: tot };
        });
        const r = Math.random() * tot;
        return pool.find(p => r <= p.cw).v;
    }
};

const UI = {
    open(id) { document.getElementById(`screen-${id}`).style.display = 'flex'; },
    closeAll() { document.querySelectorAll('.overlay').forEach(o => o.style.display = 'none'); },
    screen(id, s) { document.getElementById(id).className = s ? '' : 'hidden'; },
    result(p) { this.closeAll(); this.open('result'); document.getElementById('res-prize').innerText = p.toLocaleString() + "Ä‘"; }
};

window.onload = () => Kernel.resize();
</script>
</body>
</html>
