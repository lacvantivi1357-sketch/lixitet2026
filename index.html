<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>L√¨ X√¨ 5.0 Pro Max (Fixed)</title>
    <style>
        :root { --primary: #e53935; --gold: #ffd700; --dark: #212121; }
        body {
            margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif;
            background: #ffebee; touch-action: none; user-select: none;
        }

        /* --- SCREENS --- */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column;
            justify-content: center; align-items: center; text-align: center;
        }

        /* 1. MENU */
        #menuScreen { background: radial-gradient(circle, #ffcdd2 0%, #e57373 100%); }
        .logo { font-size: 4rem; text-shadow: 0 5px 10px rgba(0,0,0,0.2); animation: float 3s infinite; }
        
        /* 2. GAME UI */
        #gameScreen { cursor: none; transition: filter 0.2s; }
        .hud-bar {
            position: absolute; top: 10px; left: 10px; right: 10px;
            display: flex; justify-content: space-between;
            font-size: 1.5rem; font-weight: 900; color: var(--primary); z-index: 10;
        }
        .fever-bar-container {
            position: absolute; bottom: 20px; left: 10%; width: 80%; height: 10px;
            background: rgba(0,0,0,0.2); border-radius: 5px; overflow: hidden;
        }
        .fever-fill { width: 0%; height: 100%; background: linear-gradient(90deg, #ffeb3b, #ff9800); transition: width 0.2s; }
        
        /* FEVER EFFECT */
        .fever-active { animation: rainbow-bg 0.5s infinite; }
        @keyframes rainbow-bg { 
            0% { filter: hue-rotate(0deg); } 100% { filter: hue-rotate(360deg); } 
        }

        /* 3. PICK SCREEN */
        #pickScreen { background: #b71c1c; }
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 20px; }
        .bag-wrapper { perspective: 1000px; width: 90px; height: 120px; cursor: pointer; }
        .bag-inner {
            position: relative; width: 100%; height: 100%; text-align: center;
            transition: transform 0.8s; transform-style: preserve-3d;
        }
        .bag-front, .bag-back {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
            border-radius: 10px; display: flex; justify-content: center; align-items: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .bag-front { background: url('https://cdn-icons-png.flaticon.com/512/6409/6409528.png') center/contain no-repeat; background-color: #fff; }
        .bag-back { 
            background: linear-gradient(135deg, #fff 0%, #ffd700 100%); 
            transform: rotateY(180deg); color: #d32f2f; font-weight: bold; font-size: 1.1rem; border: 2px solid var(--gold);
        }
        .bag-wrapper.flipped .bag-inner { transform: rotateY(180deg); }

        /* 4. REVEAL (BIG CARD) */
        #revealScreen { background: rgba(0,0,0,0.9); z-index: 100; }
        .card {
            width: 300px; height: 450px; background: white; border-radius: 20px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 0 50px var(--gold);
            animation: cardPop 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 5px solid var(--gold);
        }
        .card-amount { font-size: 3.5rem; color: #d32f2f; font-weight: 900; margin: 20px 0; }
        
        /* COMMON */
        .btn {
            background: var(--primary); color: white; border: none; padding: 12px 30px;
            font-size: 1.2rem; border-radius: 30px; margin-top: 15px; cursor: pointer;
            box-shadow: 0 4px 0 #8e0000;
        }
        .btn:active { transform: translateY(4px); box-shadow: none; }
        .admin-btn { position: fixed; top: 10px; right: 10px; opacity: 0.3; cursor: pointer; z-index: 2000; font-size: 24px;}

        /* MODALS */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 3000; justify-content: center; align-items: center; }
        .modal-box { background: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; max-height: 80vh; overflow-y: auto; }
        
        /* History Table */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f2f2f2; }

        @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }
        @keyframes cardPop { from{transform:scale(0) rotate(-10deg)} to{transform:scale(1) rotate(0)} }
    </style>
</head>
<body>

    <div id="menuScreen" class="screen" style="display: flex;">
        <div class="admin-btn" onclick="openLogin()">‚öôÔ∏è</div>
        <div class="logo">üßß</div>
        <h1 style="color: #b71c1c; margin: 0;">L√å X√å 5.0</h1>
        <p>Phi√™n b·∫£n: Gacha Pro Max (Fixed)</p>
        <button class="btn" onclick="Game.init()">B·∫ÆT ƒê·∫¶U</button>
    </div>

    <div id="gameScreen" class="screen">
        <div class="hud-bar">
            <span>‚è∞ <span id="uiTime">60</span></span>
            <span>üî• <span id="uiScore">0</span></span>
        </div>
        <div class="fever-bar-container"><div class="fever-fill" id="feverBar"></div></div>
        <canvas id="cvs"></canvas>
    </div>

    <div id="pickScreen" class="screen">
        <h2 style="color:white">CH·ªåN V·∫¨N MAY</h2>
        <p style="color:#ffd700">ƒêi·ªÉm s·ªë: <span id="finalScore">0</span> (TƒÉng <span id="luckPc">0</span>% t·ª∑ l·ªá)</p>
        <div class="grid" id="grid"></div>
    </div>

    <div id="revealScreen" class="screen">
        <div class="card">
            <h3 style="color:#666">PH·∫¶N TH∆Ø·ªûNG C·ª¶A B√â</h3>
            <div style="font-size: 4rem;">üéâ</div>
            <div class="card-amount" id="finalAmount">0ƒë</div>
            <p style="color:#999; font-size: 0.8rem;">Ch√∫c b√© nƒÉm m·ªõi vui v·∫ª!</p>
            <button class="btn" onclick="location.reload()">CH∆†I L·∫†I</button>
        </div>
    </div>

    <div id="loginModal" class="modal">
        <div class="modal-box">
            <h3>ƒêƒÉng nh·∫≠p Admin</h3>
            <input type="text" id="admUser" placeholder="User" style="width:100%; padding:8px; margin:5px 0;">
            <input type="password" id="admPass" placeholder="Pass" style="width:100%; padding:8px; margin:5px 0;">
            <button class="btn" onclick="Admin.login()" style="width:100%">V√†o</button>
            <button class="btn" onclick="closeModal('loginModal')" style="background:#ccc; width:100%">ƒê√≥ng</button>
        </div>
    </div>

    <div id="panelModal" class="modal">
        <div class="modal-box">
            <h3>‚öôÔ∏è Qu·∫£n L√Ω</h3>
            
            <h4>1. C·∫•u h√¨nh T·ª∑ l·ªá</h4>
            <textarea id="cfgData" rows="4" style="width:100%"></textarea>
            <button class="btn" onclick="Admin.saveCfg()" style="font-size:0.8rem; padding:5px 10px;">L∆∞u C·∫•u H√¨nh</button>
            
            <h4>2. L·ªãch s·ª≠ Tr√∫ng Th∆∞·ªüng</h4>
            <div style="max-height: 150px; overflow-y: auto;">
                <table id="historyTable">
                    <thead><tr><th>Th·ªùi gian</th><th>Ti·ªÅn</th></tr></thead>
                    <tbody id="historyBody"></tbody>
                </table>
            </div>
            <button class="btn" onclick="Admin.clearHistory()" style="background:#555; font-size:0.8rem; padding:5px 10px;">X√≥a L·ªãch S·ª≠</button>
            
            <hr>
            <button class="btn" onclick="closeModal('panelModal')" style="background:#ccc; width:100%">ƒê√≥ng Panel</button>
        </div>
    </div>

<script>
    /* --- SYSTEM: CONFIG & STORAGE --- */
    const Sys = {
        defaultCfg: [{a:10000, w:100}, {a:20000, w:40}, {a:50000, w:15}, {a:100000, w:5}, {a:200000, w:1}, {a:500000, w:0}],
        getCfg: () => JSON.parse(localStorage.getItem('lx5_cfg') || JSON.stringify(Sys.defaultCfg)),
        setCfg: (d) => localStorage.setItem('lx5_cfg', JSON.stringify(d)),
        getHistory: () => JSON.parse(localStorage.getItem('lx5_hist') || '[]'),
        addHistory: (amt) => {
            let h = Sys.getHistory();
            h.unshift({ time: new Date().toLocaleTimeString(), amt: amt });
            if(h.length > 50) h.pop();
            localStorage.setItem('lx5_hist', JSON.stringify(h));
        },
        clearHistory: () => localStorage.removeItem('lx5_hist')
    };

    /* --- SYSTEM: AUDIO (Synth) --- */
    const Audio = {
        ctx: null,
        init: () => Audio.ctx = new (window.AudioContext || window.webkitAudioContext)(),
        play: (type, f, d) => {
            if(!Audio.ctx) return;
            let o = Audio.ctx.createOscillator(), g = Audio.ctx.createGain();
            o.type=type; o.frequency.value=f;
            g.gain.setValueAtTime(0.1, Audio.ctx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.01, Audio.ctx.currentTime+d);
            o.connect(g); g.connect(Audio.ctx.destination);
            o.start(); o.stop(Audio.ctx.currentTime+d);
        }
    };

    /* --- GAME ENGINE --- */
    const cvs = document.getElementById('cvs');
    const ctx = cvs.getContext('2d');
    let W, H;

    const Game = {
        active: false, score: 0, time: 60, items: [],
        player: {x:0, w:80},
        fever: { val: 0, active: false, timer: 0 },
        
        init: () => {
            Audio.init();
            document.getElementById('menuScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
            Game.resize();
            Game.active = true; Game.score = 0; Game.time = 60; Game.items = [];
            Game.fever = {val:0, active:false, timer:0};
            
            Game.loop();
            Game.spawn();
            
            // Timer loop
            let tLoop = setInterval(() => {
                if(!Game.active) { clearInterval(tLoop); return; }
                Game.time--;
                document.getElementById('uiTime').innerText = Game.time;
                if(Game.time<=0) { clearInterval(tLoop); Game.end(); }
                
                // Fever Logic
                if(Game.fever.active) {
                    Game.fever.timer--;
                    if(Game.fever.timer <= 0) {
                        Game.fever.active = false;
                        document.getElementById('gameScreen').classList.remove('fever-active');
                    }
                }
            }, 1000);
        },

        resize: () => { W=cvs.width=window.innerWidth; H=cvs.height=window.innerHeight; Game.player.y=H-100; Game.player.x=W/2-40; },

        spawn: () => {
            if(!Game.active) return;
            let type = Math.random() < 0.2 ? 'bomb' : 'coin';
            if(Game.fever.active) type = 'coin'; // No bombs in fever
            
            Game.items.push({ x:Math.random()*(W-50), y:-50, type:type, spd: 4+Math.random()*4 });
            let rate = Game.fever.active ? 150 : (Game.time < 30 ? 400 : 800); // Super fast in fever
            setTimeout(Game.spawn, rate);
        },

        loop: () => {
            if(!Game.active) return;
            ctx.clearRect(0,0,W,H);
            
            // Player
            ctx.font = "60px Arial";
            ctx.fillText(Game.fever.active ? "üòé" : "üß∫", Game.player.x, Game.player.y+60);

            // Items
            for(let i=Game.items.length-1; i>=0; i--){
                let it = Game.items[i];
                
                // Magnet Logic in Fever
                if(Game.fever.active && it.type==='coin'){
                    let dx = (Game.player.x+20)-it.x, dy = (Game.player.y+20)-it.y;
                    it.x += dx*0.1; it.y += dy*0.1;
                } else {
                    it.y += it.spd;
                }

                ctx.font = "40px Arial";
                ctx.fillText(it.type==='bomb'?"üí£":"üßß", it.x, it.y);

                // Collision
                if(it.y > Game.player.y && it.y < Game.player.y+60 && it.x > Game.player.x-40 && it.x < Game.player.x+80){
                    if(it.type==='bomb'){
                        if(!Game.fever.active) {
                            Game.score -= 5; Audio.play('sawtooth',100,0.5);
                            Game.fever.val = 0; // Reset fever on bomb
                        }
                    } else {
                        Game.score += 1; Audio.play('sine',880,0.1);
                        // Add Fever
                        if(!Game.fever.active) {
                            Game.fever.val += 10;
                            if(Game.fever.val >= 100) {
                                Game.fever.active = true;
                                Game.fever.val = 0; // --- FIX 1: RESET NƒÇNG L∆Ø·ª¢NG V·ªÄ 0 ---
                                Game.fever.timer = 5; 
                                document.getElementById('gameScreen').classList.add('fever-active');
                                Audio.play('square', 600, 0.5);
                            }
                        }
                    }
                    Game.items.splice(i,1);
                }
            }
            
            document.getElementById('uiScore').innerText = Game.score;
            document.getElementById('feverBar').style.width = Game.fever.active ? "100%" : Game.fever.val + "%";
            requestAnimationFrame(Game.loop);
        },

        end: () => {
            Game.active = false;
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('pickScreen').style.display = 'flex';
            document.getElementById('finalScore').innerText = Game.score;
            
            // --- FIX 2a: TƒÉng c√°ch t√≠nh ƒëi·ªÉm may m·∫Øn (1 ƒëi·ªÉm = 1%) ---
            let luck = Math.min(100, Game.score); 
            document.getElementById('luckPc').innerText = luck;
            Picker.setup(luck);
        }
    };

    /* --- PICKER ENGINE (GACHA) --- */
    const Picker = {
        setup: (luck) => {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            for(let i=0; i<9; i++){
                let wrap = document.createElement('div');
                wrap.className = 'bag-wrapper';
                wrap.innerHTML = `
                    <div class="bag-inner">
                        <div class="bag-front"></div>
                        <div class="bag-back">?</div>
                    </div>
                `;
                wrap.onclick = () => Picker.open(wrap, luck);
                grid.appendChild(wrap);
            }
            // --- SECRET KEY LISTENER ---
            window.forcedOutcome = null; // Reset
            window.onkeydown = (e) => {
                if(e.key === '9') { window.forcedOutcome = 'MAX'; console.log('Secret: MAX'); }
                if(e.key === '1') { window.forcedOutcome = 'MIN'; console.log('Secret: MIN'); }
            };
        },

        open: (el, luck) => {
            if(el.classList.contains('flipped')) return;
            
            // 1. Calculate Prize
            let prize = Picker.calc(luck);
            
            // 2. Visual Flip
            el.classList.add('flipped');
            el.querySelector('.bag-back').innerText = (prize/1000) + 'k';
            
            // 3. Audio
            Audio.play('triangle', 600, 0.1);

            // 4. Reveal Big Card after delay
            setTimeout(() => {
                document.getElementById('revealScreen').style.display = 'flex';
                document.getElementById('finalAmount').innerText = prize.toLocaleString() + ' VNƒê';
                Sys.addHistory(prize);
                Audio.play('square', 400, 0.1); 
                setTimeout(()=>Audio.play('square', 600, 0.1), 100);
                setTimeout(()=>Audio.play('square', 800, 0.4), 200);
            }, 1000);
        },

        calc: (luck) => {
            // Check Secret Keys First
            const cfg = Sys.getCfg();
            if(window.forcedOutcome === 'MAX') return Math.max(...cfg.map(c=>c.a));
            if(window.forcedOutcome === 'MIN') return Math.min(...cfg.map(c=>c.a));

            // Standard Luck Logic
            let totalW = 0;
            let pool = cfg.map(c => {
                let w = c.w;
                if(c.a >= 50000) {
                    // --- FIX 2b: Boost m·∫°nh t·ª∑ l·ªá gi·∫£i to (T·ªëi ƒëa nh√¢n 4 l·∫ßn) ---
                    w = w * (1 + (luck * 3)/100); 
                }
                totalW += w;
                return {...c, finalW: w};
            });
            let r = Math.random() * totalW;
            for(let p of pool) {
                if(r < p.finalW) return p.a;
                r -= p.finalW;
            }
            return cfg[0].a;
        }
    };

    /* --- ADMIN --- */
    const Admin = {
        login: () => {
            if(document.getElementById('admUser').value === 'Admin' && document.getElementById('admPass').value === 'Quoc2007@'){
                closeModal('loginModal');
                Admin.loadPanel();
                document.getElementById('panelModal').style.display = 'flex';
            } else alert('Sai th√¥ng tin');
        },
        loadPanel: () => {
            document.getElementById('cfgData').value = Sys.getCfg().map(c=>`${c.a}:${c.w}`).join('\n');
            const h = Sys.getHistory();
            const tbody = document.getElementById('historyBody');
            tbody.innerHTML = h.map(x => `<tr><td>${x.time}</td><td>${parseInt(x.amt).toLocaleString()}</td></tr>`).join('');
        },
        saveCfg: () => {
            try {
                let d = document.getElementById('cfgData').value.split('\n').map(l=>{
                    let [a,w] = l.split(':'); return {a:parseInt(a), w:parseInt(w)};
                });
                Sys.setCfg(d); alert('ƒê√£ l∆∞u!');
            } catch(e) { alert('L·ªói ƒë·ªãnh d·∫°ng'); }
        },
        clearHistory: () => { Sys.clearHistory(); Admin.loadPanel(); }
    };
    
    function openLogin(){document.getElementById('loginModal').style.display='flex'}
    function closeModal(id){document.getElementById(id).style.display='none'}
    
    // Inputs
    window.onresize = Game.resize;
    cvs.addEventListener('mousemove',e=>Game.player.x=e.clientX-40);
    cvs.addEventListener('touchmove',e=>{e.preventDefault();Game.player.x=e.touches[0].clientX-40},{passive:false});

</script>
</body>
</html>
