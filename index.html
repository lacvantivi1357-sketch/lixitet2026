<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>L√¨ X√¨ 500.0 - Titan Framework HCMUTE</title>
<style>
    /* ========================================================================
       1. CSS SYSTEM - THEME: ANCIENT ROYAL LUNAR
       ======================================================================== */
    :root {
        --c-red: #8e0d0d; --c-gold: #ffd700; --c-wood: #3e2723;
        --c-neon-blue: #00f2ea; --c-neon-green: #39ff14;
        --font-main: 'Segoe UI', 'Palatino Linotype', serif;
    }

    * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; outline: none; }
    
    body, html { 
        margin: 0; padding: 0; width: 100%; height: 100%; 
        overflow: hidden; background: #050101; 
        font-family: var(--font-main); color: white;
    }

    canvas { display: block; position: absolute; top: 0; left: 0; z-index: 1; }

    /* UI LAYER STACK */
    #ui-layer { 
        position: absolute; inset: 0; z-index: 10; 
        pointer-events: none; display: flex; flex-direction: column; 
    }

    .interactive { pointer-events: auto !important; }

    /* COMPONENT: HUD (B·∫¢NG TH√îNG TIN) */
    #hud { 
        display: flex; justify-content: space-between; padding: 30px; 
        width: 100%; opacity: 0; transition: opacity 0.8s;
    }
    .hud-unit { 
        background: rgba(0,0,0,0.8); border: 2px solid var(--c-gold);
        padding: 10px 30px; border-radius: 2px; text-align: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.8);
    }
    .hud-label { font-size: 0.6rem; color: var(--c-gold); text-transform: uppercase; letter-spacing: 3px; margin-bottom: 5px; }
    .hud-val { font-size: 2rem; font-weight: 200; }

    /* BUFF BAR (HI·ªÜU ·ª®NG) */
    #buff-bar { 
        position: absolute; top: 130px; width: 100%; 
        display: flex; justify-content: center; gap: 15px; 
    }
    .buff-icon { 
        width: 50px; height: 50px; background: rgba(142, 13, 13, 0.6); 
        border: 1px solid var(--c-gold); border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.4rem; animation: pulse 1s infinite ease-in-out;
    }

    /* MODAL & SCREENS */
    .screen { 
        position: absolute; inset: 0; background: rgba(0,0,0,0.95); 
        display: none; align-items: center; justify-content: center; 
        backdrop-filter: blur(15px); z-index: 100; 
    }
    .panel { 
        background: linear-gradient(135deg, #2d0a0a, #0a0101);
        border: 1px solid rgba(255, 215, 0, 0.3);
        width: 90%; max-width: 550px; padding: 50px; border-radius: 4px;
        box-shadow: 0 0 100px rgba(0,0,0,1); text-align: center;
    }

    .btn-titan { 
        background: transparent; border: 1px solid var(--c-gold); color: var(--c-gold);
        padding: 20px 40px; font-weight: bold; text-transform: uppercase;
        letter-spacing: 5px; cursor: pointer; transition: 0.4s; width: 100%;
        margin-top: 20px; font-family: var(--font-main);
    }
    .btn-titan:hover { background: var(--c-gold); color: #000; box-shadow: 0 0 40px var(--c-gold); }

    /* GACHA ELEMENT */
    .gacha-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 30px 0; }
    .envelope-3d { 
        aspect-ratio: 2/3; background: var(--c-red); border: 1px solid var(--c-gold);
        display: flex; align-items: center; justify-content: center; font-size: 2.5rem;
        cursor: pointer; transition: 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        transform-style: preserve-3d;
    }
    .envelope-3d.reveal { transform: rotateY(180deg) scale(1.1); background: #fff; }
    .env-back { position: absolute; backface-visibility: hidden; transform: rotateY(180deg); color: var(--c-red); font-weight: bold; font-size: 1.4rem; }

    /* CONFIG UI */
    .cfg-trigger { position: fixed; bottom: 20px; right: 20px; opacity: 0.3; cursor: pointer; font-size: 24px; z-index: 1000; pointer-events: auto; }
    textarea.cfg-editor { width: 100%; height: 250px; background: #000; color: #39ff14; padding: 15px; font-family: 'Courier New', monospace; margin-top: 15px; border: 1px solid #333; }

    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
    .shake { animation: shakeAnim 0.4s; }
    @keyframes shakeAnim { 0% {transform: translate(0,0)} 25% {transform: translate(5px, 5px)} 50% {transform: translate(-5px, 5px)} 75% {transform: translate(5px, -5px)} 100% {transform: translate(0,0)} }
</style>
</head>
<body>

    <div class="cfg-trigger" onclick="System.openConfig()">‚öôÔ∏è</div>
    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        <div id="hud">
            <div class="hud-unit">
                <div class="hud-label">CHRONOS_TIME</div>
                <div id="ui-time" class="hud-val">60.0</div>
            </div>
            <div class="hud-unit" style="border-color: var(--c-neon-blue);">
                <div class="hud-label">PROSPERITY_XP</div>
                <div id="ui-score" class="hud-val">0</div>
            </div>
        </div>

        <div id="buff-bar"></div>

        <div id="screen-menu" class="screen interactive" style="display: flex;">
            <div class="panel">
                <div style="font-size: 5rem; margin-bottom: 20px; filter: drop-shadow(0 0 20px var(--c-red));">üèÆ</div>
                <h1 style="color:var(--c-gold); letter-spacing: 12px; font-weight: 100; font-size: 3rem; margin: 0;">TITAN_LUNAR</h1>
                <p style="color:#555; letter-spacing: 5px; font-size: 0.7rem; margin-top: 10px;">X-ENGINE V500.0 ‚Ä¢ HCMUTE RESEARCH LAB</p>
                <button class="btn-titan" onclick="Engine.init()">[ BOOT_SEQUENCE ]</button>
            </div>
        </div>

        <div id="screen-gacha" class="screen interactive">
            <div class="modal" style="max-width: 600px;">
                <h2 style="color:var(--c-gold); letter-spacing: 8px; font-weight: 100;">V·∫¨N M·ªÜNH</h2>
                <div class="gacha-grid" id="gacha-grid"></div>
                <div id="ui-luck-info" style="color: var(--c-gold); font-size: 0.8rem; border-top: 1px solid #333; padding-top: 15px;">LUCK_MODIFIER: +0.0%</div>
            </div>
        </div>

        <div id="screen-result" class="screen interactive">
            <div class="modal">
                <h1 style="color:var(--c-gold); font-weight: 100; letter-spacing: 5px;">HO√ÄN T·∫§T</h1>
                <div style="font-size: 6rem; margin: 20px 0;">üßß</div>
                <div id="res-prize" style="font-size: 3.5rem; color: #fff; font-family: 'Georgia', serif;">0ƒë</div>
                <button class="btn-titan" onclick="location.reload()">SYNC_AND_REBOOT</button>
            </div>
        </div>

        <div id="screen-admin" class="screen interactive">
            <div class="panel" style="max-width: 600px; text-align: left;">
                <h2 style="color:var(--c-gold);">H·ªÜ TH·ªêNG C·ªêT L√ïI</h2>
                <textarea id="adm-json" class="cfg-editor"></textarea>
                <div style="display: flex; gap: 15px;">
                    <button class="btn-titan" onclick="System.saveConfig()">SAVE_PATCH</button>
                    <button class="btn-titan" style="border-color:#500" onclick="UI.hide('admin')">EXIT</button>
                </div>
            </div>
        </div>
    </div>

<script>
/**
 * ============================================================================
 * TITAN GAME ENGINE v500.0
 * Architecture: Module-Based Prototype
 * Developer: AI AI Collaborator
 * ============================================================================
 */

/* --- MODULE 1: MATH & VECTOR KERNEL --- */
const MathK = {
    lerp: (a, b, t) => a + (b - a) * t,
    clamp: (v, min, max) => Math.max(min, Math.min(v, max)),
    dist: (v1, v2) => Math.hypot(v1.x - v2.x, v1.y - v2.y),
    rand: (min, max) => Math.random() * (max - min) + min,
    randInt: (min, max) => Math.floor(Math.random() * (max - min + 1)) + min
};

class Vec2 {
    constructor(x=0, y=0) { this.x = x; this.y = y; }
    set(x, y) { this.x = x; this.y = y; return this; }
    add(v) { this.x += v.x; this.y += v.y; return this; }
    mult(s) { this.x *= s; this.y *= s; return this; }
}

/* --- MODULE 2: AUDIO SYNTHESIZER --- */
const AudioEngine = {
    ctx: null, master: null,
    init() {
        if(this.ctx) return;
        this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        this.master = this.ctx.createGain(); this.master.gain.value = 0.15;
        this.master.connect(this.ctx.destination);
    },
    play(freq, type, dur, vol=1) {
        if(!this.ctx) return;
        const t = this.ctx.currentTime;
        const o = this.ctx.createOscillator(); const g = this.ctx.createGain();
        o.type = type; o.frequency.setValueAtTime(freq, t);
        g.gain.setValueAtTime(0, t);
        g.gain.linearRampToValueAtTime(vol, t + 0.01);
        g.gain.exponentialRampToValueAtTime(0.001, t + dur);
        o.connect(g); g.connect(this.master);
        o.start(); o.stop(t + dur + 0.1);
    },
    sfx: {
        collect: () => AudioEngine.play(1200 + Math.random()*400, 'sine', 0.15),
        hit: () => AudioEngine.play(80, 'sawtooth', 0.4, 0.6),
        buff: () => { AudioEngine.play(440, 'square', 0.1); setTimeout(()=>AudioEngine.play(880, 'square', 0.2), 100); }
    }
};

/* --- MODULE 3: OBJECT POOLING SYSTEM --- */
class Pool {
    constructor(factory, size) {
        this.store = Array.from({ length: size }, factory);
        this.freeIdx = [...Array(size).keys()];
    }
    get() {
        if (this.freeIdx.length === 0) return null;
        const idx = this.freeIdx.pop();
        const item = this.store[idx];
        item._pIdx = idx; item.active = true;
        return item;
    }
    put(item) {
        item.active = false;
        this.freeIdx.push(item._pIdx);
    }
}

/* --- MODULE 4: RENDERING PIPELINE (X-RENDER) --- */
const Renderer = {
    // V·∫Ω R·ªó Tre 3D (Procedural Interlocking)
    basket(ctx, x, y, w, h, s) {
        const bh = h * s; const bw = w * (2 - s);
        ctx.save();
        ctx.translate(x, y + (h - bh)/2);
        
        // 1. Shadow
        ctx.fillStyle = "rgba(0,0,0,0.4)";
        ctx.beginPath(); ctx.ellipse(0, bh/2 + 25, bw/2, 15, 0, 0, Math.PI*2); ctx.fill();

        // 2. Body
        const grad = ctx.createLinearGradient(0, -bh/2, 0, bh/2);
        grad.addColorStop(0, '#8d6e63'); grad.addColorStop(1, '#3e2723');
        ctx.fillStyle = grad; ctx.beginPath();
        ctx.moveTo(-bw/2, -bh/2); ctx.bezierCurveTo(-bw/2, bh/2, bw/2, bh/2, bw/2, -bh/2); ctx.fill();

        // 3. Weaving Texture
        ctx.strokeStyle = "rgba(0,0,0,0.25)"; ctx.lineWidth = 1;
        for(let i = -bw/2 + 5; i < bw/2; i += 12) {
            ctx.beginPath(); ctx.moveTo(i, -bh/2); ctx.quadraticCurveTo(i*0.5, bh/2, i*0.2, bh/2); ctx.stroke();
        }

        // 4. Rim
        ctx.strokeStyle = "#5d4037"; ctx.lineWidth = 12;
        ctx.beginPath(); ctx.ellipse(0, -bh/2, bw/2 + 6, 12, 0, 0, Math.PI*2); ctx.stroke();
        ctx.restore();
    },

    // 10 Lo·∫°i v·∫≠t ph·∫©m Render ri√™ng bi·ªát
    artifact(ctx, e, t) {
        ctx.save();
        ctx.translate(e.pos.x, e.pos.y);
        ctx.rotate(e.angle);
        
        ctx.shadowBlur = 15;
        const type = e.type;

        switch(type) {
            case 'lixi': // 1. L√¨ x√¨
                ctx.fillStyle = '#b71c1c'; ctx.shadowColor = '#f00';
                ctx.beginPath(); ctx.roundRect(-25,-35,50,70,4); ctx.fill();
                ctx.strokeStyle = '#ffd700'; ctx.lineWidth=2; ctx.strokeRect(-20,-30,40,60);
                break;
            case 'bag': // 2. T√∫i ti·ªÅn
                ctx.fillStyle = '#ffd700'; ctx.shadowColor = '#ffd700';
                ctx.beginPath(); ctx.arc(0, 5, 25, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#b71c1c'; ctx.fillRect(-5,-20,10,10);
                break;
            case 'gold': // 3. Th·ªèi v√†ng
                ctx.fillStyle = '#ffcc00'; ctx.shadowColor = '#ffcc00';
                ctx.beginPath(); ctx.moveTo(-25,0); ctx.quadraticCurveTo(0,20,25,0); ctx.lineTo(20,-10); ctx.quadraticCurveTo(0,0,-20,-10); ctx.closePath(); ctx.fill();
                break;
            case 'coin': // 4. Ti·ªÅn xu (Magnet)
                ctx.fillStyle = '#cd7f32'; ctx.shadowColor = '#0ff';
                ctx.beginPath(); ctx.arc(0,0,20,0,Math.PI*2); ctx.fill();
                ctx.strokeStyle='#000'; ctx.strokeRect(-5,-5,10,10);
                break;
            case 'lantern': // 5. L·ªìng ƒë√®n (Shield)
                ctx.fillStyle = '#f00'; ctx.shadowColor = '#39ff14';
                ctx.beginPath(); ctx.ellipse(0,0,15,25,0,0,Math.PI*2); ctx.fill();
                ctx.fillStyle='#ffd700'; ctx.fillRect(-15,-25,30,5); ctx.fillRect(-15,20,30,5);
                break;
            case 'scroll': // 6. Cu·ªën th∆∞ (Time)
                ctx.fillStyle = '#fff9c4'; ctx.shadowColor = '#fff';
                ctx.beginPath(); ctx.roundRect(-30,-15,60,30,10); ctx.fill();
                ctx.strokeStyle='#5d4037'; ctx.stroke();
                break;
            case 'cake': // 7. B√°nh ch∆∞ng (X2)
                ctx.fillStyle = '#2e7d32'; ctx.shadowColor = '#ffd700';
                ctx.beginPath(); ctx.rect(-25,-25,50,50); ctx.fill();
                ctx.strokeStyle='#fff'; ctx.strokeRect(-25,-25,50,50);
                break;
            case 'wine': // 8. B√¨nh r∆∞·ª£u (Slow)
                ctx.fillStyle = '#fff'; ctx.shadowColor = '#bc13fe';
                ctx.beginPath(); ctx.moveTo(-10,-25); ctx.lineTo(10,-25); ctx.lineTo(15,10); ctx.quadraticCurveTo(0,30,-15,10); ctx.closePath(); ctx.fill();
                break;
            case 'fan': // 9. Qu·∫°t (Clear)
                ctx.fillStyle = '#ff85a2'; ctx.shadowColor = '#fff';
                ctx.beginPath(); ctx.arc(0,0,30,Math.PI,0); ctx.lineTo(0,0); ctx.closePath(); ctx.fill();
                break;
            case 'bomb': // 10. Ph√°o tr√∫c
                ctx.fillStyle = '#333'; ctx.shadowColor = '#f00';
                ctx.beginPath(); ctx.arc(0,0,22,0,Math.PI*2); ctx.fill();
                ctx.strokeStyle='#f00'; ctx.lineWidth=3; ctx.stroke();
                break;
        }
        ctx.restore();
    }
};

/* --- MODULE 5: ENGINE KERNEL --- */
const Engine = (() => {
    const cvs = document.getElementById('gameCanvas');
    const ctx = cvs.getContext('2d', { alpha: false });
    
    const state = {
        running: false, time: 60, score: 0,
        w: 0, h: 0, lastT: 0,
        player: { pos: new Vec2(), tx: 0, squash: 1, shake: 0 },
        buffs: { magnet: 0, shield: 0, x2: 0, slow: 0 }
    };

    // Advanced Pools
    const particlePool = new Pool(() => ({ pos: new Vec2(), vel: new Vec2(), life: 0, c: '', active: false }), 500);
    const entityPool = new Pool(() => ({ pos: new Vec2(), vy: 0, type: '', angle: 0, sway: 0, active: false }), 100);

    const init = () => {
        AudioEngine.init();
        resize();
        window.onresize = resize;
        document.addEventListener('mousemove', e => state.player.tx = e.clientX);
        document.addEventListener('touchmove', e => { e.preventDefault(); state.player.tx = e.touches[0].clientX; }, {passive:false});
        
        state.running = true; state.time = 60; state.score = 0;
        for(let b in state.buffs) state.buffs[b] = 0;
        
        UI.screen('menu', false);
        UI.screen('hud', true);
        
        state.lastT = performance.now();
        requestAnimationFrame(loop);
        spawner();
    };

    const resize = () => {
        state.w = cvs.width = window.innerWidth;
        state.h = cvs.height = window.innerHeight;
        state.player.pos.set(state.w/2, state.h - 150);
        state.player.tx = state.w/2;
    };

    const loop = (t) => {
        if(!state.running) return;
        const dt = (t - state.lastT) / 1000;
        state.lastT = t;

        const ts = state.buffs.slow > 0 ? 0.4 : 1.0; // Time Scale

        // 1. RENDER BACKGROUND
        ctx.fillStyle = "#120101"; ctx.fillRect(0,0,state.w,state.h);
        
        // 2. PLAYER PHYSICS (LERP + SHAKE)
        state.player.pos.x += (state.player.tx - state.player.pos.x) * 0.15;
        if(state.player.squash < 1) state.player.squash += 0.05;
        if(state.player.shake > 0) state.player.shake *= 0.9;

        ctx.save();
        if(state.player.shake > 0.5) ctx.translate(Math.random()*state.player.shake, Math.random()*state.player.shake);
        Renderer.basket(ctx, state.player.pos.x, state.player.pos.y, 160, 110, state.player.squash);
        ctx.restore();

        // 3. ENTITY ENGINE
        entityPool.store.forEach(e => {
            if(!e.active) return;
            e.pos.y += e.vy * ts * (1 + (60 - state.time)/150);
            e.sway += 0.04; e.pos.x += Math.sin(e.sway) * 2;
            e.angle += 0.02;

            if(state.buffs.magnet > 0 && e.type !== 'bomb') {
                e.pos.x += (state.player.pos.x - e.pos.x) * 0.15;
                e.pos.y += (state.player.pos.y - e.pos.y) * 0.15;
            }

            Renderer.artifact(ctx, e, t);

            if(Math.hypot(e.pos.x - state.player.pos.x, e.pos.y - state.player.pos.y) < 80) {
                resolveHit(e); entityPool.put(e);
            } else if(e.pos.y > state.h + 100) entityPool.put(e);
        });

        // 4. VFX PARTICLE ENGINE
        particlePool.store.forEach(p => {
            if(!p.active) return;
            p.pos.add(p.vel); p.vel.y += 0.2; p.life -= dt * 2;
            if(p.life <= 0) particlePool.put(p);
            else {
                ctx.fillStyle = p.c; ctx.globalAlpha = p.life;
                ctx.fillRect(p.pos.x, p.pos.y, 4, 4);
            }
        });
        ctx.globalAlpha = 1;

        // 5. HUD & BUFFS
        state.time -= dt * ts;
        for(let b in state.buffs) if(state.buffs[b] > 0) state.buffs[b] -= dt;
        syncUI();

        if(state.time <= 0) gameOver();
        else requestAnimationFrame(loop);
    };

    const resolveHit = (e) => {
        state.player.squash = 0.7;
        const x2 = state.buffs.x2 > 0 ? 2 : 1;

        if(e.type === 'bomb') {
            if(state.buffs.shield > 0) { state.buffs.shield = 0; AudioEngine.sfx.collect(); return; }
            state.score = Math.max(0, state.score - 50);
            state.player.shake = 20; AudioEngine.sfx.hit();
            burst(e.pos.x, e.pos.y, '#f00');
        } else {
            if(e.type === 'lixi') state.score += 10 * x2;
            else if(e.type === 'bag') state.score += 50 * x2;
            else if(e.type === 'gold') state.score += 100 * x2;
            else if(e.type === 'coin') { state.buffs.magnet = 8; AudioEngine.sfx.buff(); }
            else if(e.type === 'lantern') { state.buffs.shield = 1; AudioEngine.sfx.buff(); }
            else if(e.type === 'scroll') state.time += 5;
            else if(e.type === 'cake') { state.buffs.x2 = 10; AudioEngine.sfx.buff(); }
            else if(e.type === 'wine') { state.buffs.slow = 5; AudioEngine.sfx.buff(); }
            else if(e.type === 'fan') { entityPool.store.forEach(ent => {if(ent.type==='bomb') ent.pos.y = -1000;}); }
            
            AudioEngine.sfx.collect();
            burst(e.pos.x, e.pos.y, '#ffd700');
        }
    };

    const burst = (x, y, c) => {
        for(let i=0; i<15; i++) {
            const p = particlePool.get();
            if(p) { p.pos.set(x,y); p.vel.set((Math.random()-0.5)*15, (Math.random()-0.5)*15); p.life=1; p.c=c; }
        }
    };

    const spawner = () => {
        if(!state.running) return;
        const e = entityPool.get();
        if(e) {
            const types = ['lixi','lixi','lixi','bag','gold','coin','lantern','scroll','cake','wine','fan','bomb','bomb'];
            e.pos.set(MathK.rand(100, state.w-100), -100);
            e.vy = MathK.rand(4, 7); e.sway = MathK.rand(0, 10);
            e.type = types[MathK.randInt(0, types.length-1)];
        }
        setTimeout(spawner, 500);
    };

    const syncUI = () => {
        document.getElementById('ui-time').innerText = Math.max(0, state.time).toFixed(1);
        document.getElementById('ui-score').innerText = state.score;
        const bar = document.getElementById('buff-bar'); bar.innerHTML = '';
        const icons = { magnet:'üß≤', shield:'üèÆ', x2:'üç±', slow:'üç∂' };
        for(let b in icons) if(state.buffs[b] > 0) bar.innerHTML += `<div class="buff-icon">${icons[b]}</div>`;
    };

    const gameOver = () => {
        state.running = false;
        UI.showGacha(MathK.clamp(state.score/15, 0, 75));
    };

    return { init, state };
})();

/* --- MODULE 6: GACHA & SYSTEM --- */
const System = {
    cfgKey: 'titan_lixi_v5',
    defaultCfg: [{v:200000,w:0.2}, {v:100000,w:1}, {v:50000,w:10}, {v:20000,w:50}, {v:10000,w:150}],
    load() { return JSON.parse(localStorage.getItem(this.cfgKey)) || this.defaultCfg; },
    openConfig() { 
        UI.open('admin'); 
        document.getElementById('adm-json').value = JSON.stringify(this.load(), null, 2); 
    },
    saveConfig() { 
        localStorage.setItem(this.cfgKey, document.getElementById('adm-json').value); 
        alert("PATCH_COMPLETE"); 
    }
};

const UI = {
    open(id) { document.getElementById(`screen-${id}`).style.display = 'flex'; },
    close(id) { document.getElementById(`screen-${id}`).style.display = 'none'; },
    screen(id, s) { document.getElementById(id==='hud'?id:`screen-${id}`).style.opacity = s?1:0; if(s) this.open(id); else this.close(id); },
    showGacha(luck) {
        this.screen('hud', false); this.open('gacha');
        document.getElementById('ui-luck-info').innerText = `PH√öC KH√ç T√çCH L≈®Y: +${luck.toFixed(1)}%`;
        const grid = document.getElementById('gacha-grid'); grid.innerHTML = '';
        for(let i=0; i<9; i++) {
            const el = document.createElement('div'); el.className = 'envelope-3d';
            el.innerHTML = `<div style="backface-visibility:hidden">üßß</div><div class="env-back">?</div>`;
            el.onclick = () => {
                if(el.classList.contains('reveal')) return;
                const p = this.roll(luck); el.classList.add('reveal'); el.querySelector('.env-back').innerText = (p/1000) + 'k';
                setTimeout(() => { this.open('result'); document.getElementById('res-prize').innerText = p.toLocaleString() + "ƒë"; }, 1500);
            };
            grid.appendChild(el);
        }
    },
    roll(luck) {
        const table = System.load(); let tot = 0;
        const pool = table.map(i => {
            let w = i.w;
            if(i.v >= 50000) w *= (1 + luck/5); else w = Math.max(w*0.1, w*(1-luck/100));
            tot += w; return { v: i.v, cw: tot };
        });
        const r = Math.random() * tot; return pool.find(p => r <= p.cw).v;
    }
};

window.onload = () => Engine.init(); // Auto-resize is handled by boot
</script>
</body>
</html>
