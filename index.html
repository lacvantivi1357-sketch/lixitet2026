<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>L√¨ X√¨ 200.0 - Lunar Odyssey Engine</title>
<style>
    /* =========================================
       1. CORE DESIGN (ULTRA TET STYLE)
       ========================================= */
    :root {
        --n-red: #d0021b; --n-gold: #ffd700; --n-blue: #00f2ea;
        --n-purple: #bc13fe; --n-green: #39ff14;
        --font: 'Segoe UI', system-ui, sans-serif;
    }

    * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
    body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: var(--font); color: white; }
    canvas { display: block; position: absolute; top: 0; left: 0; z-index: 1; }

    /* UI LAYER ARCHITECTURE */
    #ui-portal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
    .interactive { pointer-events: auto !important; }

    /* HUD SYSTEM */
    #hud { display: flex; justify-content: space-between; padding: 20px; width: 100%; position: absolute; top: 0; z-index: 20; opacity: 0; transition: 1s; }
    .hud-card { 
        border: 2px solid var(--n-gold); padding: 8px 20px; 
        background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(10px);
        text-align: center; border-radius: 12px;
    }
    .hud-label { font-size: 0.6rem; color: var(--n-gold); text-transform: uppercase; letter-spacing: 2px; }
    .hud-val { font-size: 1.8rem; font-weight: bold; color: #fff; }

    /* STATUS EFFECTS TRAY */
    #status-effects {
        position: absolute; top: 100px; width: 100%; display: flex;
        justify-content: center; gap: 10px; pointer-events: none; z-index: 20;
    }
    .effect-icon {
        width: 40px; height: 40px; background: rgba(0,0,0,0.5);
        border: 2px solid var(--n-gold); border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.2rem; animation: pulse 1s infinite;
    }

    /* MODALS */
    .overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; backdrop-filter: blur(20px); z-index: 100; }
    .modal { background: rgba(20, 0, 0, 0.98); border: 2px solid var(--n-gold); width: 92%; max-width: 450px; padding: 40px; border-radius: 20px; text-align: center; }
    
    .btn-lux { 
        background: linear-gradient(to bottom, var(--n-gold), #b37400); 
        color: #800; border: none; padding: 18px; font-weight: 900; 
        text-transform: uppercase; letter-spacing: 3px; cursor: pointer;
        width: 100%; border-radius: 50px; margin-top: 20px;
        box-shadow: 0 6px 0 #600;
    }
    .btn-lux:active { transform: translateY(4px); box-shadow: none; }

    /* GACHA GRID */
    .gacha-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 25px 0; }
    .envelope { 
        aspect-ratio: 2/3; background: var(--n-red); border: 2px solid var(--n-gold); 
        display: flex; align-items: center; justify-content: center; font-size: 2.5rem; 
        cursor: pointer; transition: 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform-style: preserve-3d;
        border-radius: 10px;
    }
    .envelope.reveal { transform: rotateY(180deg); background: #fff; }
    .env-info { position: absolute; backface-visibility: hidden; transform: rotateY(180deg); color: var(--n-red); font-size: 1.1rem; font-weight: 900; }

    @keyframes pulse { 0% {transform:scale(1)} 50% {transform:scale(1.1)} 100% {transform:scale(1)} }
    .hidden { display: none !important; }
</style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <div id="ui-portal">
        <div id="hud">
            <div class="hud-card">
                <div class="hud-label">S_TIME</div>
                <div id="ui-time" class="hud-val">60.0</div>
            </div>
            <div id="phase-tag" style="color:var(--n-gold); font-weight:bold; padding-top:10px;">[ PHASE: XU√ÇN ]</div>
            <div class="hud-card" style="border-color: var(--n-blue);">
                <div class="hud-label">LUCK_POINTS</div>
                <div id="ui-score" class="hud-val">0</div>
            </div>
        </div>

        <div id="status-effects"></div>

        <div id="screen-menu" class="overlay interactive" style="display: flex;">
            <div class="modal">
                <div style="font-size: 5rem; margin-bottom: 20px;">üê≤</div>
                <h1 style="color:#fff; letter-spacing: 5px;">LUNAR ODYSSEY</h1>
                <p style="color:var(--n-gold); font-size: 0.8rem;">X-ENGINE V200.0 ‚Ä¢ SUPREME EDITION</p>
                <button class="btn-lux" onclick="ApexEngine.boot()">[ KH·ªûI CH·∫†Y ]</button>
            </div>
        </div>

        <div id="screen-gacha" class="overlay interactive">
            <div class="modal">
                <h2 style="color:var(--n-gold)">L·ª∞A CH·ªåN V·∫¨N M·ªÜNH</h2>
                <div class="gacha-grid" id="gacha-grid"></div>
                <p id="ui-luck-info" style="color: var(--n-blue); font-size:0.9rem;"></p>
            </div>
        </div>

        <div id="screen-result" class="overlay interactive">
            <div class="modal">
                <h1 style="color:var(--n-gold)">K·∫æT QU·∫¢ CU·ªêI C√ôNG</h1>
                <div style="font-size: 5rem; margin: 20px 0;">üéâ</div>
                <h2 id="res-prize" style="font-size: 3.5rem; color: #fff; text-shadow: 0 0 20px var(--n-blue);">0ƒë</h2>
                <button class="btn-lux" onclick="location.reload()">[ CH∆†I L·∫†I ]</button>
            </div>
        </div>
    </div>

<script>
/**
 * APEX ENGINE v200.0 - LUNAR ODYSSEY
 * Architecture: Optimized Object Pooling, ADSR Audio, Procedural VFX
 */
const ApexEngine = (() => {
    
    /* --- 1. CORE PHYSICS & UTILS --- */
    class Pool {
        constructor(factory, size) {
            this.items = Array.from({ length: size }, factory);
            this.free = [...Array(size).keys()];
        }
        acquire() {
            if (this.free.length > 0) {
                const idx = this.free.pop();
                const obj = this.items[idx];
                obj._pIdx = idx; obj.active = true;
                return obj;
            } return null;
        }
        release(obj) { obj.active = false; this.free.push(obj._pIdx); }
    }

    const Audio = {
        ctx: null, master: null,
        init() {
            if(this.ctx) return;
            this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            this.master = this.ctx.createGain(); this.master.gain.value = 0.15;
            this.master.connect(this.ctx.destination);
        },
        play(f, t, d, v=1) {
            const now = this.ctx.currentTime;
            const o = this.ctx.createOscillator(); const g = this.ctx.createGain();
            o.type = t; o.frequency.setValueAtTime(f, now);
            g.gain.setValueAtTime(0, now);
            g.gain.linearRampToValueAtTime(v, now + 0.01);
            g.gain.exponentialRampToValueAtTime(0.001, now + d);
            o.connect(g); g.connect(this.master);
            o.start(); o.stop(now + d + 0.1);
        }
    };

    /* --- 2. ENGINE STATE --- */
    const State = {
        running: false, score: 0, time: 60,
        w: 0, h: 0, lastT: 0,
        player: { x: 0, tx: 0, y: 0, w: 130, h: 90 },
        entities: [], particles: [], blossoms: [],
        // BUFFS & DEBUFFS
        buffs: { magnet: 0, shield: 0, star: 0, frozen: 0 },
        phase: 'XU√ÇN' 
    };

    const cvs = document.getElementById('gameCanvas');
    const ctx = cvs.getContext('2d', { alpha: false });

    const particlePool = new Pool(() => ({ x:0, y:0, vx:0, vy:0, life:0, c:'', active:false }), 500);
    const entityPool = new Pool(() => ({ x:0, y:0, vy:0, type:'', active:false, angle:0 }), 80);

    /* --- 3. PROCEDURAL RENDERER --- */
    const Draw = {
        lixi(ctx, x, y, type, t) {
            ctx.save();
            ctx.translate(x, y);
            ctx.rotate(Math.sin(t/300)*0.1);
            
            // Bloom Effect based on type
            ctx.shadowBlur = 15;
            if(type === 'gift') { ctx.fillStyle = "#d0021b"; ctx.shadowColor = "#f00"; }
            else if(type === 'money_bag') { ctx.fillStyle = "#ffd700"; ctx.shadowColor = "#ffd700"; }
            else if(type === 'magnet') { ctx.fillStyle = "#00eaff"; ctx.shadowColor = "#00eaff"; }
            else if(type === 'shield') { ctx.fillStyle = "#39ff14"; ctx.shadowColor = "#39ff14"; }
            
            ctx.beginPath(); ctx.roundRect(-25, -35, 50, 70, 5); ctx.fill();
            ctx.strokeStyle = "#ffd700"; ctx.lineWidth = 2; ctx.stroke();
            
            // Icon
            ctx.fillStyle = "#fff"; ctx.font = "20px Arial"; ctx.textAlign="center";
            const icons = { gift:'üßß', money_bag:'üí∞', magnet:'üß≤', shield:'üõ°Ô∏è', star:'üåü', ice:'‚ùÑÔ∏è' };
            ctx.fillText(icons[type] || 'üßß', 0, 10);
            ctx.restore();
        },
        bomb(ctx, x, y, t) {
            ctx.save(); ctx.translate(x, y);
            const s = 1 + Math.sin(t/50)*0.1; ctx.scale(s, s);
            ctx.fillStyle = "#111"; ctx.shadowBlur = 20; ctx.shadowColor = "#f00";
            ctx.beginPath(); ctx.arc(0, 0, 22, 0, Math.PI*2); ctx.fill();
            ctx.strokeStyle = "#ff0000"; ctx.stroke();
            ctx.restore();
        }
    };

    /* --- 4. GAMEPLAY LOGIC --- */
    const boot = () => {
        Audio.init(); resize();
        window.onresize = resize;
        document.addEventListener('mousemove', e => State.player.tx = e.clientX);
        document.addEventListener('touchmove', e => { e.preventDefault(); State.player.tx = e.touches[0].clientX; }, {passive:false});
        
        State.running = true;
        document.getElementById('screen-menu').style.display = 'none';
        document.getElementById('hud').style.opacity = 1;
        
        // Stars/Blossoms
        State.blossoms = Array.from({length: 40}, () => ({ x: Math.random()*State.w, y: Math.random()*State.h, s: Math.random()*1.5+0.5 }));
        
        State.lastT = performance.now();
        requestAnimationFrame(loop);
        spawner();
    };

    const resize = () => {
        State.w = cvs.width = window.innerWidth;
        State.h = cvs.height = window.innerHeight;
        State.player.y = State.h - 130;
    };

    const loop = (t) => {
        if(!State.running) return;
        const dt = (t - State.lastT) / 1000;
        State.lastT = t;

        // Phase Color Logic
        if(State.time > 40) { State.phase = 'XU√ÇN'; ctx.fillStyle = '#2d0202'; }
        else if(State.time > 20) { State.phase = 'H·∫†'; ctx.fillStyle = '#3a1a00'; }
        else { State.phase = 'THU'; ctx.fillStyle = '#050a1a'; }
        document.getElementById('phase-tag').innerText = `[ PHASE: ${State.phase} ]`;

        ctx.fillRect(0, 0, State.w, State.h);

        // Player Movement (Frozen Check)
        const lerpSpeed = State.buffs.frozen > 0 ? 0.05 : 0.18;
        State.player.x += (State.player.tx - State.player.x) * lerpSpeed;

        // Draw Player
        ctx.save();
        ctx.translate(State.player.x, State.player.y);
        ctx.strokeStyle = State.buffs.shield > 0 ? varColor('--n-green') : varColor('--n-gold');
        ctx.lineWidth = 4; ctx.shadowBlur = 20; ctx.shadowColor = ctx.strokeStyle;
        ctx.beginPath(); ctx.roundRect(-65, -45, 130, 90, 10); ctx.stroke();
        ctx.restore();

        // Entity Loop
        entityPool.items.forEach(e => {
            if(!e.active) return;
            
            // Movement Physics
            e.y += e.vy * (1 + (60 - State.time)/120);
            if(State.buffs.magnet > 0 && e.type !== 'bomb') {
                e.x += (State.player.x - e.x) * 0.15;
                e.y += (State.player.y - e.y) * 0.15;
            }

            if(e.type === 'bomb') Draw.bomb(ctx, e.x, e.y, t); else Draw.lixi(ctx, e.x, e.y, e.type, t);

            // Collision
            if(Math.hypot(e.x - State.player.x, e.y - State.player.y) < 75) {
                handleHit(e); entityPool.release(e);
            } else if(e.y > State.h + 100) entityPool.release(e);
        });

        // Particle Loop
        particlePool.items.forEach(p => {
            if(!p.active) return;
            p.x += p.vx; p.y += p.vy; p.vy += 0.2; p.life -= 0.02;
            if(p.life <= 0) { particlePool.release(p); return; }
            ctx.fillStyle = p.c; ctx.globalAlpha = p.life;
            ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI*2); ctx.fill();
        });
        ctx.globalAlpha = 1;

        // Update Buffs
        for(let b in State.buffs) if(State.buffs[b] > 0) State.buffs[b] -= dt;
        updateBuffUI();

        // Clock Sync
        State.time -= dt;
        document.getElementById('ui-time').innerText = Math.max(0, State.time).toFixed(1);
        document.getElementById('ui-score').innerText = State.score;

        if(State.time <= 0) gameOver();
        else requestAnimationFrame(loop);
    };

    const handleHit = (e) => {
        if(e.type === 'bomb') {
            if(State.buffs.shield > 0) { State.buffs.shield = 0; Audio.play(400, 'sine', 0.2); return; }
            State.score = Math.max(0, State.score - 50);
            Audio.play(80, 'sawtooth', 0.4);
            if(navigator.vibrate) navigator.vibrate(200);
        } else {
            // Points logic
            let pts = 10;
            if(e.type === 'star') pts = 50;
            if(e.type === 'money_bag') pts = 30;
            if(State.buffs.star > 0) pts *= 3;
            
            State.score += pts;
            
            // Logic Buffs
            if(e.type === 'magnet') State.buffs.magnet = 8;
            if(e.type === 'shield') State.buffs.shield = 1; // 1 charge
            if(e.type === 'star') State.buffs.star = 5;
            if(e.type === 'ice') State.buffs.frozen = 3;

            Audio.play(1000 + (State.score % 500), 'sine', 0.1);
        }
        
        // Hit Particles
        for(let i=0; i<15; i++) {
            const p = particlePool.acquire();
            if(p) {
                p.x = e.x; p.y = e.y;
                const ang = Math.random()*Math.PI*2; const spd = Math.random()*8;
                p.vx = Math.cos(ang)*spd; p.vy = Math.sin(ang)*spd;
                p.life = 1.0; p.c = e.type === 'bomb' ? '#f00' : '#ffd700';
            }
        }
    };

    const spawner = () => {
        if(!State.running) return;
        const e = entityPool.acquire();
        if(e) {
            e.x = Math.random()*(State.w-100)+50; e.y = -100; e.vy = 4.5;
            let r = Math.random();
            // Diversified Item Pool
            if(r < 0.15) e.type = 'bomb';
            else if(r < 0.20) e.type = 'magnet';
            else if(r < 0.23) e.type = 'shield';
            else if(r < 0.26) e.type = 'star';
            else if(r < 0.29) e.type = 'money_bag';
            else if(r < 0.32) e.type = 'ice';
            else e.type = 'gift';
        }
        setTimeout(spawner, 500);
    };

    const updateBuffUI = () => {
        const tray = document.getElementById('status-effects');
        tray.innerHTML = '';
        const icons = { magnet:'üß≤', star:'üåü', frozen:'‚ùÑÔ∏è' };
        for(let b in icons) {
            if(State.buffs[b] > 0) {
                const div = document.createElement('div');
                div.className = 'effect-icon';
                div.innerText = icons[b];
                tray.appendChild(div);
            }
        }
    };

    const gameOver = () => {
        State.running = false;
        const luck = Math.min(60, State.score / 12);
        setupGacha(luck);
    };

    const setupGacha = (luck) => {
        document.getElementById('hud').style.opacity = 0;
        document.getElementById('screen-gacha').style.display = 'flex';
        document.getElementById('ui-luck-info').innerText = `K·ª∏ NƒÇNG V∆Ø·ª¢T TR·ªòI: +${luck.toFixed(1)}% MAY M·∫ÆN`;
        const grid = document.getElementById('gacha-grid'); grid.innerHTML = '';
        for(let i=0; i<9; i++) {
            const el = document.createElement('div'); el.className = 'envelope';
            el.innerHTML = `<div class="env-info">?</div><div style="backface-visibility:hidden">üßß</div>`;
            el.onclick = () => {
                if(el.classList.contains('reveal')) return;
                const p = GachaSystem.roll(luck);
                el.classList.add('reveal');
                el.querySelector('.env-info').innerText = (p/1000) + 'k';
                setTimeout(() => {
                    document.getElementById('screen-gacha').style.display = 'none';
                    document.getElementById('screen-result').style.display = 'flex';
                    document.getElementById('res-prize').innerText = p.toLocaleString() + "ƒë";
                }, 1300);
            };
            grid.appendChild(el);
        }
    };

    return { boot, resize };
})();

/* --- 5. DYNAMIC GACHA LOGIC --- */
const GachaSystem = {
    roll(luck) {
        // Pity Mechanic: High score practically guarantees no 10k
        const pityThreshold = 50;
        const table = [ {v:200000, w:0.5}, {v:100000, w:2}, {v:50000, w:15}, {v:20000, w:80}, {v:10000, w:150} ];
        let tot = 0;
        const pool = table.map(i => {
            let w = i.w;
            if(i.v >= 50000) w *= (1 + luck/10);
            else {
                w = Math.max(w * 0.4, w * (1 - luck/80));
                if(luck > pityThreshold) w = 0.1; // G·∫ßn nh∆∞ lo·∫°i b·ªè gi·∫£i nh·ªè n·∫øu qu√° gi·ªèi
            }
            tot += w; return { v: i.v, cw: tot };
        });
        const r = Math.random() * tot;
        return pool.find(p => r <= p.cw).v;
    }
};

function varColor(v) { return getComputedStyle(document.documentElement).getPropertyValue(v).trim(); }
window.onload = () => ApexEngine.resize();
</script>
</body>
</html>
