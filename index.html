<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>L√¨ X√¨ 400.0 - Traditional Artifacts Edition</title>
<style>
    :root {
        --tet-red: #8e0d0d; --gold: #ffcc00; --bamboo: #3e2723;
        --font: 'Segoe UI', serif;
    }

    * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
    body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #120101; font-family: var(--font); color: white; }
    canvas { display: block; position: absolute; top: 0; left: 0; z-index: 1; }

    #ui-portal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
    .interactive { pointer-events: auto !important; }

    /* HUD */
    #hud { display: flex; justify-content: space-between; padding: 25px; width: 100%; position: absolute; top: 0; z-index: 20; opacity: 0; transition: 1s; }
    .hud-card { border: 2px solid var(--gold); padding: 10px 30px; background: rgba(0,0,0,0.7); text-align: center; border-radius: 5px; }
    .hud-val { font-size: 1.8rem; font-weight: bold; color: #fff; }

    /* BUFF TRAY (Hi·ªÉn th·ªã hi·ªáu ·ª©ng ƒëang ho·∫°t ƒë·ªông) */
    #buff-tray { position: absolute; top: 120px; width: 100%; display: flex; justify-content: center; gap: 15px; pointer-events: none; }
    .buff-icon { width: 45px; height: 45px; background: rgba(0,0,0,0.5); border: 2px solid var(--gold); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; animation: pulse 1s infinite; }

    .overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.92); display: none; align-items: center; justify-content: center; backdrop-filter: blur(12px); z-index: 100; }
    .modal { background: #2d0a0a; border: 1px solid var(--gold); width: 90%; max-width: 500px; padding: 40px; text-align: center; box-shadow: 0 0 100px #000; }
    .btn-real { background: #8e0d0d; color: var(--gold); border: 1px solid var(--gold); padding: 18px; font-weight: bold; text-transform: uppercase; cursor: pointer; width: 100%; margin-top: 20px; transition: 0.3s; }
    .btn-real:hover { background: var(--gold); color: #000; }

    .config-btn { position: fixed; bottom: 20px; right: 20px; background: rgba(0,0,0,0.5); color: var(--gold); width: 45px; height: 45px; border-radius: 50%; border: 1px solid var(--gold); display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; z-index: 1000; pointer-events: auto; }
    textarea.admin-box { width: 100%; height: 200px; background: #000; color: #39ff14; padding: 10px; font-family: monospace; margin-top: 15px; }

    @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.7; } }
</style>
</head>
<body>

    <div class="config-btn" onclick="Admin.open()">‚öôÔ∏è</div>

    <canvas id="gameCanvas"></canvas>

    <div id="ui-portal">
        <div id="hud">
            <div class="hud-card"><div id="ui-time" class="hud-val">60</div></div>
            <div class="hud-card"><div id="ui-score" class="hud-val">0</div></div>
        </div>
        <div id="buff-tray"></div>

        <div id="screen-menu" class="overlay interactive" style="display: flex;">
            <div class="modal">
                <h1 style="color:var(--gold); font-size: 3rem; margin:0;">C·ªî V·∫¨T TRUY·ªÄN K·ª≤</h1>
                <p style="color:#aaa; margin: 20px 0;">H√°i l·ªôc 10 lo·∫°i k·ª≥ b·∫£o - Tr·∫£i nghi·ªám th·ª±c t·∫ø 400.0</p>
                <button class="btn-real" onclick="App.boot()">[ KHAI TR·∫¨N ]</button>
            </div>
        </div>

        <div id="screen-gacha" class="overlay interactive">
            <div class="modal">
                <h2 style="color:var(--gold)">V·∫¨N M·ªÜNH TRONG TAY</h2>
                <div id="gacha-grid" style="display:grid; grid-template-columns:repeat(3,1fr); gap:15px; margin:25px 0;"></div>
                <div id="ui-luck" style="color:var(--gold); font-size:0.8rem;">LUCK: +0%</div>
            </div>
        </div>

        <div id="screen-result" class="overlay interactive">
            <div class="modal">
                <h1 style="color:var(--gold)">NH·∫¨N L·ªòC ƒê·∫¶U XU√ÇN</h1>
                <div id="res-prize" style="font-size: 3.5rem; color: #fff; margin: 30px 0;">0ƒë</div>
                <button class="btn-real" onclick="location.reload()">SYNC DATA</button>
            </div>
        </div>

        <div id="screen-admin" class="overlay interactive">
            <div class="modal">
                <h2 style="color:var(--gold)">PATCH SYSTEM</h2>
                <textarea id="adm-json" class="admin-box"></textarea>
                <button class="btn-real" onclick="Admin.save()">SAVE</button>
                <button class="btn-real" style="border-color:#500" onclick="UI.close('admin')">EXIT</button>
            </div>
        </div>
    </div>

<script>
/**
 * APEX X-RENDER ENGINE v400.0
 * 10 Artifacts Simulation & Buff Management System
 */
const App = (() => {
    
    const DB = {
        config: () => JSON.parse(localStorage.getItem('lx400_cfg')) || [
            {v:200000, w:0.5}, {v:100000, w:1}, {v:50000, w:10}, {v:20000, w:50}, {v:10000, w:150}
        ],
        save: (d) => localStorage.setItem('lx400_cfg', JSON.stringify(d))
    };

    const State = {
        running: false, score: 0, time: 60,
        w: 0, h: 0, lastT: 0,
        player: { x: 0, tx: 0, y: 0, w: 160, h: 110, squash: 1 },
        entities: [], 
        buffs: { magnet: 0, shield: 0, x2: 0, slow: 0 }
    };

    const cvs = document.getElementById('gameCanvas');
    const ctx = cvs.getContext('2d', { alpha: false });

    /* --- REALISTIC ARTIFACT RENDERER --- */
    const XRender = {
        basket(ctx, x, y, w, h, squash) {
            const bh = h * squash; const bw = w * (2 - squash);
            ctx.save(); ctx.translate(x, y + (h - bh)/2);
            // Realistic Bamboo Weaving
            const grad = ctx.createLinearGradient(0, -bh/2, 0, bh/2);
            grad.addColorStop(0, '#8d6e63'); grad.addColorStop(1, '#3e2723');
            ctx.fillStyle = grad; ctx.beginPath();
            ctx.moveTo(-bw/2, -bh/2); ctx.bezierCurveTo(-bw/2, bh/2, bw/2, bh/2, bw/2, -bh/2); ctx.fill();
            // Rim
            ctx.strokeStyle = "#5d4037"; ctx.lineWidth = 12;
            ctx.beginPath(); ctx.ellipse(0, -bh/2, bw/2 + 5, 12, 0, 0, Math.PI*2); ctx.stroke();
            ctx.restore();
        },

        // V·∫Ω 10 lo·∫°i v·∫≠t ph·∫©m b·∫±ng gi·∫£i thu·∫≠t h√¨nh h·ªçc
        drawItem(ctx, e, t) {
            ctx.save();
            ctx.translate(e.x, e.y);
            ctx.rotate(e.angle);
            if(State.buffs.slow > 0) ctx.scale(1.1, 1.1); // Slo-mo highlight

            ctx.shadowBlur = 15;
            const type = e.type;

            if(type === 'gift') { // L√¨ x√¨ ƒë·ªè
                ctx.fillStyle = '#b71c1c'; ctx.shadowColor = '#f00';
                ctx.beginPath(); ctx.roundRect(-20, -30, 40, 60, 3); ctx.fill();
                ctx.strokeStyle = '#ffd700'; ctx.lineWidth = 2; ctx.strokeRect(-15,-25,30,50);
            } else if(type === 'money_bag') { // T√∫i ti·ªÅn
                ctx.fillStyle = '#ffd700'; ctx.shadowColor = '#ffd700';
                ctx.beginPath(); ctx.arc(0, 5, 25, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#b71c1c'; ctx.fillRect(-5, -20, 10, 10); // N√∫t th·∫Øt
            } else if(type === 'gold') { // Th·ªèi v√†ng
                ctx.fillStyle = '#ffcc00'; ctx.shadowColor = '#ffcc00';
                ctx.beginPath(); ctx.moveTo(-25, 0); ctx.quadraticCurveTo(0, 20, 25, 0); ctx.lineTo(20, -10); ctx.quadraticCurveTo(0, 0, -20, -10); ctx.closePath(); ctx.fill();
            } else if(type === 'magnet') { // Ti·ªÅn xu
                ctx.fillStyle = '#cd7f32'; ctx.shadowColor = '#0ff';
                ctx.beginPath(); ctx.arc(0, 0, 20, 0, Math.PI*2); ctx.fill();
                ctx.strokeStyle = '#000'; ctx.strokeRect(-5, -5, 10, 10); // L·ªó vu√¥ng
            } else if(type === 'shield') { // L·ªìng ƒë√®n
                ctx.fillStyle = '#f00'; ctx.shadowColor = '#39ff14';
                ctx.beginPath(); ctx.ellipse(0, 0, 15, 25, 0, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#ffd700'; ctx.fillRect(-15, -25, 30, 5); ctx.fillRect(-15, 20, 30, 5);
            } else if(type === 'time') { // Cu·ªën th∆∞
                ctx.fillStyle = '#fff9c4'; ctx.shadowColor = '#fff';
                ctx.beginPath(); ctx.roundRect(-25, -15, 50, 30, 10); ctx.fill();
                ctx.strokeStyle = '#5d4037'; ctx.stroke();
            } else if(type === 'x2') { // B√°nh ch∆∞ng
                ctx.fillStyle = '#2e7d32'; ctx.shadowColor = '#ffd700';
                ctx.beginPath(); ctx.rect(-25, -25, 50, 50); ctx.fill();
                ctx.strokeStyle = '#fff'; ctx.lineWidth = 1; ctx.strokeRect(-25, -25, 50, 50); ctx.beginPath(); ctx.moveTo(-25,-25); ctx.lineTo(25,25); ctx.stroke();
            } else if(type === 'slow') { // B√¨nh r∆∞·ª£u
                ctx.fillStyle = '#fff'; ctx.shadowColor = '#bc13fe';
                ctx.beginPath(); ctx.moveTo(-10, -25); ctx.lineTo(10, -25); ctx.lineTo(15, 10); ctx.quadraticCurveTo(0, 30, -15, 10); ctx.closePath(); ctx.fill();
            } else if(type === 'fan') { // Qu·∫°t
                ctx.fillStyle = '#ff85a2'; ctx.shadowColor = '#fff';
                ctx.beginPath(); ctx.arc(0, 0, 30, Math.PI, 0); ctx.lineTo(0, 0); ctx.closePath(); ctx.fill();
            } else if(type === 'bomb') { // Ph√°o tr√∫c
                ctx.fillStyle = '#333'; ctx.shadowColor = '#f00';
                ctx.beginPath(); ctx.arc(0, 0, 22, 0, Math.PI*2); ctx.fill();
                ctx.strokeStyle = '#f00'; ctx.lineWidth = 2; ctx.stroke();
                ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(10, -15, 4, 0, Math.PI*2); ctx.fill();
            }

            ctx.restore();
        }
    };

    /* --- GAME LOGIC --- */
    const boot = () => {
        resize(); window.onresize = resize;
        document.addEventListener('mousemove', e => State.player.tx = e.clientX);
        document.addEventListener('touchmove', e => { e.preventDefault(); State.player.tx = e.touches[0].clientX; }, {passive:false});
        State.running = true; document.getElementById('screen-menu').style.display = 'none';
        document.getElementById('hud').style.opacity = 1;
        State.lastT = performance.now();
        requestAnimationFrame(loop); spawner();
    };

    const resize = () => { State.w = cvs.width = window.innerWidth; State.h = cvs.height = window.innerHeight; State.player.y = State.h - 150; };

    const loop = (t) => {
        if(!State.running) return;
        const dt = (t - State.lastT) / 1000; State.lastT = t;
        const timeScale = State.buffs.slow > 0 ? 0.4 : 1.0; // Hi·ªáu ·ª©ng Slo-mo

        ctx.fillStyle = "#1a0101"; ctx.fillRect(0, 0, State.w, State.h);

        // Player physics
        State.player.x += (State.player.tx - State.player.x) * 0.15;
        if(State.player.squash < 1) State.player.squash += 0.05;
        XRender.basket(ctx, State.player.x, State.player.y, State.player.w, State.player.h, State.player.squash);

        // Entity Processing
        State.entities.forEach((e, i) => {
            e.y += e.vy * timeScale * (1 + (60-State.time)/150);
            e.sway += 0.04; 
            e.x += Math.sin(e.sway) * (e.type==='gold'? 5 : 2); // Th·ªèi v√†ng xo√°y m·∫°nh h∆°n
            e.angle = Math.sin(e.sway) * 0.2;

            // Magnet logic
            if(State.buffs.magnet > 0 && e.type !== 'bomb') {
                e.x += (State.player.x - e.x) * 0.15;
                e.y += (State.player.y - e.y) * 0.15;
            }

            XRender.drawItem(ctx, e, t);

            if(Math.hypot(e.x - State.player.x, e.y - State.player.y + 20) < 80) {
                onHit(e); State.entities.splice(i, 1);
            } else if(e.y > State.h + 100) State.entities.splice(i, 1);
        });

        // Buff Timers
        for(let key in State.buffs) if(State.buffs[key] > 0) State.buffs[key] -= dt;
        updateBuffUI();

        State.time -= dt * timeScale;
        document.getElementById('ui-time').innerText = Math.ceil(State.time);
        document.getElementById('ui-score').innerText = State.score;

        if(State.time <= 0) gameOver();
        else requestAnimationFrame(loop);
    };

    const onHit = (e) => {
        State.player.squash = 0.7;
        const isX2 = State.buffs.x2 > 0 ? 2 : 1;

        if(e.type === 'bomb') {
            if(State.buffs.shield > 0) { State.buffs.shield = 0; return; }
            State.score = Math.max(0, State.score - 50);
        } else if(e.type === 'gift') State.score += 10 * isX2;
        else if(e.type === 'money_bag') State.score += 50 * isX2;
        else if(e.type === 'gold') State.score += 100 * isX2;
        else if(e.type === 'magnet') State.buffs.magnet = 7;
        else if(e.type === 'shield') State.buffs.shield = 1;
        else if(e.type === 'time') State.time += 5;
        else if(e.type === 'x2') State.buffs.x2 = 10;
        else if(e.type === 'slow') State.buffs.slow = 5;
        else if(e.type === 'fan') State.entities = State.entities.filter(ent => ent.type !== 'bomb');
    };

    const updateBuffUI = () => {
        const tray = document.getElementById('buff-tray'); tray.innerHTML = '';
        const icons = { magnet:'üß≤', shield:'üèÆ', x2:'üç±', slow:'üç∂' };
        for(let b in icons) if(State.buffs[b] > 0) tray.innerHTML += `<div class="buff-icon">${icons[b]}</div>`;
    };

    const spawner = () => {
        if(!State.running) return;
        const types = ['gift','gift','gift','money_bag','gold','magnet','shield','time','x2','slow','fan','bomb','bomb'];
        const type = types[Math.floor(Math.random()*types.length)];
        State.entities.push({ x: Math.random()*(State.w-100)+50, y:-100, vy: 3.5+Math.random()*2.5, sway: Math.random()*10, type });
        setTimeout(spawner, 500);
    };

    const gameOver = () => { State.running = false; UI.showGacha(Math.min(70, State.score / 15)); };

    return { boot, DB };
})();

/* --- ADMIN & UI --- */
const Admin = {
    open() { UI.open('admin'); document.getElementById('adm-json').value = JSON.stringify(App.DB.config(), null, 2); },
    save() { App.DB.save(JSON.parse(document.getElementById('adm-json').value)); alert("PATCHED!"); }
};

const UI = {
    open(id) { document.getElementById(`screen-${id}`).style.display = 'flex'; },
    close(id) { document.getElementById(`screen-${id}`).style.display = 'none'; },
    showGacha(luck) {
        document.getElementById('hud').style.opacity = 0; this.open('gacha');
        document.getElementById('ui-luck').innerText = `PH√öC KH√ç: +${luck.toFixed(1)}%`;
        const grid = document.getElementById('gacha-grid'); grid.innerHTML = '';
        for(let i=0; i<9; i++) {
            const el = document.createElement('div'); el.className = 'envelope-3d';
            el.innerHTML = `<div style="backface-visibility:hidden">üßß</div><div class="env-inner">?</div>`;
            el.onclick = () => {
                if(el.classList.contains('reveal')) return;
                const p = this.roll(luck); el.classList.add('reveal'); el.querySelector('.env-inner').innerText = (p/1000) + 'k';
                setTimeout(() => { this.open('result'); document.getElementById('res-prize').innerText = p.toLocaleString() + "ƒë"; }, 1400);
            };
            grid.appendChild(el);
        }
    },
    roll(luck) {
        const table = App.DB.config(); let tot = 0;
        const pool = table.map(i => {
            let w = i.w;
            if(i.v >= 50000) w *= (1 + luck/5); else w = Math.max(w*0.1, w*(1-luck/100));
            tot += w; return { v: i.v, cw: tot };
        });
        const r = Math.random() * tot; return pool.find(p => r <= p.cw).v;
    }
};

window.onload = () => console.log("ENGINE READY");
</script>
</body>
</html>
