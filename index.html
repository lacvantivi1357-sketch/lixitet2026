<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>L√¨ X√¨ 300.0 - Realistic Heritage Edition</title>
<style>
    /* =========================================
       1. CINEMATIC VISUAL TOKENS
       ========================================= */
    :root {
        --paper-red: #8e0d0d; --gold-foil: #ffcc00; --deep-bamboo: #3e2723;
        --ambient-light: #ffeb3b; --floor-brick: #5d4037;
        --font: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
    body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #120101; font-family: var(--font); color: white; }
    canvas { display: block; position: absolute; top: 0; left: 0; z-index: 1; }

    /* UI ARCHITECTURE */
    #ui-portal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
    .interactive { pointer-events: auto !important; }

    /* CINEMATIC HUD */
    #hud { display: flex; justify-content: space-between; padding: 30px; width: 100%; position: absolute; top: 0; z-index: 20; opacity: 0; transition: 1.5s ease-out; }
    .hud-card { 
        border: 2px solid rgba(255, 204, 0, 0.5); padding: 12px 35px; 
        background: radial-gradient(circle, #4a0404 0%, #1a0101 100%);
        text-align: center; border-radius: 2px; box-shadow: 0 15px 35px rgba(0,0,0,0.8);
    }
    .hud-label { font-size: 0.65rem; color: var(--gold-foil); text-transform: uppercase; letter-spacing: 3px; margin-bottom: 5px; opacity: 0.8; }
    .hud-val { font-size: 2.2rem; font-weight: 300; color: #fff; font-family: 'Georgia', serif; }

    /* MODALS */
    .overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.92); display: none; align-items: center; justify-content: center; backdrop-filter: blur(12px); z-index: 100; }
    .modal { 
        background: linear-gradient(135deg, #2d0a0a 0%, #050101 100%); 
        border: 1px solid rgba(255, 204, 0, 0.2); 
        width: 90%; max-width: 500px; padding: 50px; text-align: center;
        box-shadow: 0 0 100px rgba(0,0,0,1);
    }
    
    .btn-real { 
        background: #8e0d0d; color: var(--gold-foil); border: 1px solid var(--gold-foil); 
        padding: 20px; font-weight: bold; text-transform: uppercase; letter-spacing: 5px; 
        cursor: pointer; width: 100%; margin-top: 25px; transition: 0.4s;
    }
    .btn-real:hover { background: var(--gold-foil); color: #000; box-shadow: 0 0 30px var(--gold-foil); }

    /* OPEN CONFIG BUTTON */
    .config-btn { 
        position: fixed; bottom: 20px; right: 20px; 
        background: rgba(255, 204, 0, 0.1); color: var(--gold-foil); 
        width: 45px; height: 45px; border-radius: 50%; border: 1px solid var(--gold-foil);
        display: flex; align-items: center; justify-content: center;
        font-size: 20px; cursor: pointer; z-index: 1000; pointer-events: auto;
        transition: 0.3s;
    }
    .config-btn:hover { background: var(--gold-foil); color: #000; transform: rotate(90deg); }

    textarea.admin-box { width: 100%; height: 200px; background: #000; color: #39ff14; border: 1px solid #333; padding: 15px; font-family: 'Courier New', monospace; margin-top: 15px; }

    /* GACHA GRID */
    .gacha-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 30px 0; }
    .envelope-3d { 
        aspect-ratio: 2/3; background: var(--paper-red); border: 1px solid var(--gold-foil); 
        display: flex; align-items: center; justify-content: center; font-size: 3rem; 
        cursor: pointer; transition: 0.6s; transform-style: preserve-3d;
        box-shadow: 10px 15px 30px rgba(0,0,0,0.6);
    }
    .envelope-3d.reveal { transform: rotateY(180deg) scale(1.05); background: #fff; }
    .env-inner { position: absolute; backface-visibility: hidden; transform: rotateY(180deg); color: #8e0d0d; font-size: 1.5rem; font-weight: bold; }
</style>
</head>
<body>

    <div class="config-btn" onclick="Admin.open()">‚öôÔ∏è</div>

    <canvas id="gameCanvas"></canvas>

    <div id="ui-portal">
        <div id="hud">
            <div class="hud-card"><div class="hud-label">TIME</div><div id="ui-time" class="hud-val">60</div></div>
            <div class="hud-card"><div class="hud-label">WEALTH</div><div id="ui-score" class="hud-val">0</div></div>
        </div>

        <div id="screen-menu" class="overlay interactive" style="display: flex;">
            <div class="modal">
                <div style="font-size: 5rem; margin-bottom: 20px; opacity: 0.9;">üèÆ</div>
                <h1 style="color:var(--gold-foil); margin:0; letter-spacing: 10px; font-weight: 100; font-size: 3.5rem;">HERITAGE</h1>
                <p style="color:#555; letter-spacing: 4px; font-size: 0.7rem;">X-RENDER REALISTIC ENGINE V300.0</p>
                <button class="btn-real" onclick="App.boot()">INITIALIZE</button>
            </div>
        </div>

        <div id="screen-gacha" class="overlay interactive">
            <div class="modal">
                <h2 style="color:var(--gold-foil); font-weight: 100; letter-spacing: 5px;">THE CHOICE</h2>
                <div class="gacha-grid" id="gacha-grid"></div>
                <div id="ui-luck" style="color: var(--gold-foil); font-size:0.8rem; border-top: 1px solid #333; padding-top: 15px;">LUCK FACTOR: +0.0%</div>
            </div>
        </div>

        <div id="screen-result" class="overlay interactive">
            <div class="modal">
                <h1 style="color:var(--gold-foil); font-weight: 100;">PROSPERITY</h1>
                <div style="font-size: 6rem; margin: 30px 0;">‚ú®</div>
                <h2 id="res-prize" style="font-size: 4rem; color: #fff; margin: 0;">0ƒë</h2>
                <button class="btn-real" onclick="location.reload()">SYNC DATA</button>
            </div>
        </div>

        <div id="screen-admin" class="overlay interactive">
            <div class="modal" style="max-width: 550px; text-align: left;">
                <h2 style="color:var(--gold-foil);">KERNEL CONFIGURATION</h2>
                <textarea id="adm-json" class="admin-box"></textarea>
                <div style="display:flex; gap:15px;">
                    <button class="btn-real" onclick="Admin.save()">PATCH</button>
                    <button class="btn-real" style="border-color:#500;" onclick="UI.close('admin')">EXIT</button>
                </div>
            </div>
        </div>
    </div>

<script>
/**
 * APEX X-RENDER ENGINE v300.0
 * Specialized in Realistic 2D Physics & Dynamic Lighting
 */
const App = (() => {
    
    /* --- DATA KERNEL --- */
    const DB = {
        key: 'lx300_core',
        config: () => JSON.parse(localStorage.getItem('lx300_core')) || [
            {v:100000, w:1}, {v:50000, w:10}, {v:20000, w:50}, {v:10000, w:180}
        ],
        save: (d) => localStorage.setItem('lx300_core', JSON.stringify(d))
    };

    /* --- ENGINE STATE --- */
    const State = {
        running: false, score: 0, time: 60,
        w: 0, h: 0, lastT: 0,
        player: { x: 0, tx: 0, y: 0, w: 160, h: 110, squash: 1 },
        entities: [], blossoms: []
    };

    const cvs = document.getElementById('gameCanvas');
    const ctx = cvs.getContext('2d', { alpha: false });

    /* --- REALISTIC RENDERER --- */
    const XRender = {
        // V·∫Ω r·ªó tre 3D v·ªõi Ambient Occlusion (ƒê·ªï b√≥ng m√¥i tr∆∞·ªùng)
        basket(ctx, x, y, w, h, squash) {
            const bh = h * squash; const bw = w * (2 - squash);
            ctx.save();
            ctx.translate(x, y + (h - bh)/2);

            // 1. Cast Shadow (B√≥ng d∆∞·ªõi ƒë·∫•t)
            ctx.fillStyle = "rgba(0,0,0,0.5)";
            ctx.beginPath(); ctx.ellipse(0, bh/2 + 25, bw/2.2, 15, 0, 0, Math.PI*2); ctx.fill();

            // 2. Body Gradient (T·∫°o kh·ªëi)
            const bodyGrad = ctx.createLinearGradient(0, -bh/2, 0, bh/2);
            bodyGrad.addColorStop(0, '#5d4037'); bodyGrad.addColorStop(0.5, '#3e2723'); bodyGrad.addColorStop(1, '#1b0d0a');
            ctx.fillStyle = bodyGrad;
            ctx.beginPath(); ctx.moveTo(-bw/2, -bh/2);
            ctx.bezierCurveTo(-bw/2, bh/2, bw/2, bh/2, bw/2, -bh/2); ctx.fill();

            // 3. Realistic Weaving (Nan tre Interlocking)
            ctx.strokeStyle = "rgba(255,255,255,0.05)"; ctx.lineWidth = 1;
            for(let i = -bw/2; i < bw/2; i += 8) {
                ctx.beginPath(); ctx.moveTo(i, -bh/2); ctx.quadraticCurveTo(i*0.3, bh/2, i*0.1, bh/2); ctx.stroke();
            }
            ctx.strokeStyle = "rgba(0,0,0,0.4)";
            for(let j = -bh/2; j < bh/2; j += 10) {
                ctx.beginPath(); ctx.moveTo(-bw/2 + Math.abs(j), j); ctx.lineTo(bw/2 - Math.abs(j), j); ctx.stroke();
            }

            // 4. Rim Lighting (V√†nh r·ªó c√≥ √°nh kim)
            const rimGrad = ctx.createLinearGradient(-bw/2, 0, bw/2, 0);
            rimGrad.addColorStop(0, '#3e2723'); rimGrad.addColorStop(0.5, '#8d6e63'); rimGrad.addColorStop(1, '#3e2723');
            ctx.strokeStyle = rimGrad; ctx.lineWidth = 14;
            ctx.beginPath(); ctx.ellipse(0, -bh/2, bw/2 + 6, 14, 0, 0, Math.PI*2); ctx.stroke();
            
            // S·ª£i m√¢y bu·ªôc v√†nh (Binding details)
            ctx.strokeStyle = "rgba(0,0,0,0.3)"; ctx.lineWidth = 2;
            for(let a=0; a<Math.PI*2; a+=0.4) {
                ctx.beginPath(); ctx.arc((bw/2+6)*Math.cos(a), -bh/2 + 14*Math.sin(a), 3, 0, 1); ctx.stroke();
            }

            ctx.restore();
        },

        // V·∫Ω bao l√¨ x√¨ v·ªõi hi·ªáu ·ª©ng gi·∫•y th·ª±c
        lixi(ctx, x, y, angle, type, t) {
            ctx.save();
            ctx.translate(x, y);
            ctx.rotate(angle);
            
            // Gi·∫£ l·∫≠p l·∫≠t trang 3D (3D Flip Simulation)
            const flipS = Math.sin(t / 500);
            ctx.scale(flipS, 1);

            // Drop Shadow
            ctx.shadowColor = "rgba(0,0,0,0.6)"; ctx.shadowBlur = 20; ctx.shadowOffsetX = 10;

            // Paper Material
            const paperGrad = ctx.createLinearGradient(-25, -35, 25, 35);
            if(type === 'bomb') { paperGrad.addColorStop(0, '#333'); paperGrad.addColorStop(1, '#000'); }
            else { paperGrad.addColorStop(0, '#b71c1c'); paperGrad.addColorStop(1, '#7f0000'); }
            
            ctx.fillStyle = paperGrad;
            ctx.beginPath(); ctx.roundRect(-25, -35, 50, 70, 3); ctx.fill();

            // Gold Leaf Foil (√âp kim)
            ctx.strokeStyle = "rgba(255, 204, 0, 0.6)"; ctx.lineWidth = 1;
            ctx.strokeRect(-20, -30, 40, 60);
            
            // Realistic Highlight
            const shine = ctx.createLinearGradient(-50, -50, 50, 50);
            shine.addColorStop(0, "rgba(255,255,255,0)"); shine.addColorStop(0.5, "rgba(255,255,255,0.15)"); shine.addColorStop(1, "rgba(255,255,255,0)");
            ctx.fillStyle = shine; ctx.fillRect(-25, -35, 50, 70);

            ctx.fillStyle = "#fff"; ctx.font = "24px serif"; ctx.textAlign="center";
            ctx.fillText(type==='bomb'?"üí£":"üßß", 0, 12);
            
            ctx.restore();
        }
    };

    /* --- SYSTEM LOGIC --- */
    const boot = () => {
        resize(); window.onresize = resize;
        document.addEventListener('mousemove', e => State.player.tx = e.clientX);
        document.addEventListener('touchmove', e => { e.preventDefault(); State.player.tx = e.touches[0].clientX; }, {passive:false});
        
        State.running = true;
        document.getElementById('screen-menu').style.display = 'none';
        document.getElementById('hud').style.opacity = 1;
        
        State.lastT = performance.now();
        requestAnimationFrame(loop);
        spawner();
    };

    const resize = () => {
        State.w = cvs.width = window.innerWidth;
        State.h = cvs.height = window.innerHeight;
        State.player.y = State.h - 150;
    };

    const loop = (t) => {
        if(!State.running) return;
        const dt = (t - State.lastT) / 1000;
        State.lastT = t;

        // Environment Render (S√¢n g·∫°ch c·ªï)
        const envGrad = ctx.createRadialGradient(State.w/2, State.h/2, 0, State.w/2, State.h/2, State.w);
        envGrad.addColorStop(0, '#3e2723'); envGrad.addColorStop(1, '#1a0101');
        ctx.fillStyle = envGrad; ctx.fillRect(0, 0, State.w, State.h);

        // Brick detail (G·∫°ch nung)
        ctx.strokeStyle = "rgba(0,0,0,0.2)";
        for(let i=0; i<State.w; i+=80) { ctx.beginPath(); ctx.moveTo(i, 0); ctx.lineTo(i, State.h); ctx.stroke(); }

        // Player physics
        State.player.x += (State.player.tx - State.player.x) * 0.12;
        if(State.player.squash < 1) State.player.squash += 0.04;

        XRender.basket(ctx, State.player.x, State.player.y, State.player.w, State.player.h, State.player.squash);

        // Entities with Flutter Physics (Bay li·ªáng)
        State.entities.forEach((e, i) => {
            e.y += e.vy;
            e.sway += 0.04;
            e.x += Math.sin(e.sway) * 2.5; // Li·ªáng tr√°i ph·∫£i
            e.angle = Math.sin(e.sway) * 0.2; // Xoay g√≥c

            XRender.lixi(ctx, e.x, e.y, e.angle, e.type, t);

            if(Math.hypot(e.x - State.player.x, e.y - State.player.y + 20) < 85) {
                State.player.squash = 0.65; // High-impact squash
                if(e.type === 'bomb') State.score = Math.max(0, State.score-50); else State.score += 10;
                State.entities.splice(i, 1);
            } else if(e.y > State.h + 100) State.entities.splice(i, 1);
        });

        // Sync UI
        State.time -= dt;
        document.getElementById('ui-time').innerText = Math.ceil(State.time);
        document.getElementById('ui-score').innerText = State.score;

        if(State.time <= 0) gameOver();
        else requestAnimationFrame(loop);
    };

    const spawner = () => {
        if(!State.running) return;
        State.entities.push({ 
            x: Math.random()*(State.w-100)+50, y:-100, 
            vy: 3 + Math.random()*2.5, 
            sway: Math.random()*10,
            type: Math.random()<0.18?'bomb':'gift' 
        });
        setTimeout(spawner, 550);
    };

    const gameOver = () => {
        State.running = false;
        UI.showGacha(Math.min(65, State.score / 10));
    };

    return { boot, resize, DB };
})();

/* --- ADMIN & UI MODULES --- */
const Admin = {
    open() {
        UI.open('admin');
        document.getElementById('adm-json').value = JSON.stringify(App.DB.config(), null, 2);
    },
    save() {
        try {
            const data = JSON.parse(document.getElementById('adm-json').value);
            App.DB.save(data); alert("CORE PATCHED SUCCESSFULLY");
        } catch(e) { alert("JSON SYNTAX ERROR"); }
    }
};

const UI = {
    open(id) { document.getElementById(`screen-${id}`).style.display = 'flex'; },
    close(id) { document.getElementById(`screen-${id}`).style.display = 'none'; },
    showGacha(luck) {
        document.getElementById('hud').style.opacity = 0;
        this.open('gacha');
        document.getElementById('ui-luck').innerText = `LUCK FACTOR: +${luck.toFixed(1)}%`;
        const grid = document.getElementById('gacha-grid'); grid.innerHTML = '';
        for(let i=0; i<9; i++) {
            const el = document.createElement('div'); el.className = 'envelope-3d';
            el.innerHTML = `<div class="env-inner">?</div><div style="backface-visibility:hidden">üßß</div>`;
            el.onclick = () => {
                if(el.classList.contains('reveal')) return;
                const p = this.roll(luck);
                el.classList.add('reveal'); el.querySelector('.env-inner').innerText = (p/1000) + 'k';
                setTimeout(() => {
                    this.close('gacha'); this.open('result');
                    document.getElementById('res-prize').innerText = p.toLocaleString() + "ƒë";
                }, 1400);
            };
            grid.appendChild(el);
        }
    },
    roll(luck) {
        const table = App.DB.config();
        let tot = 0;
        const pool = table.map(i => {
            let w = i.w;
            if(i.v >= 50000) w *= (1 + luck/5); // Massive luck influence
            else w = Math.max(w*0.2, w*(1-luck/100)); // Deprioritize low values
            tot += w; return { v: i.v, cw: tot };
        });
        const r = Math.random() * tot;
        return pool.find(p => r <= p.cw).v;
    }
};

window.onload = () => App.resize();
</script>
</body>
</html>
