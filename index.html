<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>L√¨ X√¨ 550.0 - Titan Core Refined</title>
<style>
    /* ========================================================================
       1. LUXURY TET STYLES - GLASSMORPHISM 2.0
       ======================================================================== */
    :root {
        --tet-red: #b71c1c; --tet-gold: #ffd700; --tet-wood: #3e2723;
        --neon-blue: #00f2ea; --neon-pink: #ff0050;
        --font: 'Segoe UI', system-ui, -apple-system, sans-serif;
    }

    * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
    body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #050101; font-family: var(--font); color: white; }
    canvas { display: block; position: absolute; top: 0; left: 0; z-index: 1; }

    /* UI STACK ARCHITECTURE */
    #ui-portal { position: absolute; inset: 0; z-index: 10; pointer-events: none; display: flex; flex-direction: column; }
    .interactive { pointer-events: auto !important; }

    /* HUD */
    #hud { display: flex; justify-content: space-between; padding: 25px; width: 100%; opacity: 0; transition: opacity 1s; }
    .hud-card { 
        background: rgba(0,0,0,0.7); border: 2px solid var(--tet-gold); 
        padding: 10px 30px; border-radius: 8px; text-align: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.8); backdrop-filter: blur(10px);
    }
    .hud-label { font-size: 0.6rem; color: var(--tet-gold); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 5px; }
    .hud-val { font-size: 1.8rem; font-weight: 900; }

    /* NOTIFICATIONS & COMBO */
    #fx-overlay { position: absolute; top: 120px; width: 100%; text-align: center; pointer-events: none; }
    .combo-text { font-size: 3rem; font-weight: 900; color: var(--tet-gold); text-shadow: 0 0 20px var(--tet-red); animation: pop 0.3s ease-out; }
    
    /* MODALS */
    .screen { position: absolute; inset: 0; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(20px); }
    .panel { 
        background: linear-gradient(135deg, #2d0a0a, #0a0101); border: 2px solid var(--tet-gold);
        width: 90%; max-width: 500px; padding: 40px; border-radius: 15px; text-align: center;
        box-shadow: 0 0 80px rgba(255, 215, 0, 0.2);
    }

    .btn-titan { 
        background: var(--tet-gold); color: #500; border: none; padding: 20px; 
        font-weight: 900; text-transform: uppercase; letter-spacing: 3px; 
        cursor: pointer; transition: 0.3s; width: 100%; margin-top: 15px; border-radius: 50px;
        box-shadow: 0 6px 0 #b37400;
    }
    .btn-titan:hover { transform: translateY(-3px); box-shadow: 0 9px 20px rgba(255, 215, 0, 0.3); }
    .btn-titan:active { transform: translateY(4px); box-shadow: none; }

    /* GACHA GRID */
    .gacha-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 25px 0; }
    .env-3d { 
        aspect-ratio: 2/3; background: var(--tet-red); border: 2px solid var(--tet-gold);
        display: flex; align-items: center; justify-content: center; font-size: 2.5rem;
        cursor: pointer; transition: 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform-style: preserve-3d;
    }
    .env-3d.reveal { transform: rotateY(180deg) scale(1.1); background: #fff; }
    .env-inner { position: absolute; backface-visibility: hidden; transform: rotateY(180deg); color: var(--tet-red); font-weight: bold; }

    /* CONFIG */
    .cfg-btn { position: fixed; bottom: 20px; right: 20px; opacity: 0.4; cursor: pointer; font-size: 24px; z-index: 1000; pointer-events: auto; }
    textarea.cfg-box { width: 100%; height: 200px; background: #000; color: #39ff14; padding: 15px; font-family: monospace; margin-top: 15px; }

    @keyframes pop { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1.2); opacity: 1; } }
</style>
</head>
<body>

    <div class="cfg-btn" onclick="System.openAdmin()">‚öôÔ∏è</div>
    <canvas id="gameCanvas"></canvas>

    <div id="ui-portal">
        <div id="hud">
            <div class="hud-card">
                <div class="hud-label">S_TIME</div>
                <div id="ui-time" class="hud-val">60.0</div>
            </div>
            <div class="hud-card" style="border-color: var(--neon-blue);">
                <div class="hud-label">C_WEALTH</div>
                <div id="ui-score" class="hud-val">0</div>
            </div>
        </div>

        <div id="fx-overlay"></div>

        <div id="screen-menu" class="screen interactive" style="display: flex;">
            <div class="panel">
                <div style="font-size: 5rem; margin-bottom: 20px;">üéã</div>
                <h1 style="color:var(--tet-gold); letter-spacing: 10px; font-size: 2.5rem; margin: 0;">TITAN_LIXI</h1>
                <p style="color:#888; letter-spacing: 3px; font-size: 0.8rem; margin-top: 10px;">X-ENGINE V550.0 ‚Ä¢ FIXED & STABLE</p>
                <button class="btn-titan" onclick="Kernel.boot()">[ B·∫ÆT ƒê·∫¶U ]</button>
            </div>
        </div>

        <div id="screen-gacha" class="screen interactive">
            <div class="panel">
                <h2 style="color:var(--tet-gold); letter-spacing: 5px;">H√ÅI L·ªòC ƒê·∫¶U XU√ÇN</h2>
                <div class="gacha-grid" id="gacha-grid"></div>
                <p id="ui-luck" style="color: var(--tet-gold); font-weight: bold;"></p>
            </div>
        </div>

        <div id="screen-result" class="screen interactive">
            <div class="panel">
                <h1 style="color:var(--tet-gold)">X√ÅC NH·∫¨N L·ªòC</h1>
                <div style="font-size: 6rem; margin: 20px 0;">üéä</div>
                <div id="res-prize" style="font-size: 3.5rem; font-weight: bold; color: #fff;">0ƒë</div>
                <button class="btn-titan" onclick="location.reload()">TI·∫æP T·ª§C</button>
            </div>
        </div>

        <div id="screen-admin" class="screen interactive">
            <div class="panel" style="text-align: left;">
                <h3 style="color:var(--tet-gold)">KERNEL CONFIG</h3>
                <textarea id="adm-json" class="cfg-box"></textarea>
                <button class="btn-titan" onclick="System.saveConfig()">SAVE PATCH</button>
                <button class="btn-titan" style="background:#444; color:#fff" onclick="UI.hide('admin')">EXIT</button>
            </div>
        </div>
    </div>

<script>
/**
 * ============================================================================
 * TITAN CORE v550.0 - THE REFINED ENGINE
 * Fixed: Vec2 methods, Pool management, Audio gesture
 * ============================================================================
 */

/* --- MODULE 1: VECTOR & MATH --- */
class Vec2 {
    constructor(x=0, y=0) { this.x = x; this.y = y; }
    set(x, y) { this.x = x; this.y = y; return this; } // FIX: Added missing set method
    add(v) { this.x += v.x; this.y += v.y; return this; }
    mult(s) { this.x *= s; this.y *= s; return this; }
    static dist(v1, v2) { return Math.hypot(v1.x - v2.x, v1.y - v2.y); }
}

/* --- MODULE 2: REFINED OBJECT POOL --- */
class ObjectPool {
    constructor(factory, size) {
        this.store = Array.from({ length: size }, factory);
        this.freeIdx = [...Array(size).keys()];
    }
    acquire() {
        if (this.freeIdx.length === 0) return null;
        const idx = this.freeIdx.pop();
        const item = this.store[idx];
        item._poolIdx = idx; item.active = true;
        return item;
    }
    release(item) {
        item.active = false;
        this.freeIdx.push(item._poolIdx);
    }
}

/* --- MODULE 3: RENDER ENGINE --- */
const Renderer = {
    // R·ªó Tre Procedural (ƒêan Tre Th·∫≠t)
    drawBasket(ctx, x, y, w, h, s) {
        const bh = h * s; const bw = w * (2 - s);
        ctx.save();
        ctx.translate(x, y + (h - bh)/2);
        
        // Shadow
        ctx.fillStyle = "rgba(0,0,0,0.4)";
        ctx.beginPath(); ctx.ellipse(0, bh/2 + 20, bw/2, 10, 0, 0, Math.PI*2); ctx.fill();

        // Body Gradient
        const grad = ctx.createLinearGradient(0, -bh/2, 0, bh/2);
        grad.addColorStop(0, '#8d6e63'); grad.addColorStop(1, '#3e2723');
        ctx.fillStyle = grad;
        ctx.beginPath();
        ctx.moveTo(-bw/2, -bh/2);
        ctx.bezierCurveTo(-bw/2, bh/2, bw/2, bh/2, bw/2, -bh/2);
        ctx.fill();

        // Nan tre ƒëan
        ctx.strokeStyle = "rgba(0,0,0,0.2)"; ctx.lineWidth = 1;
        for(let i = -bw/2 + 5; i < bw/2; i += 12) {
            ctx.beginPath(); ctx.moveTo(i, -bh/2); ctx.quadraticCurveTo(i*0.5, bh/2, i*0.2, bh/2); ctx.stroke();
        }
        
        // V√†nh r·ªó
        ctx.strokeStyle = "#5d4037"; ctx.lineWidth = 12;
        ctx.beginPath(); ctx.ellipse(0, -bh/2, bw/2 + 5, 12, 0, 0, Math.PI*2); ctx.stroke();
        ctx.restore();
    },

    // 10 Artifacts Renderer
    drawItem(ctx, e, t) {
        ctx.save();
        ctx.translate(e.pos.x, e.pos.y);
        ctx.rotate(e.angle);
        ctx.shadowBlur = 15;
        
        const type = e.type;
        if(type === 'lixi') { // L√¨ x√¨
            ctx.fillStyle = '#b71c1c'; ctx.shadowColor = '#f00';
            ctx.beginPath(); ctx.roundRect(-25, -35, 50, 70, 5); ctx.fill();
            ctx.strokeStyle = '#ffd700'; ctx.lineWidth = 2; ctx.strokeRect(-20, -30, 40, 60);
        } else if(type === 'bomb') { // Ph√°o
            ctx.fillStyle = '#111'; ctx.shadowColor = '#f00';
            ctx.beginPath(); ctx.arc(0, 0, 22, 0, Math.PI*2); ctx.fill();
            ctx.strokeStyle = '#f00'; ctx.lineWidth = 3; ctx.stroke();
        } else if(type === 'gold') { // V√†ng
            ctx.fillStyle = '#ffcc00'; ctx.shadowColor = '#ffcc00';
            ctx.beginPath(); ctx.moveTo(-25, 0); ctx.quadraticCurveTo(0, 20, 25, 0); ctx.lineTo(20, -10); ctx.quadraticCurveTo(0, 0, -20, -10); ctx.closePath(); ctx.fill();
        } else if(type === 'star') { // Sao
            ctx.fillStyle = '#ffd700'; ctx.shadowColor = '#ffd700';
            ctx.beginPath(); for(let i=0; i<5; i++) ctx.lineTo(Math.cos(i*Math.PI*0.8)*25, Math.sin(i*Math.PI*0.8)*25); ctx.closePath(); ctx.fill();
        } else { // C√°c lo·∫°i b√πa kh√°c
            ctx.fillStyle = '#fff'; ctx.shadowColor = '#0ff';
            ctx.beginPath(); ctx.arc(0, 0, 20, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = '#000'; ctx.font = "bold 15px Arial"; ctx.textAlign="center";
            ctx.fillText(type.toUpperCase()[0], 0, 5);
        }
        ctx.restore();
    }
};

/* --- MODULE 4: ENGINE KERNEL --- */
const Kernel = {
    cvs: document.getElementById('gameCanvas'),
    ctx: document.getElementById('gameCanvas').getContext('2d'),
    state: { running: false, score: 0, time: 60, combo: 0, lastT: 0, w: 0, h: 0, shake: 0 },
    player: { pos: new Vec2(), tx: 0, squash: 1 },
    buffs: { magnet: 0, x2: 0, slow: 0 },
    
    // Memory Pools
    entities: new ObjectPool(() => ({ pos: new Vec2(), vy: 0, angle: 0, sway: 0, type: '', active: false }), 60),
    particles: new ObjectPool(() => ({ pos: new Vec2(), vel: new Vec2(), life: 0, c: '', active: false }), 400),

    boot() {
        this.resize();
        window.onresize = () => this.resize();
        document.addEventListener('mousemove', e => this.player.tx = e.clientX);
        document.addEventListener('touchmove', e => { e.preventDefault(); this.player.tx = e.touches[0].clientX; }, {passive:false});
        
        this.state.running = true;
        this.state.score = 0; this.state.time = 60;
        UI.screen('menu', false); UI.screen('hud', true);
        
        this.state.lastT = performance.now();
        requestAnimationFrame(t => this.loop(t));
        this.spawner();
    },

    resize() {
        this.state.w = this.cvs.width = window.innerWidth;
        this.state.h = this.cvs.height = window.innerHeight;
        this.player.pos.set(this.state.w/2, this.state.h - 150);
        this.player.tx = this.state.w/2;
    },

    loop(t) {
        if(!this.state.running) return;
        const dt = (t - this.state.lastT) / 1000;
        this.state.lastT = t;

        const ts = this.buffs.slow > 0 ? 0.4 : 1.0;

        // Render Background
        this.ctx.fillStyle = "#120101"; this.ctx.fillRect(0, 0, this.state.w, this.state.h);

        // Player movement
        this.player.pos.x += (this.player.tx - this.player.pos.x) * 0.15;
        if(this.player.squash < 1) this.player.squash += 0.05;
        if(this.state.shake > 0) this.state.shake *= 0.9;

        // Draw Player with Shake
        this.ctx.save();
        if(this.state.shake > 0.5) this.ctx.translate(Math.random()*this.state.shake, Math.random()*this.state.shake);
        Renderer.drawBasket(this.ctx, this.player.pos.x, this.player.pos.y, 160, 110, this.player.squash);
        this.ctx.restore();

        // Process Entities
        this.entities.store.forEach(e => {
            if(!e.active) return;
            e.pos.y += e.vy * ts * (1 + (60 - this.state.time)/150);
            e.sway += 0.04; e.pos.x += Math.sin(e.sway) * 2;
            e.angle += 0.02;

            if(this.buffs.magnet > 0 && e.type !== 'bomb') {
                e.pos.x += (this.player.pos.x - e.pos.x) * 0.15;
                e.pos.y += (this.player.pos.y - e.pos.y) * 0.15;
            }

            Renderer.drawItem(this.ctx, e, t);

            if(Vec2.dist(e.pos, this.player.pos) < 80) {
                this.hit(e); this.entities.release(e);
            } else if(e.pos.y > this.state.h + 100) {
                if(e.type !== 'bomb') this.state.combo = 0;
                this.entities.release(e);
            }
        });

        // Process Particles
        this.particles.store.forEach(p => {
            if(!p.active) return;
            p.pos.add(p.vel); p.vel.y += 0.15; p.life -= dt * 2;
            if(p.life <= 0) this.particles.release(p);
            else {
                this.ctx.fillStyle = p.c; this.ctx.globalAlpha = p.life;
                this.ctx.fillRect(p.pos.x, p.pos.y, 4, 4);
            }
        });
        this.ctx.globalAlpha = 1;

        // Buff Timers
        for(let b in this.buffs) if(this.buffs[b] > 0) this.buffs[b] -= dt;
        
        this.state.time -= dt * ts;
        document.getElementById('ui-time').innerText = Math.max(0, this.state.time).toFixed(1);
        document.getElementById('ui-score').innerText = this.state.score;

        if(this.state.time <= 0) this.gameOver();
        else requestAnimationFrame(t => this.loop(t));
    },

    hit(e) {
        this.player.squash = 0.7;
        if(e.type === 'bomb') {
            this.state.score = Math.max(0, this.state.score - 50);
            this.state.shake = 20; this.state.combo = 0;
            this.burst(e.pos.x, e.pos.y, '#f00');
        } else {
            this.state.combo++;
            let pts = e.type === 'gold' ? 50 : 10;
            if(this.buffs.x2 > 0) pts *= 2;
            this.state.score += pts;
            
            if(e.type === 'star') { this.buffs.x2 = 10; UI.showCombo("X2 SCORE!"); }
            if(this.state.combo % 10 === 0) UI.showCombo(this.state.combo + " COMBO!");
            
            this.burst(e.pos.x, e.pos.y, '#ffd700');
        }
    },

    burst(x, y, c) {
        for(let i=0; i<15; i++) {
            const p = this.particles.acquire();
            if(p) { p.pos.set(x, y); p.vel.set((Math.random()-0.5)*15, (Math.random()-0.5)*15); p.life = 1; p.c = c; }
        }
    },

    spawner() {
        if(!this.state.running) return;
        const e = this.entities.acquire();
        if(e) {
            const types = ['lixi','lixi','lixi','gold','gold','star','bomb','bomb'];
            e.pos.set(MathK.rand(100, this.state.w-100), -100);
            e.vy = MathK.rand(4, 7); e.sway = MathK.rand(0, 10);
            e.type = types[MathK.randInt(0, types.length-1)];
        }
        setTimeout(() => this.spawner(), 500);
    },

    gameOver() {
        this.state.running = false;
        UI.showGacha(MathK.clamp(this.state.score/15, 0, 75));
    }
};

/* --- MODULE 5: SYSTEM & GACHA --- */
const System = {
    cfgKey: 'lx550_cfg',
    default: [{v:100000,w:1}, {v:50000,w:10}, {v:20000,w:50}, {v:10000,w:150}],
    load() { return JSON.parse(localStorage.getItem(this.cfgKey)) || this.default; },
    openAdmin() {
        UI.open('admin');
        document.getElementById('adm-json').value = JSON.stringify(this.load(), null, 2);
    },
    saveConfig() {
        try {
            const data = JSON.parse(document.getElementById('adm-json').value);
            localStorage.setItem(this.cfgKey, JSON.stringify(data));
            alert("PATCH SUCCESSFUL");
        } catch(e) { alert("JSON ERROR"); }
    }
};

const UI = {
    open(id) { document.getElementById(`screen-${id}`).style.display = 'flex'; },
    hide(id) { document.getElementById(`screen-${id}`).style.display = 'none'; },
    screen(id, s) { 
        const el = id === 'hud' ? document.getElementById(id) : document.getElementById(`screen-${id}`);
        el.style.display = s ? 'flex' : 'none';
        el.style.opacity = s ? 1 : 0;
    },
    showCombo(msg) {
        const div = document.getElementById('fx-overlay');
        div.innerHTML = `<div class="combo-text">${msg}</div>`;
        setTimeout(() => div.innerHTML = '', 1000);
    },
    showGacha(luck) {
        this.screen('hud', false); this.open('gacha');
        document.getElementById('ui-luck').innerText = `LUCK_MODIFIER: +${luck.toFixed(1)}%`;
        const grid = document.getElementById('gacha-grid'); grid.innerHTML = '';
        for(let i=0; i<9; i++) {
            const el = document.createElement('div'); el.className = 'env-3d';
            el.innerHTML = `<div style="backface-visibility:hidden">üßß</div><div class="env-inner">?</div>`;
            el.onclick = () => {
                if(el.classList.contains('reveal')) return;
                const p = this.roll(luck); el.classList.add('reveal'); el.querySelector('.env-inner').innerText = (p/1000) + 'k';
                setTimeout(() => { this.open('result'); document.getElementById('res-prize').innerText = p.toLocaleString() + "ƒë"; }, 1500);
            };
            grid.appendChild(el);
        }
    },
    roll(luck) {
        const table = System.load(); let tot = 0;
        const pool = table.map(i => {
            let w = i.w;
            if(i.v >= 50000) w *= (1 + luck/5); else w = Math.max(w*0.1, w*(1-luck/100));
            tot += w; return { v: i.v, cw: tot };
        });
        const r = Math.random() * tot; return pool.find(p => r <= p.cw).v;
    }
};

const MathK = {
    rand: (min, max) => Math.random() * (max - min) + min,
    randInt: (min, max) => Math.floor(Math.random() * (max - min + 1)) + min,
    clamp: (v, min, max) => Math.max(min, Math.min(v, max))
};

window.onload = () => Kernel.resize();
</script>
</body>
</html>
